--
-- Tests for some likely failure cases with combo cmin/cmax mechanism
--
CREATE TEMP TABLE combocidtest (foobar int)


BEGIN


-- a few dummy ops to push up the CommandId counter
INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0


INSERT INTO combocidtest VALUES (1)

INSERT INTO combocidtest VALUES (2)


SELECT ctid,cmin,* FROM combocidtest
ERROR: 

SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


SAVEPOINT s1
ERROR: 

SAVEPOINT s1

Parser Error: syntax error at or near "SAVEPOINT"


UPDATE combocidtest SET foobar = foobar + 10


-- here we should see only updated tuples
SELECT ctid,cmin,* FROM combocidtest
ERROR: 

-- here we should see only updated tuples
SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


ROLLBACK TO s1
ERROR: 

ROLLBACK TO s1

Parser Error: syntax error at or near "TO"


-- now we should see old tuples, but with combo CIDs starting at 0
SELECT ctid,cmin,* FROM combocidtest
ERROR: 

-- now we should see old tuples, but with combo CIDs starting at 0
SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


COMMIT


-- combo data is not there anymore, but should still see tuples
SELECT ctid,cmin,* FROM combocidtest
ERROR: 

-- combo data is not there anymore, but should still see tuples
SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


-- Test combo CIDs with portals
BEGIN


INSERT INTO combocidtest VALUES (333)


DECLARE c CURSOR FOR SELECT ctid,cmin,* FROM combocidtest
ERROR: 

DECLARE c CURSOR FOR SELECT ctid,cmin,* FROM combocidtest

Parser Error: syntax error at or near "DECLARE"


DELETE FROM combocidtest


FETCH ALL FROM c
ERROR: 

FETCH ALL FROM c

Parser Error: syntax error at or near "FETCH"


ROLLBACK


SELECT ctid,cmin,* FROM combocidtest
ERROR: 

SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


-- check behavior with locked tuples
BEGIN


-- a few dummy ops to push up the CommandId counter
INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0

INSERT INTO combocidtest SELECT 1 LIMIT 0


INSERT INTO combocidtest VALUES (444)


SELECT ctid,cmin,* FROM combocidtest
ERROR: 

SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


SAVEPOINT s1
ERROR: 

SAVEPOINT s1

Parser Error: syntax error at or near "SAVEPOINT"


-- this doesn''t affect cmin
SELECT ctid,cmin,* FROM combocidtest FOR UPDATE
ERROR: 

-- this doesn''t affect cmin
SELECT ctid,cmin,* FROM combocidtest FOR UPDATE

Parser Error: SELECT locking clause is not supported!

SELECT ctid,cmin,* FROM combocidtest
ERROR: 
SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


-- but this does
UPDATE combocidtest SET foobar = foobar + 10


SELECT ctid,cmin,* FROM combocidtest
ERROR: 

SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


ROLLBACK TO s1
ERROR: 

ROLLBACK TO s1

Parser Error: syntax error at or near "TO"


SELECT ctid,cmin,* FROM combocidtest
ERROR: 

SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


COMMIT


SELECT ctid,cmin,* FROM combocidtest
ERROR: 

SELECT ctid,cmin,* FROM combocidtest

Binder Error: Referenced column "ctid" not found in FROM clause!
Candidate bindings: "combocidtest.foobar"


-- test for bug reported in
-- CABRT9RC81YUf1=jsmWopcKJEro=VoeG2ou6sPwyOUTx_qteRsg@mail.gmail.com
CREATE TABLE IF NOT EXISTS testcase(
	id int PRIMARY KEY,
	balance numeric
)

INSERT INTO testcase VALUES (1, 0)

BEGIN

SELECT * FROM testcase WHERE testcase.id = 1 FOR UPDATE
ERROR: 
SELECT * FROM testcase WHERE testcase.id = 1 FOR UPDATE

Parser Error: SELECT locking clause is not supported!

UPDATE testcase SET balance = balance + 400 WHERE id=1

SAVEPOINT subxact
ERROR: 
SAVEPOINT subxact

Parser Error: syntax error at or near "SAVEPOINT"

UPDATE testcase SET balance = balance - 100 WHERE id=1

ROLLBACK TO SAVEPOINT subxact
ERROR: 
ROLLBACK TO SAVEPOINT subxact

Parser Error: syntax error at or near "TO"

-- should return one tuple
SELECT * FROM testcase WHERE id = 1 FOR UPDATE
ERROR: 
-- should return one tuple
SELECT * FROM testcase WHERE id = 1 FOR UPDATE

Parser Error: SELECT locking clause is not supported!

ROLLBACK

DROP TABLE testcase


