
-----------
QUERY:
--
-- Tests for external toast datums
--

-- directory paths and dlsuffix are passed to us in environment variables
-- \getenv libdir PG_LIBDIR
-- \getenv dlsuffix PG_DLSUFFIX

-- \set regresslib /* REPLACED */ PG_LIBDIR '/regress' /* REPLACED */ PG_DLSUFFIX

CREATE FUNCTION make_tuple_indirect (record)
        RETURNS record
        AS /* REPLACED */ PG_LIBDIR '/regress' PG_DLSUFFIX
        LANGUAGE C STRICT;
RESULT:
	ERROR - Parser Error: syntax error at or near "RETURNS"

-----------
QUERY:


-- Other compression algorithms may cause the compressed data to be stored
-- inline.  pglz guarantees that the data is externalized, so stick to it.
SET default_toast_compression = 'pglz';
RESULT:
	ERROR - Catalog Error: unrecognized configuration parameter "default_toast_compression"

Did you mean: "force_compression"

-----------
QUERY:


CREATE TABLE indtoasttest(descr text, cnt int DEFAULT 0, f1 text, f2 text);
RESULT:
	[]

-----------
QUERY:


INSERT INTO indtoasttest(descr, f1, f2) VALUES('two-compressed', repeat('1234567890',1000), repeat('1234567890',1000));
RESULT:
	[]

-----------
QUERY:

INSERT INTO indtoasttest(descr, f1, f2) VALUES('two-toasted', repeat('1234567890',30000), repeat('1234567890',50000));
RESULT:
	[]

-----------
QUERY:

INSERT INTO indtoasttest(descr, f1, f2) VALUES('one-compressed,one-null', NULL, repeat('1234567890',1000));
RESULT:
	[]

-----------
QUERY:

INSERT INTO indtoasttest(descr, f1, f2) VALUES('one-toasted,one-null', NULL, repeat('1234567890',50000));
RESULT:
	[]

-----------
QUERY:


-- check whether indirect tuples works on the most basic level
SELECT descr, substring(make_tuple_indirect(indtoasttest)::text, 1, 200) FROM indtoasttest;
RESULT:
	ERROR - Catalog Error: Scalar Function with name make_tuple_indirect does not exist!
Did you mean "make_time"?

-----------
QUERY:


-- modification without changing varlenas
UPDATE indtoasttest SET cnt = cnt +1 RETURNING substring(indtoasttest::text, 1, 200);
RESULT:
	[("{'descr': two-compressed, 'cnt': 1, 'f1': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678",), ("{'descr': two-toasted, 'cnt': 1, 'f1': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901",), ("{'descr': one-compressed,one-null, 'cnt': 1, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 1, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


-- modification without modifying assigned value
UPDATE indtoasttest SET cnt = cnt +1, f1 = f1 RETURNING substring(indtoasttest::text, 1, 200);
RESULT:
	[("{'descr': two-compressed, 'cnt': 2, 'f1': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678",), ("{'descr': two-toasted, 'cnt': 2, 'f1': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901",), ("{'descr': one-compressed,one-null, 'cnt': 2, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 2, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


-- modification modifying, but effectively not changing
UPDATE indtoasttest SET cnt = cnt +1, f1 = f1||'' RETURNING substring(indtoasttest::text, 1, 200);
RESULT:
	[("{'descr': two-compressed, 'cnt': 3, 'f1': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678",), ("{'descr': two-toasted, 'cnt': 3, 'f1': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901",), ("{'descr': one-compressed,one-null, 'cnt': 3, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 3, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


UPDATE indtoasttest SET cnt = cnt +1, f1 = '-'||f1||'-' RETURNING substring(indtoasttest::text, 1, 200);
RESULT:
	[("{'descr': two-compressed, 'cnt': 4, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': two-toasted, 'cnt': 4, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",), ("{'descr': one-compressed,one-null, 'cnt': 4, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 4, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


SELECT substring(indtoasttest::text, 1, 200) FROM indtoasttest;
RESULT:
	[("{'descr': two-compressed, 'cnt': 4, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': two-toasted, 'cnt': 4, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",), ("{'descr': one-compressed,one-null, 'cnt': 4, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 4, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:

-- check we didn/* REPLACED */ ''t screw with main/toast tuple visibility
VACUUM FREEZE indtoasttest;
RESULT:
	ERROR - Not implemented Error: Freeze vacuum option

-----------
QUERY:

SELECT substring(indtoasttest::text, 1, 200) FROM indtoasttest;
RESULT:
	[("{'descr': two-compressed, 'cnt': 4, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': two-toasted, 'cnt': 4, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",), ("{'descr': one-compressed,one-null, 'cnt': 4, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 4, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


-- now create a trigger that forces all Datums to be indirect ones
CREATE FUNCTION update_using_indirect()
        RETURNS trigger
        LANGUAGE plpgsql AS $$
BEGIN
    NEW := make_tuple_indirect(NEW);
    RETURN NEW;
END$$;
RESULT:
	ERROR - Parser Error: syntax error at or near "RETURNS"

-----------
QUERY:


CREATE TRIGGER indtoasttest_update_indirect
        BEFORE INSERT OR UPDATE
        ON indtoasttest
        FOR EACH ROW
        EXECUTE PROCEDURE update_using_indirect();
RESULT:
	ERROR - Parser Error: syntax error at or near "TRIGGER"

-----------
QUERY:


-- modification without changing varlenas
UPDATE indtoasttest SET cnt = cnt +1 RETURNING substring(indtoasttest::text, 1, 200);
RESULT:
	[("{'descr': two-compressed, 'cnt': 5, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': two-toasted, 'cnt': 5, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",), ("{'descr': one-compressed,one-null, 'cnt': 5, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 5, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


-- modification without modifying assigned value
UPDATE indtoasttest SET cnt = cnt +1, f1 = f1 RETURNING substring(indtoasttest::text, 1, 200);
RESULT:
	[("{'descr': two-compressed, 'cnt': 6, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': two-toasted, 'cnt': 6, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",), ("{'descr': one-compressed,one-null, 'cnt': 6, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 6, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


-- modification modifying, but effectively not changing
UPDATE indtoasttest SET cnt = cnt +1, f1 = f1||'' RETURNING substring(indtoasttest::text, 1, 200);
RESULT:
	[("{'descr': two-compressed, 'cnt': 7, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': two-toasted, 'cnt': 7, 'f1': -1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",), ("{'descr': one-compressed,one-null, 'cnt': 7, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 7, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


UPDATE indtoasttest SET cnt = cnt +1, f1 = '-'||f1||'-' RETURNING substring(indtoasttest::text, 1, 200);
RESULT:
	[("{'descr': two-compressed, 'cnt': 8, 'f1': --123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456",), ("{'descr': two-toasted, 'cnt': 8, 'f1': --123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789",), ("{'descr': one-compressed,one-null, 'cnt': 8, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 8, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",)]

-----------
QUERY:


INSERT INTO indtoasttest(descr, f1, f2) VALUES('one-toasted,one-null, via indirect', repeat('1234567890',30000), NULL);
RESULT:
	[]

-----------
QUERY:


SELECT substring(indtoasttest::text, 1, 200) FROM indtoasttest;
RESULT:
	[("{'descr': two-compressed, 'cnt': 8, 'f1': --123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456",), ("{'descr': two-toasted, 'cnt': 8, 'f1': --123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789",), ("{'descr': one-compressed,one-null, 'cnt': 8, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 8, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",), ("{'descr': one-toasted,one-null, via indirect, 'cnt': 0, 'f1': 123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678",)]

-----------
QUERY:

-- check we didn/* REPLACED */ ''t screw with main/toast tuple visibility
VACUUM FREEZE indtoasttest;
RESULT:
	ERROR - Not implemented Error: Freeze vacuum option

-----------
QUERY:

SELECT substring(indtoasttest::text, 1, 200) FROM indtoasttest;
RESULT:
	[("{'descr': two-compressed, 'cnt': 8, 'f1': --123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456",), ("{'descr': two-toasted, 'cnt': 8, 'f1': --123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789",), ("{'descr': one-compressed,one-null, 'cnt': 8, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567",), ("{'descr': one-toasted,one-null, 'cnt': 8, 'f1': NULL, 'f2': 12345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890",), ("{'descr': one-toasted,one-null, via indirect, 'cnt': 0, 'f1': 123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678",)]

-----------
QUERY:


DROP TABLE indtoasttest;
RESULT:
	[]

-----------
QUERY:

DROP FUNCTION update_using_indirect();
RESULT:
	ERROR - Parser Error: syntax error at or near "("

-----------
QUERY:


RESET default_toast_compression;
RESULT:
	ERROR - Catalog Error: unrecognized configuration parameter "default_toast_compression"

Did you mean: "force_compression"
