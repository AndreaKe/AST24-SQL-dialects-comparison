
-----------
QUERY:
--
-- MERGE
--

CREATE USER regress_merge_privs;
RESULT:
	[]

-----------
QUERY:

CREATE USER regress_merge_no_privs;
RESULT:
	[]

-----------
QUERY:

CREATE USER regress_merge_none;
RESULT:
	[]

-----------
QUERY:


DROP TABLE IF EXISTS target;
RESULT:
	[]

-----------
QUERY:

DROP TABLE IF EXISTS source;
RESULT:
	[]

-----------
QUERY:

CREATE TABLE target (tid integer, balance integer)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

CREATE TABLE source (sid integer, delta integer) -- no index
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

INSERT INTO target VALUES (1, 10);
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

INSERT INTO target VALUES (2, 20);
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

INSERT INTO target VALUES (3, 30);
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

SELECT t.ctid is not null as matched, t.*, s.* FROM source s FULL OUTER JOIN target t ON s.sid = t.tid ORDER BY t.tid, s.sid;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'FULL OUTER JOIN target t ON s.sid = t.tid ORDER BY t.tid, s.sid' at line 1")

-----------
QUERY:


ALTER TABLE target OWNER TO regress_merge_privs;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OWNER TO regress_merge_privs' at line 1")

-----------
QUERY:

ALTER TABLE source OWNER TO regress_merge_privs;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OWNER TO regress_merge_privs' at line 1")

-----------
QUERY:


CREATE TABLE target2 (tid integer, balance integer)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

CREATE TABLE source2 (sid integer, delta integer)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:


ALTER TABLE target2 OWNER TO regress_merge_no_privs;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OWNER TO regress_merge_no_privs' at line 1")

-----------
QUERY:

ALTER TABLE source2 OWNER TO regress_merge_no_privs;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OWNER TO regress_merge_no_privs' at line 1")

-----------
QUERY:


GRANT INSERT ON target TO regress_merge_no_privs;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:


SET SESSION AUTHORIZATION regress_merge_privs;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'regress_merge_privs' at line 1")

-----------
QUERY:


EXPLAIN (COSTS OFF)
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'COSTS OFF)\nMERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED T' at line 1")

-----------
QUERY:


--
-- Errors
--
MERGE INTO target t RANDOMWORD
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t RANDOMWORD\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED T' at line 4")

-----------
QUERY:

-- MATCHED/INSERT error
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	INSERT DEFAULT VALUES;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tINSERT' at line 2")

-----------
QUERY:

-- incorrectly specifying INTO target
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT INTO target DEFAULT VALUES;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 2")

-----------
QUERY:

-- Multiple VALUES clause
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT VALUES (1,1), (2,2);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 2")

-----------
QUERY:

-- SELECT query for INSERT
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT SELECT (1, 1);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 2")

-----------
QUERY:

-- NOT MATCHED/UPDATE
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tUP' at line 2")

-----------
QUERY:

-- UPDATE tablename
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE target SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tUPDATE' at line 2")

-----------
QUERY:

-- source and target names the same
MERGE INTO target
USING target
ON tid = tid
WHEN MATCHED THEN DO NOTHING;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target\nUSING target\nON tid = tid\nWHEN MATCHED THEN DO NOTHING' at line 2")

-----------
QUERY:

-- used in a CTE without RETURNING
WITH foo AS (
  MERGE INTO target USING source ON (true)
  WHEN MATCHED THEN DELETE
) SELECT * FROM foo;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target USING source ON (true)\n  WHEN MATCHED THEN DELETE\n) SELECT * F' at line 3")

-----------
QUERY:

-- used in COPY without RETURNING
COPY (
  MERGE INTO target USING source ON (true)
  WHEN MATCHED THEN DELETE
) TO stdout;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'COPY (\n  MERGE INTO target USING source ON (true)\n  WHEN MATCHED THEN DELETE\n) T' at line 2")

-----------
QUERY:


-- unsupported relation types
-- materialized view
CREATE MATERIALIZED VIEW mv AS SELECT * FROM target;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MATERIALIZED VIEW mv AS SELECT * FROM target' at line 3")

-----------
QUERY:

MERGE INTO mv t
USING source s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT DEFAULT VALUES;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO mv t\nUSING source s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tINSERT DE' at line 1")

-----------
QUERY:

DROP MATERIALIZED VIEW mv;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MATERIALIZED VIEW mv' at line 1")

-----------
QUERY:


-- permissions

SET SESSION AUTHORIZATION regress_merge_none;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'regress_merge_none' at line 3")

-----------
QUERY:

MERGE INTO target
USING (SELECT 1)
ON true
WHEN MATCHED THEN
	DO NOTHING;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target\nUSING (SELECT 1)\nON true\nWHEN MATCHED THEN\n\tDO NOTHING' at line 1")

-----------
QUERY:


SET SESSION AUTHORIZATION regress_merge_privs;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'regress_merge_privs' at line 1")

-----------
QUERY:

MERGE INTO target
USING source2
ON target.tid = source2.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target\nUSING source2\nON target.tid = source2.sid\nWHEN MATCHED THEN\n\tU' at line 1")

-----------
QUERY:


GRANT INSERT ON target TO regress_merge_no_privs;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

SET SESSION AUTHORIZATION regress_merge_no_privs;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'regress_merge_no_privs' at line 1")

-----------
QUERY:


MERGE INTO target
USING source2
ON target.tid = source2.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target\nUSING source2\nON target.tid = source2.sid\nWHEN MATCHED THEN\n\tU' at line 1")

-----------
QUERY:


GRANT UPDATE ON target2 TO regress_merge_privs;
RESULT:
	ERROR - (1146, "Table 'test.target2' doesn't exist")

-----------
QUERY:

SET SESSION AUTHORIZATION regress_merge_privs;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'regress_merge_privs' at line 1")

-----------
QUERY:


MERGE INTO target2
USING source
ON target2.tid = source.sid
WHEN MATCHED THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target2\nUSING source\nON target2.tid = source.sid\nWHEN MATCHED THEN\n\tD' at line 1")

-----------
QUERY:


MERGE INTO target2
USING source
ON target2.tid = source.sid
WHEN NOT MATCHED THEN
	INSERT DEFAULT VALUES;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target2\nUSING source\nON target2.tid = source.sid\nWHEN NOT MATCHED THE' at line 1")

-----------
QUERY:


-- check if the target can be accessed from source relation subquery /* REPLACED */, we should
-- not be able to do so
MERGE INTO target t
USING (SELECT * FROM source WHERE t.tid > sid) s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT DEFAULT VALUES;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING (SELECT * FROM source WHERE t.tid > sid) s\nON t.tid = ' at line 3")

-----------
QUERY:


--
-- initial tests
--
-- zero rows in source has no effect
MERGE INTO target
USING source
ON target.tid = source.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target\nUSING source\nON target.tid = source.sid\nWHEN MATCHED THEN\n\tUPD' at line 5")

-----------
QUERY:


MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tUPDATE' at line 1")

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tDELETE' at line 1")

-----------
QUERY:

BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT DEFAULT VALUES;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- insert some non-matching source rows to work from
INSERT INTO source VALUES (4, 40);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM source ORDER BY sid;
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:


MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	DO NOTHING;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tDO' at line 1")

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tUPDATE' at line 1")

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tDELETE' at line 1")

-----------
QUERY:

BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT DEFAULT VALUES;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- index plans
INSERT INTO target SELECT generate_series(1000,2500), 0;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ALTER TABLE target ADD PRIMARY KEY (tid);
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ANALYZE target;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'target' at line 1")

-----------
QUERY:


EXPLAIN (COSTS OFF)
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'COSTS OFF)\nMERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED T' at line 1")

-----------
QUERY:

EXPLAIN (COSTS OFF)
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'COSTS OFF)\nMERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED T' at line 1")

-----------
QUERY:

EXPLAIN (COSTS OFF)
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT VALUES (4, NULL);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'COSTS OFF)\nMERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCH' at line 1")

-----------
QUERY:

DELETE FROM target WHERE tid > 100;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ANALYZE target;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'target' at line 1")

-----------
QUERY:


-- insert some matching source rows to work from
INSERT INTO source VALUES (2, 5);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

INSERT INTO source VALUES (3, 20);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM source ORDER BY sid;
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:


-- equivalent of an UPDATE join
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tUPDATE' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- equivalent of a DELETE join
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tDELETE' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	DO NOTHING;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tDO NOT' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT VALUES (4, NULL);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- duplicate source row causes multiple target row update ERROR
INSERT INTO source VALUES (2, 5);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM source ORDER BY sid;
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tUPDATE' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tDELETE' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- remove duplicate MATCHED data from source data
DELETE FROM source WHERE sid = 2;
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

INSERT INTO source VALUES (2, 5);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM source ORDER BY sid;
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:


-- duplicate source row on INSERT should fail because of target_pkey
INSERT INTO source VALUES (4, 40);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
  INSERT VALUES (4, NULL);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n  I' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- remove duplicate NOT MATCHED data from source data
DELETE FROM source WHERE sid = 4;
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

INSERT INTO source VALUES (4, 40);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM source ORDER BY sid;
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:


-- remove constraints
alter table target drop CONSTRAINT target_pkey;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

alter table target alter column tid drop not null;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'not null' at line 1")

-----------
QUERY:


-- multiple actions
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT VALUES (4, 4)
WHEN MATCHED THEN
	UPDATE SET balance = 0;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- should be equivalent
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = 0
WHEN NOT MATCHED THEN
	INSERT VALUES (4, 4);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tUPDATE' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- column references
-- do a simple equivalent of an UPDATE join
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = t.balance + s.delta;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tUPDATE' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- do a simple equivalent of an INSERT SELECT
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- and again with duplicate source rows
INSERT INTO source VALUES (5, 50);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:

INSERT INTO source VALUES (5, 50);
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:


-- do a simple equivalent of an INSERT SELECT
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
  INSERT VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n  I' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- removing duplicate source rows
DELETE FROM source WHERE sid = 5;
RESULT:
	ERROR - (1146, "Table 'test.source' doesn't exist")

-----------
QUERY:


-- and again with explicitly identified column list
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT (tid, balance) VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- and again with a subtle error: referring to non-existent target row for NOT MATCHED
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT (tid, balance) VALUES (t.tid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN NOT MATCHED THEN\n\tIN' at line 2")

-----------
QUERY:


-- and again with a constant ON clause
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON (SELECT true)
WHEN NOT MATCHED THEN
	INSERT (tid, balance) VALUES (t.tid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON (SELECT true)\nWHEN NOT MATCHED THEN\n\tIN' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- now the classic UPSERT
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = t.balance + s.delta
WHEN NOT MATCHED THEN
	INSERT VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN\n\tUPDATE' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- unreachable WHEN clause should ERROR
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED THEN /* Terminal WHEN clause for MATCHED */
	DELETE
WHEN MATCHED THEN
	UPDATE SET balance = t.balance - s.delta;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED THEN /* Term' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- conditional WHEN clause
CREATE TABLE wq_target (tid integer not null, balance integer DEFAULT -1)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 3")

-----------
QUERY:

CREATE TABLE wq_source (balance integer, sid integer)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:


INSERT INTO wq_source (sid, balance) VALUES (1, 100);
RESULT:
	ERROR - (1146, "Table 'test.wq_source' doesn't exist")

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

-- try a simple INSERT with default values first
MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT (tid) VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN NOT MATCHED THEN\n' at line 2")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- this time with a FALSE condition
MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN NOT MATCHED AND FALSE THEN
	INSERT (tid) VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN NOT MATCHED AND F' at line 2")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


-- this time with an actual condition which returns false
MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN NOT MATCHED AND s.balance <> 100 THEN
	INSERT (tid) VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN NOT MATCHED AND s' at line 2")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

-- and now with a condition which returns true
MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN NOT MATCHED AND s.balance = 100 THEN
	INSERT (tid) VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN NOT MATCHED AND s' at line 2")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- conditions in the NOT MATCHED clause can only refer to source columns
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN NOT MATCHED AND t.balance = 100 THEN
	INSERT (tid) VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN NOT MATCHED AND t' at line 1")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN NOT MATCHED AND s.balance = 100 THEN
	INSERT (tid) VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN NOT MATCHED AND s' at line 1")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


-- conditions in MATCHED clause can refer to both source and target
SELECT * FROM wq_source;
RESULT:
	ERROR - (1146, "Table 'test.wq_source' doesn't exist")

-----------
QUERY:

MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND s.balance = 100 THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND s.bal' at line 1")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND t.balance = 100 THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND t.bal' at line 1")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


-- check if AND works
MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND t.balance = 99 AND s.balance > 100 THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND t.bal' at line 2")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND t.balance = 99 AND s.balance = 100 THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND t.bal' at line 1")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


-- check if OR works
MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND t.balance = 99 OR s.balance > 100 THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND t.bal' at line 2")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND t.balance = 199 OR s.balance > 100 THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND t.bal' at line 1")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


-- check source-side whole-row references
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO wq_target t
USING wq_source s ON (t.tid = s.sid)
WHEN matched and t = s or t.tid = s.sid THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON (t.tid = s.sid)\nWHEN matched and t =' at line 1")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- check if subqueries work in the conditions?
MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND t.balance > (SELECT max(balance) FROM target) THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND t.bal' at line 2")

-----------
QUERY:


-- check if we can access system columns in the conditions
MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND t.xmin = t.xmax THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND t.xmi' at line 2")

-----------
QUERY:


MERGE INTO wq_target t
USING wq_source s ON t.tid = s.sid
WHEN MATCHED AND t.tableoid >= 0 THEN
	UPDATE SET balance = t.balance + s.balance;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO wq_target t\nUSING wq_source s ON t.tid = s.sid\nWHEN MATCHED AND t.tab' at line 1")

-----------
QUERY:

SELECT * FROM wq_target;
RESULT:
	ERROR - (1146, "Table 'test.wq_target' doesn't exist")

-----------
QUERY:


DROP TABLE wq_target, wq_source;
RESULT:
	ERROR - (1051, "Unknown table 'test.wq_target,test.wq_source'")

-----------
QUERY:


-- test triggers
create or replace function merge_trigfunc () returns trigger
language plpgsql as
$$
DECLARE
	line text;
BEGIN
	SELECT INTO line format('%s %s %s trigger%s',
		TG_WHEN, TG_OP, TG_LEVEL, CASE
		WHEN TG_OP = 'INSERT' AND TG_LEVEL = 'ROW'
			THEN format(' row: %s', NEW)
		WHEN TG_OP = 'UPDATE' AND TG_LEVEL = 'ROW'
			THEN format(' row: %s -> %s', OLD, NEW)
		WHEN TG_OP = 'DELETE' AND TG_LEVEL = 'ROW'
			THEN format(' row: %s', OLD)
		END);

	RAISE NOTICE '%', line;
	IF (TG_WHEN = 'BEFORE' AND TG_LEVEL = 'ROW') THEN
		IF (TG_OP = 'DELETE') THEN
			RETURN OLD;
		ELSE
			RETURN NEW;
		END IF;
	ELSE
		RETURN NULL;
	END IF;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'function merge_trigfunc () returns trigger\nlanguage plpgsql as\n$$\nDECLARE\n\tline ' at line 2")

-----------
QUERY:

CREATE TRIGGER merge_bsi BEFORE INSERT ON target FOR EACH STATEMENT EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'STATEMENT EXECUTE PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_bsu BEFORE UPDATE ON target FOR EACH STATEMENT EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'STATEMENT EXECUTE PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_bsd BEFORE DELETE ON target FOR EACH STATEMENT EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'STATEMENT EXECUTE PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_asi AFTER INSERT ON target FOR EACH STATEMENT EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'STATEMENT EXECUTE PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_asu AFTER UPDATE ON target FOR EACH STATEMENT EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'STATEMENT EXECUTE PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_asd AFTER DELETE ON target FOR EACH STATEMENT EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'STATEMENT EXECUTE PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_bri BEFORE INSERT ON target FOR EACH ROW EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_bru BEFORE UPDATE ON target FOR EACH ROW EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_brd BEFORE DELETE ON target FOR EACH ROW EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_ari AFTER INSERT ON target FOR EACH ROW EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_aru AFTER UPDATE ON target FOR EACH ROW EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:

CREATE TRIGGER merge_ard AFTER DELETE ON target FOR EACH ROW EXECUTE PROCEDURE merge_trigfunc ();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE merge_trigfunc ()' at line 1")

-----------
QUERY:


-- now the classic UPSERT, with a DELETE
BEGIN;
RESULT:
	[]

-----------
QUERY:

UPDATE target SET balance = 0 WHERE tid = 3;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

--EXPLAIN (ANALYZE ON, COSTS OFF, SUMMARY OFF, TIMING OFF)
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED AND t.balance > s.delta THEN
	UPDATE SET balance = t.balance - s.delta
WHEN MATCHED THEN
	DELETE
WHEN NOT MATCHED THEN
	INSERT VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '--EXPLAIN (ANALYZE ON, COSTS OFF, SUMMARY OFF, TIMING OFF)\nMERGE INTO target t\nU' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- Test behavior of triggers that turn UPDATE/DELETE into no-ops
create or replace function skip_merge_op() returns trigger
language plpgsql as
$$
BEGIN
	RETURN NULL;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'function skip_merge_op() returns trigger\nlanguage plpgsql as\n$$\nBEGIN\n\tRETURN NU' at line 2")

-----------
QUERY:


SELECT * FROM target full outer join source on (sid = tid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'outer join source on (sid = tid)' at line 1")

-----------
QUERY:

create trigger merge_skip BEFORE INSERT OR UPDATE or DELETE
  ON target FOR EACH ROW EXECUTE FUNCTION skip_merge_op();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OR UPDATE or DELETE\n  ON target FOR EACH ROW EXECUTE FUNCTION skip_merge_op()' at line 1")

-----------
QUERY:

DO $$
DECLARE
  result integer;
BEGIN
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED AND s.sid = 3 THEN UPDATE SET balance = t.balance + s.delta
WHEN MATCHED THEN DELETE
WHEN NOT MATCHED THEN INSERT VALUES (sid, delta);
IF FOUND THEN
  RAISE NOTICE 'Found';
ELSE
  RAISE NOTICE 'Not found';
END IF;
GET DIAGNOSTICS result := ROW_COUNT;
RAISE NOTICE 'ROW_COUNT = %', result;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DECLARE\n  result integer;\nBEGIN\nMERGE INTO target t\nUSING source AS s\nON t.tid =' at line 2")

-----------
QUERY:

SELECT * FROM target FULL OUTER JOIN source ON (sid = tid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OUTER JOIN source ON (sid = tid)' at line 1")

-----------
QUERY:

DROP TRIGGER merge_skip ON target;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ON target' at line 1")

-----------
QUERY:

DROP FUNCTION skip_merge_op();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '()' at line 1")

-----------
QUERY:


-- test from PL/pgSQL
-- make sure MERGE INTO isn/* REPLACED */''t interpreted to mean returning variables like SELECT INTO
BEGIN;
RESULT:
	[]

-----------
QUERY:

DO LANGUAGE plpgsql $$
BEGIN
MERGE INTO target t
USING source AS s
ON t.tid = s.sid
WHEN MATCHED AND t.balance > s.delta THEN
	UPDATE SET balance = t.balance - s.delta;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '$$\nBEGIN\nMERGE INTO target t\nUSING source AS s\nON t.tid = s.sid\nWHEN MATCHED AND' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


--source constants
BEGIN;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '--source constants\nBEGIN' at line 1")

-----------
QUERY:

MERGE INTO target t
USING (SELECT 9 AS sid, 57 AS delta) AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT (tid, balance) VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING (SELECT 9 AS sid, 57 AS delta) AS s\nON t.tid = s.sid\nW' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


--source query
BEGIN;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '--source query\nBEGIN' at line 1")

-----------
QUERY:

MERGE INTO target t
USING (SELECT sid, delta FROM source WHERE delta > 0) AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT (tid, balance) VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING (SELECT sid, delta FROM source WHERE delta > 0) AS s\nO' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING (SELECT sid, delta as newname FROM source WHERE delta > 0) AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT (tid, balance) VALUES (s.sid, s.newname);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING (SELECT sid, delta as newname FROM source WHERE delta ' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


--self-merge
BEGIN;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '--self-merge\nBEGIN' at line 1")

-----------
QUERY:

MERGE INTO target t1
USING target t2
ON t1.tid = t2.tid
WHEN MATCHED THEN
	UPDATE SET balance = t1.balance + t2.balance
WHEN NOT MATCHED THEN
	INSERT VALUES (t2.tid, t2.balance);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t1\nUSING target t2\nON t1.tid = t2.tid\nWHEN MATCHED THEN\n\tUPDAT' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING (SELECT tid as sid, balance as delta FROM target WHERE balance > 0) AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT (tid, balance) VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING (SELECT tid as sid, balance as delta FROM target WHERE' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO target t
USING
(SELECT sid, max(delta) AS delta
 FROM source
 GROUP BY sid
 HAVING count(*) = 1
 ORDER BY sid ASC) AS s
ON t.tid = s.sid
WHEN NOT MATCHED THEN
	INSERT (tid, balance) VALUES (s.sid, s.delta);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO target t\nUSING\n(SELECT sid, max(delta) AS delta\n FROM source\n GROUP B' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- plpgsql parameters and results
BEGIN;
RESULT:
	[]

-----------
QUERY:

CREATE FUNCTION merge_func (p_id integer, p_bal integer)
RETURNS INTEGER
LANGUAGE plpgsql
AS $$
DECLARE
 result integer;
BEGIN
MERGE INTO target t
USING (SELECT p_id AS sid) AS s
ON t.tid = s.sid
WHEN MATCHED THEN
	UPDATE SET balance = t.balance - p_bal;
IF FOUND THEN
	GET DIAGNOSTICS result := ROW_COUNT;
END IF;
RETURN result;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'plpgsql\nAS $$\nDECLARE\n result integer;\nBEGIN\nMERGE INTO target t\nUSING (SELECT p' at line 3")

-----------
QUERY:

SELECT merge_func(3, 4);
RESULT:
	ERROR - (1305, 'FUNCTION test.merge_func does not exist')

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- PREPARE
BEGIN;
RESULT:
	[]

-----------
QUERY:

prepare foom as merge into target t using (select 1 as sid) s on (t.tid = s.sid) when matched then update set balance = 1;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'as merge into target t using (select 1 as sid) s on (t.tid = s.sid) when matched' at line 1")

-----------
QUERY:

execute foom;
RESULT:
	ERROR - (1243, 'Unknown prepared statement handler (foom) given to EXECUTE')

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

PREPARE foom2 (integer, integer) AS
MERGE INTO target t
USING (SELECT 1) s
ON t.tid = $1
WHEN MATCHED THEN
UPDATE SET balance = $2;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(integer, integer) AS\nMERGE INTO target t\nUSING (SELECT 1) s\nON t.tid = $1\nWHEN ' at line 1")

-----------
QUERY:

--EXPLAIN (ANALYZE ON, COSTS OFF, SUMMARY OFF, TIMING OFF)
execute foom2 (1, 1);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '--EXPLAIN (ANALYZE ON, COSTS OFF, SUMMARY OFF, TIMING OFF)\nexecute foom2 (1, 1)' at line 1")

-----------
QUERY:

SELECT * FROM target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- subqueries in source relation

CREATE TABLE sq_target (tid integer NOT NULL, balance integer)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 4")

-----------
QUERY:

CREATE TABLE sq_source (delta integer, sid integer, balance integer DEFAULT 0)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:


INSERT INTO sq_target(tid, balance) VALUES (1,100), (2,200), (3,300);
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:

INSERT INTO sq_source(sid, delta) VALUES (1,10), (2,20), (4,40);
RESULT:
	ERROR - (1146, "Table 'test.sq_source' doesn't exist")

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO sq_target t
USING (SELECT * FROM sq_source) s
ON tid = sid
WHEN MATCHED AND t.balance > delta THEN
	UPDATE SET balance = t.balance + delta;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target t\nUSING (SELECT * FROM sq_source) s\nON tid = sid\nWHEN MATCH' at line 1")

-----------
QUERY:

SELECT * FROM sq_target;
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- try a view
CREATE VIEW v AS SELECT * FROM sq_source WHERE sid < 2;
RESULT:
	ERROR - (1146, "Table 'test.sq_source' doesn't exist")

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO sq_target
USING v
ON tid = sid
WHEN MATCHED THEN
    UPDATE SET balance = v.balance + delta;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target\nUSING v\nON tid = sid\nWHEN MATCHED THEN\n    UPDATE SET balan' at line 1")

-----------
QUERY:

SELECT * FROM sq_target;
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- ambiguous reference to a column
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO sq_target
USING v
ON tid = sid
WHEN MATCHED AND tid >= 2 THEN
    UPDATE SET balance = balance + delta
WHEN NOT MATCHED THEN
	INSERT (balance, tid) VALUES (balance + delta, sid)
WHEN MATCHED AND tid < 2 THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target\nUSING v\nON tid = sid\nWHEN MATCHED AND tid >= 2 THEN\n    UPD' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

INSERT INTO sq_source (sid, balance, delta) VALUES (-1, -1, -10);
RESULT:
	ERROR - (1146, "Table 'test.sq_source' doesn't exist")

-----------
QUERY:

MERGE INTO sq_target t
USING v
ON tid = sid
WHEN MATCHED AND tid >= 2 THEN
    UPDATE SET balance = t.balance + delta
WHEN NOT MATCHED THEN
	INSERT (balance, tid) VALUES (balance + delta, sid)
WHEN MATCHED AND tid < 2 THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target t\nUSING v\nON tid = sid\nWHEN MATCHED AND tid >= 2 THEN\n    U' at line 1")

-----------
QUERY:

SELECT * FROM sq_target;
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- CTEs
BEGIN;
RESULT:
	[]

-----------
QUERY:

INSERT INTO sq_source (sid, balance, delta) VALUES (-1, -1, -10);
RESULT:
	ERROR - (1146, "Table 'test.sq_source' doesn't exist")

-----------
QUERY:

WITH targq AS (
	SELECT * FROM v
)
MERGE INTO sq_target t
USING v
ON tid = sid
WHEN MATCHED AND tid >= 2 THEN
    UPDATE SET balance = t.balance + delta
WHEN NOT MATCHED THEN
	INSERT (balance, tid) VALUES (balance + delta, sid)
WHEN MATCHED AND tid < 2 THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target t\nUSING v\nON tid = sid\nWHEN MATCHED AND tid >= 2 THEN\n    U' at line 4")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- RETURNING
SELECT * FROM sq_source ORDER BY sid;
RESULT:
	ERROR - (1146, "Table 'test.sq_source' doesn't exist")

-----------
QUERY:

SELECT * FROM sq_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

CREATE TABLE merge_actions(action text, abbrev text);
RESULT:
	[]

-----------
QUERY:

INSERT INTO merge_actions VALUES ('INSERT', 'ins'), ('UPDATE', 'upd'), ('DELETE', 'del');
RESULT:
	[]

-----------
QUERY:

MERGE INTO sq_target t
USING sq_source s
ON tid = sid
WHEN MATCHED AND tid >= 2 THEN
    UPDATE SET balance = t.balance + delta
WHEN NOT MATCHED THEN
    INSERT (balance, tid) VALUES (balance + delta, sid)
WHEN MATCHED AND tid < 2 THEN
    DELETE
RETURNING (SELECT abbrev FROM merge_actions
            WHERE action = merge_action()) AS action,
          t.*,
          CASE merge_action()
              WHEN 'INSERT' THEN 'Inserted '||t
              WHEN 'UPDATE' THEN 'Added '||delta||' to balance'
              WHEN 'DELETE' THEN 'Removed '||t
          END AS description;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target t\nUSING sq_source s\nON tid = sid\nWHEN MATCHED AND tid >= 2 ' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- error when using merge_action() outside MERGE
SELECT merge_action() FROM sq_target;
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:

UPDATE sq_target SET balance = balance + 1 RETURNING merge_action();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'RETURNING merge_action()' at line 1")

-----------
QUERY:


-- RETURNING in CTEs
CREATE TABLE sq_target_merge_log (tid integer NOT NULL, last_change text);
RESULT:
	[]

-----------
QUERY:

INSERT INTO sq_target_merge_log VALUES (1, 'Original value');
RESULT:
	[]

-----------
QUERY:

BEGIN;
RESULT:
	[]

-----------
QUERY:

WITH m AS (
    MERGE INTO sq_target t
    USING sq_source s
    ON tid = sid
    WHEN MATCHED AND tid >= 2 THEN
        UPDATE SET balance = t.balance + delta
    WHEN NOT MATCHED THEN
        INSERT (balance, tid) VALUES (balance + delta, sid)
    WHEN MATCHED AND tid < 2 THEN
        DELETE
    RETURNING merge_action() AS action, t.*,
              CASE merge_action()
                  WHEN 'INSERT' THEN 'Inserted '||t
                  WHEN 'UPDATE' THEN 'Added '||delta||' to balance'
                  WHEN 'DELETE' THEN 'Removed '||t
              END AS description
), m2 AS (
    MERGE INTO sq_target_merge_log l
    USING m
    ON l.tid = m.tid
    WHEN MATCHED THEN
        UPDATE SET last_change = description
    WHEN NOT MATCHED THEN
        INSERT VALUES (m.tid, description)
    RETURNING action, merge_action() AS log_action, l.*
)
SELECT * FROM m2;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target t\n    USING sq_source s\n    ON tid = sid\n    WHEN MATCHED A' at line 2")

-----------
QUERY:

SELECT * FROM sq_target_merge_log ORDER BY tid;
RESULT:
	((1, 'Original value'),)

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- COPY (MERGE ... RETURNING) TO ...
BEGIN;
RESULT:
	[]

-----------
QUERY:

COPY (
    MERGE INTO sq_target t
    USING sq_source s
    ON tid = sid
    WHEN MATCHED AND tid >= 2 THEN
        UPDATE SET balance = t.balance + delta
    WHEN NOT MATCHED THEN
        INSERT (balance, tid) VALUES (balance + delta, sid)
    WHEN MATCHED AND tid < 2 THEN
        DELETE
    RETURNING merge_action(), t.*
) TO stdout;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'COPY (\n    MERGE INTO sq_target t\n    USING sq_source s\n    ON tid = sid\n    WHE' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- SQL function with MERGE ... RETURNING
BEGIN;
RESULT:
	[]

-----------
QUERY:

CREATE FUNCTION merge_into_sq_target(sid int, balance int, delta int,
                                     OUT action text, OUT tid int, OUT new_balance int)
LANGUAGE sql AS
$$
    MERGE INTO sq_target t
    USING (VALUES ($1, $2, $3)) AS v(sid, balance, delta)
    ON tid = v.sid
    WHEN MATCHED AND tid >= 2 THEN
        UPDATE SET balance = t.balance + v.delta
    WHEN NOT MATCHED THEN
        INSERT (balance, tid) VALUES (v.balance + v.delta, v.sid)
    WHEN MATCHED AND tid < 2 THEN
        DELETE
    RETURNING merge_action(), t.*;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OUT action text, OUT tid int, OUT new_balance int)\nLANGUAGE sql AS\n$$\n    MERGE ' at line 2")

-----------
QUERY:

SELECT m.*
FROM (VALUES (1, 0, 0), (3, 0, 20), (4, 100, 10)) AS v(sid, balance, delta),
LATERAL (SELECT action, tid, new_balance FROM merge_into_sq_target(sid, balance, delta)) m;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1, 0, 0), (3, 0, 20), (4, 100, 10)) AS v(sid, balance, delta),\nLATERAL (SELECT ' at line 2")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- SQL SRF with MERGE ... RETURNING
BEGIN;
RESULT:
	[]

-----------
QUERY:

CREATE FUNCTION merge_sq_source_into_sq_target()
RETURNS TABLE (action text, tid int, balance int)
LANGUAGE sql AS
$$
    MERGE INTO sq_target t
    USING sq_source s
    ON tid = sid
    WHEN MATCHED AND tid >= 2 THEN
        UPDATE SET balance = t.balance + delta
    WHEN NOT MATCHED THEN
        INSERT (balance, tid) VALUES (balance + delta, sid)
    WHEN MATCHED AND tid < 2 THEN
        DELETE
    RETURNING merge_action(), t.*;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'TABLE (action text, tid int, balance int)\nLANGUAGE sql AS\n$$\n    MERGE INTO sq_t' at line 2")

-----------
QUERY:

SELECT * FROM merge_sq_source_into_sq_target();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '()' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- PL/pgSQL function with MERGE ... RETURNING ... INTO
BEGIN;
RESULT:
	[]

-----------
QUERY:

CREATE FUNCTION merge_into_sq_target(sid int, balance int, delta int,
                                     OUT r_action text, OUT r_tid int, OUT r_balance int)
LANGUAGE plpgsql AS
$$
BEGIN
    MERGE INTO sq_target t
    USING (VALUES ($1, $2, $3)) AS v(sid, balance, delta)
    ON tid = v.sid
    WHEN MATCHED AND tid >= 2 THEN
        UPDATE SET balance = t.balance + v.delta
    WHEN NOT MATCHED THEN
        INSERT (balance, tid) VALUES (v.balance + v.delta, v.sid)
    WHEN MATCHED AND tid < 2 THEN
        DELETE
    RETURNING merge_action(), t.* INTO r_action, r_tid, r_balance;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OUT r_action text, OUT r_tid int, OUT r_balance int)\nLANGUAGE plpgsql AS\n$$\nBEGI' at line 2")

-----------
QUERY:

SELECT m.*
FROM (VALUES (1, 0, 0), (3, 0, 20), (4, 100, 10)) AS v(sid, balance, delta),
LATERAL (SELECT r_action, r_tid, r_balance FROM merge_into_sq_target(sid, balance, delta)) m;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1, 0, 0), (3, 0, 20), (4, 100, 10)) AS v(sid, balance, delta),\nLATERAL (SELECT ' at line 2")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- EXPLAIN
CREATE TABLE ex_mtarget (a int, b int)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 3")

-----------
QUERY:

CREATE TABLE ex_msource (a int, b int)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

INSERT INTO ex_mtarget SELECT i, i*10 FROM generate_series(1,100,2) i;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1,100,2) i' at line 1")

-----------
QUERY:

INSERT INTO ex_msource SELECT i, i*10 FROM generate_series(1,100,1) i;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1,100,1) i' at line 1")

-----------
QUERY:


CREATE FUNCTION explain_merge(query text) RETURNS SETOF text
LANGUAGE plpgsql AS
$$
DECLARE ln text;
BEGIN
    FOR ln IN
        EXECUTE 'explain (analyze, timing off, summary off, costs off) ' ||
		  query
    LOOP
        ln := regexp_replace(ln, '(Memory( Usage)?|Buckets|Batches): \S*',  '\1: xxx', 'g');
        RETURN NEXT ln;
    END LOOP;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'SETOF text\nLANGUAGE plpgsql AS\n$$\nDECLARE ln text;\nBEGIN\n    FOR ln IN\n        E' at line 1")

-----------
QUERY:


-- only updates
SELECT explain_merge('
MERGE INTO ex_mtarget t USING ex_msource s ON t.a = s.a
WHEN MATCHED THEN
	UPDATE SET b = t.b + 1');
RESULT:
	ERROR - (1305, 'FUNCTION test.explain_merge does not exist')

-----------
QUERY:


-- only updates to selected tuples
SELECT explain_merge('
MERGE INTO ex_mtarget t USING ex_msource s ON t.a = s.a
WHEN MATCHED AND t.a < 10 THEN
	UPDATE SET b = t.b + 1');
RESULT:
	ERROR - (1305, 'FUNCTION test.explain_merge does not exist')

-----------
QUERY:


-- updates + deletes
SELECT explain_merge('
MERGE INTO ex_mtarget t USING ex_msource s ON t.a = s.a
WHEN MATCHED AND t.a < 10 THEN
	UPDATE SET b = t.b + 1
WHEN MATCHED AND t.a >= 10 AND t.a <= 20 THEN
	DELETE');
RESULT:
	ERROR - (1305, 'FUNCTION test.explain_merge does not exist')

-----------
QUERY:


-- only inserts
SELECT explain_merge('
MERGE INTO ex_mtarget t USING ex_msource s ON t.a = s.a
WHEN NOT MATCHED AND s.a < 10 THEN
	INSERT VALUES (a, b)');
RESULT:
	ERROR - (1305, 'FUNCTION test.explain_merge does not exist')

-----------
QUERY:


-- all three
SELECT explain_merge('
MERGE INTO ex_mtarget t USING ex_msource s ON t.a = s.a
WHEN MATCHED AND t.a < 10 THEN
	UPDATE SET b = t.b + 1
WHEN MATCHED AND t.a >= 30 AND t.a <= 40 THEN
	DELETE
WHEN NOT MATCHED AND s.a < 20 THEN
	INSERT VALUES (a, b)');
RESULT:
	ERROR - (1305, 'FUNCTION test.explain_merge does not exist')

-----------
QUERY:


-- nothing
SELECT explain_merge('
MERGE INTO ex_mtarget t USING ex_msource s ON t.a = s.a AND t.a < -1000
WHEN MATCHED AND t.a < 10 THEN
	DO NOTHING');
RESULT:
	ERROR - (1305, 'FUNCTION test.explain_merge does not exist')

-----------
QUERY:


DROP TABLE ex_msource, ex_mtarget;
RESULT:
	ERROR - (1051, "Unknown table 'test.ex_msource,test.ex_mtarget'")

-----------
QUERY:

DROP FUNCTION explain_merge(text);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(text)' at line 1")

-----------
QUERY:


-- EXPLAIN SubPlans and InitPlans
CREATE TABLE src (a int, b int, c int, d int);
RESULT:
	[]

-----------
QUERY:

CREATE TABLE tgt (a int, b int, c int, d int);
RESULT:
	[]

-----------
QUERY:

CREATE TABLE ref (ab int, cd int);
RESULT:
	[]

-----------
QUERY:


EXPLAIN (verbose, costs off)
MERGE INTO tgt t
USING (SELECT *, (SELECT count(*) FROM ref r
                   WHERE r.ab = s.a + s.b
                     AND r.cd = s.c - s.d) cnt
         FROM src s) s
ON t.a = s.a AND t.b < s.cnt
WHEN MATCHED AND t.c > s.cnt THEN
  UPDATE SET (b, c) = (SELECT s.b, s.cnt);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'verbose, costs off)\nMERGE INTO tgt t\nUSING (SELECT *, (SELECT count(*) FROM ref ' at line 1")

-----------
QUERY:


DROP TABLE src, tgt, ref;
RESULT:
	[]

-----------
QUERY:


-- Subqueries
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO sq_target t
USING v
ON tid = sid
WHEN MATCHED THEN
    UPDATE SET balance = (SELECT count(*) FROM sq_target);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target t\nUSING v\nON tid = sid\nWHEN MATCHED THEN\n    UPDATE SET bal' at line 1")

-----------
QUERY:

SELECT * FROM sq_target WHERE tid = 1;
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO sq_target t
USING v
ON tid = sid
WHEN MATCHED AND (SELECT count(*) > 0 FROM sq_target) THEN
    UPDATE SET balance = 42;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target t\nUSING v\nON tid = sid\nWHEN MATCHED AND (SELECT count(*) > ' at line 1")

-----------
QUERY:

SELECT * FROM sq_target WHERE tid = 1;
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO sq_target t
USING v
ON tid = sid AND (SELECT count(*) > 0 FROM sq_target)
WHEN MATCHED THEN
    UPDATE SET balance = 42;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO sq_target t\nUSING v\nON tid = sid AND (SELECT count(*) > 0 FROM sq_tar' at line 1")

-----------
QUERY:

SELECT * FROM sq_target WHERE tid = 1;
RESULT:
	ERROR - (1146, "Table 'test.sq_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


DROP TABLE sq_target, sq_target_merge_log, sq_source CASCADE;
RESULT:
	ERROR - (1051, "Unknown table 'test.sq_target,test.sq_source'")

-----------
QUERY:


CREATE TABLE pa_target (tid integer, balance float, val text)
	PARTITION BY LIST (tid);
RESULT:
	ERROR - (1492, 'For LIST partitions each partition must be defined')

-----------
QUERY:


CREATE TABLE part1 PARTITION OF pa_target FOR VALUES IN (1,4)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF pa_target FOR VALUES IN (1,4)\n  WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:

CREATE TABLE part2 PARTITION OF pa_target FOR VALUES IN (2,5,6)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF pa_target FOR VALUES IN (2,5,6)\n  WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:

CREATE TABLE part3 PARTITION OF pa_target FOR VALUES IN (3,8,9)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF pa_target FOR VALUES IN (3,8,9)\n  WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:

CREATE TABLE part4 PARTITION OF pa_target DEFAULT
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF pa_target DEFAULT\n  WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:


CREATE TABLE pa_source (sid integer, delta float);
RESULT:
	[]

-----------
QUERY:

-- insert many rows to the source table
INSERT INTO pa_source SELECT id, id * 10  FROM generate_series(1,14) AS id;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1,14) AS id' at line 2")

-----------
QUERY:

-- insert a few rows in the target table (odd numbered tid)
INSERT INTO pa_target SELECT id, id * 100, 'initial' FROM generate_series(1,14,2) AS id;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1,14,2) AS id' at line 2")

-----------
QUERY:


-- try simple MERGE
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid
  WHEN MATCHED THEN
    UPDATE SET balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (sid, delta, 'inserted by merge');
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO pa_target t\n  USING pa_source s\n  ON t.tid = s.sid\n  WHEN MATCHED THE' at line 1")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- same with a constant qual
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid AND tid = 1
  WHEN MATCHED THEN
    UPDATE SET balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (sid, delta, 'inserted by merge');
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO pa_target t\n  USING pa_source s\n  ON t.tid = s.sid AND tid = 1\n  WHEN' at line 1")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- try updating the partition key column
BEGIN;
RESULT:
	[]

-----------
QUERY:

CREATE FUNCTION merge_func() RETURNS integer LANGUAGE plpgsql AS $$
DECLARE
  result integer;
BEGIN
MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid
  WHEN MATCHED THEN
    UPDATE SET tid = tid + 1, balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (sid, delta, 'inserted by merge');
IF FOUND THEN
  GET DIAGNOSTICS result := ROW_COUNT;
END IF;
RETURN result;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'plpgsql AS $$\nDECLARE\n  result integer;\nBEGIN\nMERGE INTO pa_target t\n  USING pa_' at line 1")

-----------
QUERY:

SELECT merge_func();
RESULT:
	ERROR - (1305, 'FUNCTION test.merge_func does not exist')

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- update partition key to partition not initially scanned
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid AND t.tid = 1
  WHEN MATCHED THEN
    UPDATE SET tid = tid + 1, balance = balance + delta, val = val || ' updated by merge'
  RETURNING merge_action(), t.*;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO pa_target t\n  USING pa_source s\n  ON t.tid = s.sid AND t.tid = 1\n  WH' at line 1")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


DROP TABLE pa_target CASCADE;
RESULT:
	ERROR - (1051, "Unknown table 'test.pa_target'")

-----------
QUERY:


-- The target table is partitioned in the same way, but this time by attaching
-- partitions which have columns in different order, dropped columns etc.
CREATE TABLE pa_target (tid integer, balance float, val text)
	PARTITION BY LIST (tid);
RESULT:
	ERROR - (1492, 'For LIST partitions each partition must be defined')

-----------
QUERY:


CREATE TABLE part1 (tid integer, balance float, val text)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

CREATE TABLE part2 (balance float, tid integer, val text)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

CREATE TABLE part3 (tid integer, balance float, val text)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

CREATE TABLE part4 (extraid text, tid integer, balance float, val text)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

ALTER TABLE part4 DROP COLUMN extraid;
RESULT:
	ERROR - (1146, "Table 'test.part4' doesn't exist")

-----------
QUERY:


ALTER TABLE pa_target ATTACH PARTITION part1 FOR VALUES IN (1,4);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ATTACH PARTITION part1 FOR VALUES IN (1,4)' at line 1")

-----------
QUERY:

ALTER TABLE pa_target ATTACH PARTITION part2 FOR VALUES IN (2,5,6);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ATTACH PARTITION part2 FOR VALUES IN (2,5,6)' at line 1")

-----------
QUERY:

ALTER TABLE pa_target ATTACH PARTITION part3 FOR VALUES IN (3,8,9);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ATTACH PARTITION part3 FOR VALUES IN (3,8,9)' at line 1")

-----------
QUERY:

ALTER TABLE pa_target ATTACH PARTITION part4 DEFAULT;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ATTACH PARTITION part4 DEFAULT' at line 1")

-----------
QUERY:


-- insert a few rows in the target table (odd numbered tid)
INSERT INTO pa_target SELECT id, id * 100, 'initial' FROM generate_series(1,14,2) AS id;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1,14,2) AS id' at line 2")

-----------
QUERY:


-- try simple MERGE
BEGIN;
RESULT:
	[]

-----------
QUERY:

DO $$
DECLARE
  result integer;
BEGIN
MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid
  WHEN MATCHED THEN
    UPDATE SET balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (sid, delta, 'inserted by merge');
GET DIAGNOSTICS result := ROW_COUNT;
RAISE NOTICE 'ROW_COUNT = %', result;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DECLARE\n  result integer;\nBEGIN\nMERGE INTO pa_target t\n  USING pa_source s\n  ON ' at line 2")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- same with a constant qual
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid AND tid IN (1, 5)
  WHEN MATCHED AND tid % 5 = 0 THEN DELETE
  WHEN MATCHED THEN
    UPDATE SET balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (sid, delta, 'inserted by merge');
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO pa_target t\n  USING pa_source s\n  ON t.tid = s.sid AND tid IN (1, 5)\n' at line 1")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- try updating the partition key column
BEGIN;
RESULT:
	[]

-----------
QUERY:

DO $$
DECLARE
  result integer;
BEGIN
MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid
  WHEN MATCHED THEN
    UPDATE SET tid = tid + 1, balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (sid, delta, 'inserted by merge');
GET DIAGNOSTICS result := ROW_COUNT;
RAISE NOTICE 'ROW_COUNT = %', result;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DECLARE\n  result integer;\nBEGIN\nMERGE INTO pa_target t\n  USING pa_source s\n  ON ' at line 2")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- as above, but blocked by BEFORE DELETE ROW trigger
BEGIN;
RESULT:
	[]

-----------
QUERY:

CREATE FUNCTION trig_fn() RETURNS trigger LANGUAGE plpgsql AS
  $$ BEGIN RETURN NULL; END; $$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'trigger LANGUAGE plpgsql AS\n  $$ BEGIN RETURN NULL; END; $$' at line 1")

-----------
QUERY:

CREATE TRIGGER del_trig BEFORE DELETE ON pa_target
  FOR EACH ROW EXECUTE PROCEDURE trig_fn();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE trig_fn()' at line 2")

-----------
QUERY:

DO $$
DECLARE
  result integer;
BEGIN
MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid
  WHEN MATCHED THEN
    UPDATE SET tid = tid + 1, balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (sid, delta, 'inserted by merge');
GET DIAGNOSTICS result := ROW_COUNT;
RAISE NOTICE 'ROW_COUNT = %', result;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DECLARE\n  result integer;\nBEGIN\nMERGE INTO pa_target t\n  USING pa_source s\n  ON ' at line 2")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- as above, but blocked by BEFORE INSERT ROW trigger
BEGIN;
RESULT:
	[]

-----------
QUERY:

CREATE FUNCTION trig_fn() RETURNS trigger LANGUAGE plpgsql AS
  $$ BEGIN RETURN NULL; END; $$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'trigger LANGUAGE plpgsql AS\n  $$ BEGIN RETURN NULL; END; $$' at line 1")

-----------
QUERY:

CREATE TRIGGER ins_trig BEFORE INSERT ON pa_target
  FOR EACH ROW EXECUTE PROCEDURE trig_fn();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE trig_fn()' at line 2")

-----------
QUERY:

DO $$
DECLARE
  result integer;
BEGIN
MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid
  WHEN MATCHED THEN
    UPDATE SET tid = tid + 1, balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (sid, delta, 'inserted by merge');
GET DIAGNOSTICS result := ROW_COUNT;
RAISE NOTICE 'ROW_COUNT = %', result;
END;
$$;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'DECLARE\n  result integer;\nBEGIN\nMERGE INTO pa_target t\n  USING pa_source s\n  ON ' at line 2")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


-- test RLS enforcement
BEGIN;
RESULT:
	[]

-----------
QUERY:

ALTER TABLE pa_target ENABLE ROW LEVEL SECURITY;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ROW LEVEL SECURITY' at line 1")

-----------
QUERY:

ALTER TABLE pa_target FORCE ROW LEVEL SECURITY;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ROW LEVEL SECURITY' at line 1")

-----------
QUERY:

CREATE POLICY pa_target_pol ON pa_target USING (tid != 0);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'POLICY pa_target_pol ON pa_target USING (tid != 0)' at line 1")

-----------
QUERY:

MERGE INTO pa_target t
  USING pa_source s
  ON t.tid = s.sid AND t.tid IN (1,2,3,4)
  WHEN MATCHED THEN
    UPDATE SET tid = tid - 1;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO pa_target t\n  USING pa_source s\n  ON t.tid = s.sid AND t.tid IN (1,2,' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


DROP TABLE pa_source;
RESULT:
	[]

-----------
QUERY:

DROP TABLE pa_target CASCADE;
RESULT:
	ERROR - (1051, "Unknown table 'test.pa_target'")

-----------
QUERY:


-- Sub-partitioning
CREATE TABLE pa_target (logts timestamp, tid integer, balance float, val text)
	PARTITION BY RANGE (logts);
RESULT:
	ERROR - (1492, 'For RANGE partitions each partition must be defined')

-----------
QUERY:


CREATE TABLE part_m01 PARTITION OF pa_target
	FOR VALUES FROM ('2017-01-01') TO ('2017-02-01')
	PARTITION BY LIST (tid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF pa_target\n\tFOR VALUES FROM ('2017-01-01') TO ('2017-02-01')\n\tPARTITION BY LIS' at line 1")

-----------
QUERY:

CREATE TABLE part_m01_odd PARTITION OF part_m01
	FOR VALUES IN (1,3,5,7,9) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF part_m01\n\tFOR VALUES IN (1,3,5,7,9) WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:

CREATE TABLE part_m01_even PARTITION OF part_m01
	FOR VALUES IN (2,4,6,8) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF part_m01\n\tFOR VALUES IN (2,4,6,8) WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:

CREATE TABLE part_m02 PARTITION OF pa_target
	FOR VALUES FROM ('2017-02-01') TO ('2017-03-01')
	PARTITION BY LIST (tid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF pa_target\n\tFOR VALUES FROM ('2017-02-01') TO ('2017-03-01')\n\tPARTITION BY LIS' at line 1")

-----------
QUERY:

CREATE TABLE part_m02_odd PARTITION OF part_m02
	FOR VALUES IN (1,3,5,7,9) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF part_m02\n\tFOR VALUES IN (1,3,5,7,9) WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:

CREATE TABLE part_m02_even PARTITION OF part_m02
	FOR VALUES IN (2,4,6,8) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF part_m02\n\tFOR VALUES IN (2,4,6,8) WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:


CREATE TABLE pa_source (sid integer, delta float)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

-- insert many rows to the source table
INSERT INTO pa_source SELECT id, id * 10  FROM generate_series(1,14) AS id;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1,14) AS id' at line 2")

-----------
QUERY:

-- insert a few rows in the target table (odd numbered tid)
INSERT INTO pa_target SELECT '2017-01-31', id, id * 100, 'initial' FROM generate_series(1,9,3) AS id;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(1,9,3) AS id' at line 2")

-----------
QUERY:

INSERT INTO pa_target SELECT '2017-02-28', id, id * 100, 'initial' FROM generate_series(2,9,3) AS id;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(2,9,3) AS id' at line 1")

-----------
QUERY:


-- try simple MERGE
BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO pa_target t
  USING (SELECT '2017-01-15' AS slogts, * FROM pa_source WHERE sid < 10) s
  ON t.tid = s.sid
  WHEN MATCHED THEN
    UPDATE SET balance = balance + delta, val = val || ' updated by merge'
  WHEN NOT MATCHED THEN
    INSERT VALUES (slogts::timestamp, sid, delta, 'inserted by merge')
  RETURNING merge_action(), t.*;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO pa_target t\n  USING (SELECT '2017-01-15' AS slogts, * FROM pa_source ' at line 1")

-----------
QUERY:

SELECT * FROM pa_target ORDER BY tid;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


DROP TABLE pa_source;
RESULT:
	ERROR - (1051, "Unknown table 'test.pa_source'")

-----------
QUERY:

DROP TABLE pa_target CASCADE;
RESULT:
	ERROR - (1051, "Unknown table 'test.pa_target'")

-----------
QUERY:


-- Partitioned table with primary key

CREATE TABLE pa_target (tid integer PRIMARY KEY) PARTITION BY LIST (tid);
RESULT:
	ERROR - (1492, 'For LIST partitions each partition must be defined')

-----------
QUERY:

CREATE TABLE pa_targetp PARTITION OF pa_target DEFAULT;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'OF pa_target DEFAULT' at line 1")

-----------
QUERY:

CREATE TABLE pa_source (sid integer);
RESULT:
	[]

-----------
QUERY:


INSERT INTO pa_source VALUES (1), (2);
RESULT:
	[]

-----------
QUERY:


EXPLAIN (VERBOSE, COSTS OFF)
MERGE INTO pa_target t USING pa_source s ON t.tid = s.sid
  WHEN NOT MATCHED THEN INSERT VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'VERBOSE, COSTS OFF)\nMERGE INTO pa_target t USING pa_source s ON t.tid = s.sid\n  ' at line 1")

-----------
QUERY:


MERGE INTO pa_target t USING pa_source s ON t.tid = s.sid
  WHEN NOT MATCHED THEN INSERT VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO pa_target t USING pa_source s ON t.tid = s.sid\n  WHEN NOT MATCHED THE' at line 1")

-----------
QUERY:


TABLE pa_target;
RESULT:
	ERROR - (1146, "Table 'test.pa_target' doesn't exist")

-----------
QUERY:


-- Partition-less partitioned table
-- (the bug we are checking for appeared only if table had partitions before)

DROP TABLE pa_targetp;
RESULT:
	ERROR - (1051, "Unknown table 'test.pa_targetp'")

-----------
QUERY:


EXPLAIN (VERBOSE, COSTS OFF)
MERGE INTO pa_target t USING pa_source s ON t.tid = s.sid
  WHEN NOT MATCHED THEN INSERT VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'VERBOSE, COSTS OFF)\nMERGE INTO pa_target t USING pa_source s ON t.tid = s.sid\n  ' at line 1")

-----------
QUERY:


MERGE INTO pa_target t USING pa_source s ON t.tid = s.sid
  WHEN NOT MATCHED THEN INSERT VALUES (s.sid);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO pa_target t USING pa_source s ON t.tid = s.sid\n  WHEN NOT MATCHED THE' at line 1")

-----------
QUERY:


DROP TABLE pa_source;
RESULT:
	[]

-----------
QUERY:

DROP TABLE pa_target CASCADE;
RESULT:
	ERROR - (1051, "Unknown table 'test.pa_target'")

-----------
QUERY:


-- some complex joins on the source side

CREATE TABLE cj_target (tid integer, balance float, val text)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 4")

-----------
QUERY:

CREATE TABLE cj_source1 (sid1 integer, scat integer, delta integer)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

CREATE TABLE cj_source2 (sid2 integer, sval text)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 2")

-----------
QUERY:

INSERT INTO cj_source1 VALUES (1, 10, 100);
RESULT:
	ERROR - (1146, "Table 'test.cj_source1' doesn't exist")

-----------
QUERY:

INSERT INTO cj_source1 VALUES (1, 20, 200);
RESULT:
	ERROR - (1146, "Table 'test.cj_source1' doesn't exist")

-----------
QUERY:

INSERT INTO cj_source1 VALUES (2, 20, 300);
RESULT:
	ERROR - (1146, "Table 'test.cj_source1' doesn't exist")

-----------
QUERY:

INSERT INTO cj_source1 VALUES (3, 10, 400);
RESULT:
	ERROR - (1146, "Table 'test.cj_source1' doesn't exist")

-----------
QUERY:

INSERT INTO cj_source2 VALUES (1, 'initial source2');
RESULT:
	ERROR - (1146, "Table 'test.cj_source2' doesn't exist")

-----------
QUERY:

INSERT INTO cj_source2 VALUES (2, 'initial source2');
RESULT:
	ERROR - (1146, "Table 'test.cj_source2' doesn't exist")

-----------
QUERY:

INSERT INTO cj_source2 VALUES (3, 'initial source2');
RESULT:
	ERROR - (1146, "Table 'test.cj_source2' doesn't exist")

-----------
QUERY:


-- source relation is an unaliased join
MERGE INTO cj_target t
USING cj_source1 s1
	INNER JOIN cj_source2 s2 ON sid1 = sid2
ON t.tid = sid1
WHEN NOT MATCHED THEN
	INSERT VALUES (sid1, delta, sval);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO cj_target t\nUSING cj_source1 s1\n\tINNER JOIN cj_source2 s2 ON sid1 = s' at line 2")

-----------
QUERY:


-- try accessing columns from either side of the source join
MERGE INTO cj_target t
USING cj_source2 s2
	INNER JOIN cj_source1 s1 ON sid1 = sid2 AND scat = 20
ON t.tid = sid1
WHEN NOT MATCHED THEN
	INSERT VALUES (sid2, delta, sval)
WHEN MATCHED THEN
	DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO cj_target t\nUSING cj_source2 s2\n\tINNER JOIN cj_source1 s1 ON sid1 = s' at line 2")

-----------
QUERY:


-- some simple expressions in INSERT targetlist
MERGE INTO cj_target t
USING cj_source2 s2
	INNER JOIN cj_source1 s1 ON sid1 = sid2
ON t.tid = sid1
WHEN NOT MATCHED THEN
	INSERT VALUES (sid2, delta + scat, sval)
WHEN MATCHED THEN
	UPDATE SET val = val || ' updated by merge';
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO cj_target t\nUSING cj_source2 s2\n\tINNER JOIN cj_source1 s1 ON sid1 = s' at line 2")

-----------
QUERY:


MERGE INTO cj_target t
USING cj_source2 s2
	INNER JOIN cj_source1 s1 ON sid1 = sid2 AND scat = 20
ON t.tid = sid1
WHEN MATCHED THEN
	UPDATE SET val = val || ' ' || delta::text;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO cj_target t\nUSING cj_source2 s2\n\tINNER JOIN cj_source1 s1 ON sid1 = s' at line 1")

-----------
QUERY:


SELECT * FROM cj_target;
RESULT:
	ERROR - (1146, "Table 'test.cj_target' doesn't exist")

-----------
QUERY:


-- try it with an outer join and PlaceHolderVar
MERGE INTO cj_target t
USING (SELECT *, 'join input'::text AS phv FROM cj_source1) fj
	FULL JOIN cj_source2 fj2 ON fj.scat = fj2.sid2 * 10
ON t.tid = fj.scat
WHEN NOT MATCHED THEN
	INSERT (tid, balance, val) VALUES (fj.scat, fj.delta, fj.phv);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO cj_target t\nUSING (SELECT *, 'join input'::text AS phv FROM cj_source' at line 2")

-----------
QUERY:


SELECT * FROM cj_target;
RESULT:
	ERROR - (1146, "Table 'test.cj_target' doesn't exist")

-----------
QUERY:


ALTER TABLE cj_source1 RENAME COLUMN sid1 TO sid;
RESULT:
	ERROR - (1146, "Table 'test.cj_source1' doesn't exist")

-----------
QUERY:

ALTER TABLE cj_source2 RENAME COLUMN sid2 TO sid;
RESULT:
	ERROR - (1146, "Table 'test.cj_source2' doesn't exist")

-----------
QUERY:


TRUNCATE cj_target;
RESULT:
	ERROR - (1146, "Table 'test.cj_target' doesn't exist")

-----------
QUERY:


MERGE INTO cj_target t
USING cj_source1 s1
	INNER JOIN cj_source2 s2 ON s1.sid = s2.sid
ON t.tid = s1.sid
WHEN NOT MATCHED THEN
	INSERT VALUES (s2.sid, delta, sval);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO cj_target t\nUSING cj_source1 s1\n\tINNER JOIN cj_source2 s2 ON s1.sid =' at line 1")

-----------
QUERY:


DROP TABLE cj_source2, cj_source1, cj_target;
RESULT:
	ERROR - (1051, "Unknown table 'test.cj_source2,test.cj_source1,test.cj_target'")

-----------
QUERY:


-- Function scans
CREATE TABLE fs_target (a int, b int, c text)
  WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 3")

-----------
QUERY:

MERGE INTO fs_target t
USING generate_series(1,100,1) AS id
ON t.a = id
WHEN MATCHED THEN
	UPDATE SET b = b + id
WHEN NOT MATCHED THEN
	INSERT VALUES (id, -1);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO fs_target t\nUSING generate_series(1,100,1) AS id\nON t.a = id\nWHEN MAT' at line 1")

-----------
QUERY:


MERGE INTO fs_target t
USING generate_series(1,100,2) AS id
ON t.a = id
WHEN MATCHED THEN
	UPDATE SET b = b + id, c = 'updated '|| id.*::text
WHEN NOT MATCHED THEN
	INSERT VALUES (id, -1, 'inserted ' || id.*::text);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO fs_target t\nUSING generate_series(1,100,2) AS id\nON t.a = id\nWHEN MAT' at line 1")

-----------
QUERY:


SELECT count(*) FROM fs_target;
RESULT:
	ERROR - (1146, "Table 'test.fs_target' doesn't exist")

-----------
QUERY:

DROP TABLE fs_target;
RESULT:
	ERROR - (1051, "Unknown table 'test.fs_target'")

-----------
QUERY:


-- SERIALIZABLE test
-- handled in isolation tests

-- Inheritance-based partitioning
CREATE TABLE measurement (
    city_id         int not null,
    logdate         date not null,
    peaktemp        int,
    unitsales       int
) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 10")

-----------
QUERY:

CREATE TABLE measurement_y2006m02 (
    CHECK ( logdate >= DATE '2006-02-01' AND logdate < DATE '2006-03-01' )
) INHERITS (measurement) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'INHERITS (measurement) WITH (autovacuum_enabled=off)' at line 3")

-----------
QUERY:

CREATE TABLE measurement_y2006m03 (
    CHECK ( logdate >= DATE '2006-03-01' AND logdate < DATE '2006-04-01' )
) INHERITS (measurement) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'INHERITS (measurement) WITH (autovacuum_enabled=off)' at line 3")

-----------
QUERY:

CREATE TABLE measurement_y2007m01 (
    filler          text,
    peaktemp        int,
    logdate         date not null,
    city_id         int not null,
    unitsales       int
    CHECK ( logdate >= DATE '2007-01-01' AND logdate < DATE '2007-02-01')
) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '(autovacuum_enabled=off)' at line 8")

-----------
QUERY:

ALTER TABLE measurement_y2007m01 DROP COLUMN filler;
RESULT:
	ERROR - (1146, "Table 'test.measurement_y2007m01' doesn't exist")

-----------
QUERY:

ALTER TABLE measurement_y2007m01 INHERIT measurement;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'INHERIT measurement' at line 1")

-----------
QUERY:

INSERT INTO measurement VALUES (0, '2005-07-21', 5, 15);
RESULT:
	ERROR - (1146, "Table 'test.measurement' doesn't exist")

-----------
QUERY:


CREATE OR REPLACE FUNCTION measurement_insert_trigger()
RETURNS TRIGGER AS $$
BEGIN
    IF ( NEW.logdate >= DATE '2006-02-01' AND
         NEW.logdate < DATE '2006-03-01' ) THEN
        INSERT INTO measurement_y2006m02 VALUES (NEW.*);
    ELSIF ( NEW.logdate >= DATE '2006-03-01' AND
            NEW.logdate < DATE '2006-04-01' ) THEN
        INSERT INTO measurement_y2006m03 VALUES (NEW.*);
    ELSIF ( NEW.logdate >= DATE '2007-01-01' AND
            NEW.logdate < DATE '2007-02-01' ) THEN
        INSERT INTO measurement_y2007m01 (city_id, logdate, peaktemp, unitsales)
            VALUES (NEW.*);
    ELSE
        RAISE EXCEPTION 'Date out of range.  Fix the measurement_insert_trigger() function!';
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql ;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'FUNCTION measurement_insert_trigger()\nRETURNS TRIGGER AS $$\nBEGIN\n    IF ( NEW.l' at line 1")

-----------
QUERY:

CREATE TRIGGER insert_measurement_trigger
    BEFORE INSERT ON measurement
    FOR EACH ROW EXECUTE PROCEDURE measurement_insert_trigger();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'PROCEDURE measurement_insert_trigger()' at line 3")

-----------
QUERY:

INSERT INTO measurement VALUES (1, '2006-02-10', 35, 10);
RESULT:
	ERROR - (1146, "Table 'test.measurement' doesn't exist")

-----------
QUERY:

INSERT INTO measurement VALUES (1, '2006-02-16', 45, 20);
RESULT:
	ERROR - (1146, "Table 'test.measurement' doesn't exist")

-----------
QUERY:

INSERT INTO measurement VALUES (1, '2006-03-17', 25, 10);
RESULT:
	ERROR - (1146, "Table 'test.measurement' doesn't exist")

-----------
QUERY:

INSERT INTO measurement VALUES (1, '2006-03-27', 15, 40);
RESULT:
	ERROR - (1146, "Table 'test.measurement' doesn't exist")

-----------
QUERY:

INSERT INTO measurement VALUES (1, '2007-01-15', 10, 10);
RESULT:
	ERROR - (1146, "Table 'test.measurement' doesn't exist")

-----------
QUERY:

INSERT INTO measurement VALUES (1, '2007-01-17', 10, 10);
RESULT:
	ERROR - (1146, "Table 'test.measurement' doesn't exist")

-----------
QUERY:


SELECT tableoid::regclass, * FROM measurement ORDER BY city_id, logdate;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '::regclass, * FROM measurement ORDER BY city_id, logdate' at line 1")

-----------
QUERY:


CREATE TABLE new_measurement (LIKE measurement) WITH (autovacuum_enabled=off);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'WITH (autovacuum_enabled=off)' at line 1")

-----------
QUERY:

INSERT INTO new_measurement VALUES (0, '2005-07-21', 25, 20);
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:

INSERT INTO new_measurement VALUES (1, '2006-03-01', 20, 10);
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:

INSERT INTO new_measurement VALUES (1, '2006-02-16', 50, 10);
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:

INSERT INTO new_measurement VALUES (2, '2006-02-10', 20, 20);
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:

INSERT INTO new_measurement VALUES (1, '2006-03-27', NULL, NULL);
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:

INSERT INTO new_measurement VALUES (1, '2007-01-17', NULL, NULL);
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:

INSERT INTO new_measurement VALUES (1, '2007-01-15', 5, NULL);
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:

INSERT INTO new_measurement VALUES (1, '2007-01-16', 10, 10);
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO ONLY measurement m
 USING new_measurement nm ON
      (m.city_id = nm.city_id and m.logdate=nm.logdate)
WHEN MATCHED AND nm.peaktemp IS NULL THEN DELETE
WHEN MATCHED THEN UPDATE
     SET peaktemp = greatest(m.peaktemp, nm.peaktemp),
        unitsales = m.unitsales + coalesce(nm.unitsales, 0)
WHEN NOT MATCHED THEN INSERT
     (city_id, logdate, peaktemp, unitsales)
   VALUES (city_id, logdate, peaktemp, unitsales);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO ONLY measurement m\n USING new_measurement nm ON\n      (m.city_id = nm' at line 1")

-----------
QUERY:


SELECT tableoid::regclass, * FROM measurement ORDER BY city_id, logdate, peaktemp;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '::regclass, * FROM measurement ORDER BY city_id, logdate, peaktemp' at line 1")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


MERGE into measurement m
 USING new_measurement nm ON
      (m.city_id = nm.city_id and m.logdate=nm.logdate)
WHEN MATCHED AND nm.peaktemp IS NULL THEN DELETE
WHEN MATCHED THEN UPDATE
     SET peaktemp = greatest(m.peaktemp, nm.peaktemp),
        unitsales = m.unitsales + coalesce(nm.unitsales, 0)
WHEN NOT MATCHED THEN INSERT
     (city_id, logdate, peaktemp, unitsales)
   VALUES (city_id, logdate, peaktemp, unitsales);
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE into measurement m\n USING new_measurement nm ON\n      (m.city_id = nm.city' at line 1")

-----------
QUERY:


SELECT tableoid::regclass, * FROM measurement ORDER BY city_id, logdate;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '::regclass, * FROM measurement ORDER BY city_id, logdate' at line 1")

-----------
QUERY:


BEGIN;
RESULT:
	[]

-----------
QUERY:

MERGE INTO new_measurement nm
 USING ONLY measurement m ON
      (nm.city_id = m.city_id and nm.logdate=m.logdate)
WHEN MATCHED THEN DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO new_measurement nm\n USING ONLY measurement m ON\n      (nm.city_id = m' at line 1")

-----------
QUERY:


SELECT * FROM new_measurement ORDER BY city_id, logdate;
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:

ROLLBACK;
RESULT:
	[]

-----------
QUERY:


MERGE INTO new_measurement nm
 USING measurement m ON
      (nm.city_id = m.city_id and nm.logdate=m.logdate)
WHEN MATCHED THEN DELETE;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'MERGE INTO new_measurement nm\n USING measurement m ON\n      (nm.city_id = m.city' at line 1")

-----------
QUERY:


SELECT * FROM new_measurement ORDER BY city_id, logdate;
RESULT:
	ERROR - (1146, "Table 'test.new_measurement' doesn't exist")

-----------
QUERY:


DROP TABLE measurement, new_measurement CASCADE;
RESULT:
	ERROR - (1051, "Unknown table 'test.measurement,test.new_measurement'")

-----------
QUERY:

DROP FUNCTION measurement_insert_trigger();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '()' at line 1")

-----------
QUERY:


-- prepare

RESET SESSION AUTHORIZATION;
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'SESSION AUTHORIZATION' at line 3")

-----------
QUERY:

DROP TABLE target, target2;
RESULT:
	ERROR - (1051, "Unknown table 'test.target,test.target2'")

-----------
QUERY:

DROP TABLE source, source2;
RESULT:
	ERROR - (1051, "Unknown table 'test.source,test.source2'")

-----------
QUERY:

DROP FUNCTION merge_trigfunc();
RESULT:
	ERROR - (1064, "You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '()' at line 1")

-----------
QUERY:

DROP USER regress_merge_privs;
RESULT:
	[]

-----------
QUERY:

DROP USER regress_merge_no_privs;
RESULT:
	[]

-----------
QUERY:

DROP USER regress_merge_none;
RESULT:
	[]
