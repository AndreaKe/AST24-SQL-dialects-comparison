
-----------
QUERY:
CREATE TABLE test_replica_identity (
       id serial primary key,
       keya text not null,
       keyb text not null,
       nonkey text,
       CONSTRAINT test_replica_identity_unique_defer UNIQUE (keya, keyb) DEFERRABLE,
       CONSTRAINT test_replica_identity_unique_nondefer UNIQUE (keya, keyb)
)
RESULT:
	duckdb: Catalog Error: Type with name serial does not exist!
Did you mean "real"?

-----------
QUERY:
CREATE TABLE test_replica_identity_othertable (id serial primary key)
RESULT:
	duckdb: Catalog Error: Type with name serial does not exist!
Did you mean "real"?

-----------
QUERY:
CREATE TABLE test_replica_identity_t3 (id serial constraint pk primary key deferrable)
RESULT:
	duckdb: Not implemented Error: Constraint not implemented!

-----------
QUERY:
CREATE INDEX test_replica_identity_keyab ON test_replica_identity (keya, keyb)
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity does not exist!
Did you mean "TEXT_TBL"?

-----------
QUERY:
CREATE UNIQUE INDEX test_replica_identity_keyab_key ON test_replica_identity (keya, keyb)
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity does not exist!
Did you mean "TEXT_TBL"?

-----------
QUERY:
CREATE UNIQUE INDEX test_replica_identity_nonkey ON test_replica_identity (keya, nonkey)
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity does not exist!
Did you mean "TEXT_TBL"?

-----------
QUERY:
CREATE INDEX test_replica_identity_hash ON test_replica_identity USING hash (nonkey)
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity does not exist!
Did you mean "TEXT_TBL"?

-----------
QUERY:
CREATE UNIQUE INDEX test_replica_identity_expr ON test_replica_identity (keya, keyb, (3))
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity does not exist!
Did you mean "TEXT_TBL"?

-----------
QUERY:
CREATE UNIQUE INDEX test_replica_identity_partial ON test_replica_identity (keya, keyb) WHERE keyb != '3'
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity does not exist!
Did you mean "TEXT_TBL"?

-----------
QUERY:
-- default is /* REPLACED */''d/* REPLACED */''/DEFAULT for user created tables
SELECT relreplident FROM pg_class WHERE oid = 'test_replica_identity'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
-- but /* REPLACED */''none/* REPLACED */'' for system tables
SELECT relreplident FROM pg_class WHERE oid = 'pg_class'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
SELECT relreplident FROM pg_class WHERE oid = 'pg_constraint'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
----
-- Make sure we detect ineligible indexes
----

-- fail, not unique
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_keyab
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- fail, not a candidate key, nullable column
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_nonkey
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- fail, hash indexes cannot do uniqueness
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_hash
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- fail, expression index
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_expr
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- fail, partial index
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_partial
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- fail, not our index
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_othertable_pkey
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- fail, deferrable
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_unique_defer
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- fail, deferrable
ALTER TABLE test_replica_identity_t3 REPLICA IDENTITY USING INDEX pk
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
SELECT relreplident FROM pg_class WHERE oid = 'test_replica_identity'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
----
-- Make sure index cases succeed
----

-- succeed, primary key
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_pkey
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
SELECT relreplident FROM pg_class WHERE oid = 'test_replica_identity'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
-- \d test_replica_identity

-- succeed, nondeferrable unique constraint over nonnullable cols
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_unique_nondefer
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- succeed unique index over nonnullable cols
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_keyab_key
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
ALTER TABLE test_replica_identity REPLICA IDENTITY USING INDEX test_replica_identity_keyab_key
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
SELECT relreplident FROM pg_class WHERE oid = 'test_replica_identity'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
-- \d test_replica_identity
SELECT count(*) FROM pg_index WHERE indrelid = 'test_replica_identity'::regclass AND indisreplident
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
----
-- Make sure non index cases work
----
ALTER TABLE test_replica_identity REPLICA IDENTITY DEFAULT
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
SELECT relreplident FROM pg_class WHERE oid = 'test_replica_identity'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
SELECT count(*) FROM pg_index WHERE indrelid = 'test_replica_identity'::regclass AND indisreplident
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
ALTER TABLE test_replica_identity REPLICA IDENTITY FULL
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
SELECT relreplident FROM pg_class WHERE oid = 'test_replica_identity'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
-- \d+ test_replica_identity
ALTER TABLE test_replica_identity REPLICA IDENTITY NOTHING
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
SELECT relreplident FROM pg_class WHERE oid = 'test_replica_identity'::regclass
RESULT:
	duckdb: Catalog Error: Type with name regclass does not exist!
Did you mean "real"?

-----------
QUERY:
---
-- Test that ALTER TABLE rewrite preserves nondefault replica identity
---

-- constraint variant
CREATE TABLE test_replica_identity2 (id int UNIQUE NOT NULL)
RESULT:
	duckdb: None

-----------
QUERY:
ALTER TABLE test_replica_identity2 REPLICA IDENTITY USING INDEX test_replica_identity2_id_key
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- \d test_replica_identity2
ALTER TABLE test_replica_identity2 ALTER COLUMN id TYPE bigint
RESULT:
	duckdb: Binder Error: Cannot change the type of a column that has a UNIQUE or PRIMARY KEY constraint specified

-----------
QUERY:
-- \d test_replica_identity2

-- straight index variant
CREATE TABLE test_replica_identity3 (id int NOT NULL)
RESULT:
	duckdb: None

-----------
QUERY:
CREATE UNIQUE INDEX test_replica_identity3_id_key ON test_replica_identity3 (id)
RESULT:
	duckdb: None

-----------
QUERY:
ALTER TABLE test_replica_identity3 REPLICA IDENTITY USING INDEX test_replica_identity3_id_key
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
-- \d test_replica_identity3
ALTER TABLE test_replica_identity3 ALTER COLUMN id TYPE bigint
RESULT:
	duckdb: Catalog Error: Cannot change the type of this column: an index depends on it!

-----------
QUERY:
-- \d test_replica_identity3

-- ALTER TABLE DROP NOT NULL is not allowed for columns part of an index
-- used as replica identity.
ALTER TABLE test_replica_identity3 ALTER COLUMN id DROP NOT NULL
RESULT:
	duckdb: Cannot alter entry "test_replica_identity3" because there are entries that depend on it.

-----------
QUERY:
-- but it/* REPLACED */''s OK when the identity is FULL
ALTER TABLE test_replica_identity3 REPLICA IDENTITY FULL
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
ALTER TABLE test_replica_identity3 ALTER COLUMN id DROP NOT NULL
RESULT:
	duckdb: Cannot alter entry "test_replica_identity3" because there are entries that depend on it.

-----------
QUERY:
--
-- Test that replica identity can be set on an index that/* REPLACED */''s not yet valid.
-- (This matches the way pg_dump will try to dump a partitioned table.)
--
CREATE TABLE test_replica_identity4(id integer NOT NULL) PARTITION BY LIST (id)
RESULT:
	duckdb: Parser Error: syntax error at or near "PARTITION"

-----------
QUERY:
CREATE TABLE test_replica_identity4_1(id integer NOT NULL)
RESULT:
	duckdb: None

-----------
QUERY:
ALTER TABLE ONLY test_replica_identity4
  ATTACH PARTITION test_replica_identity4_1 FOR VALUES IN (1)
RESULT:
	duckdb: Parser Error: syntax error at or near "ATTACH"

-----------
QUERY:
ALTER TABLE ONLY test_replica_identity4
  ADD CONSTRAINT test_replica_identity4_pkey PRIMARY KEY (id)
RESULT:
	duckdb: Not implemented Error: No support for that ALTER TABLE option yet!

-----------
QUERY:
ALTER TABLE ONLY test_replica_identity4
  REPLICA IDENTITY USING INDEX test_replica_identity4_pkey
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
ALTER TABLE ONLY test_replica_identity4_1
  ADD CONSTRAINT test_replica_identity4_1_pkey PRIMARY KEY (id)
RESULT:
	duckdb: Not implemented Error: No support for that ALTER TABLE option yet!

-----------
QUERY:
-- \d+ test_replica_identity4
ALTER INDEX test_replica_identity4_pkey
  ATTACH PARTITION test_replica_identity4_1_pkey
RESULT:
	duckdb: Parser Error: syntax error at or near "ATTACH"

-----------
QUERY:
-- \d+ test_replica_identity4

-- Dropping the primary key is not allowed if that would leave the replica
-- identity as nullable
CREATE TABLE test_replica_identity5 (a int not null, b int, c int,
	PRIMARY KEY (b, c))
RESULT:
	duckdb: None

-----------
QUERY:
CREATE UNIQUE INDEX test_replica_identity5_a_b_key ON test_replica_identity5 (a, b)
RESULT:
	duckdb: None

-----------
QUERY:
ALTER TABLE test_replica_identity5 REPLICA IDENTITY USING INDEX test_replica_identity5_a_b_key
RESULT:
	duckdb: Parser Error: syntax error at or near "REPLICA"

-----------
QUERY:
ALTER TABLE test_replica_identity5 DROP CONSTRAINT test_replica_identity5_pkey
RESULT:
	duckdb: Not implemented Error: No support for that ALTER TABLE option yet!

-----------
QUERY:
ALTER TABLE test_replica_identity5 ALTER b SET NOT NULL
RESULT:
	duckdb: Cannot alter entry "test_replica_identity5" because there are entries that depend on it.

-----------
QUERY:
ALTER TABLE test_replica_identity5 DROP CONSTRAINT test_replica_identity5_pkey
RESULT:
	duckdb: Not implemented Error: No support for that ALTER TABLE option yet!

-----------
QUERY:
ALTER TABLE test_replica_identity5 ALTER b DROP NOT NULL
RESULT:
	duckdb: Cannot alter entry "test_replica_identity5" because there are entries that depend on it.

-----------
QUERY:
DROP TABLE test_replica_identity
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity does not exist!
Did you mean "test_replica_identity2"?

-----------
QUERY:
DROP TABLE test_replica_identity2
RESULT:
	duckdb: None

-----------
QUERY:
DROP TABLE test_replica_identity3
RESULT:
	duckdb: None

-----------
QUERY:
DROP TABLE test_replica_identity4
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity4 does not exist!
Did you mean "test_replica_identity4_1"?

-----------
QUERY:
DROP TABLE test_replica_identity5
RESULT:
	duckdb: None

-----------
QUERY:
DROP TABLE test_replica_identity_othertable
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity_othertable does not exist!
Did you mean "test_replica_identity4_1"?

-----------
QUERY:
DROP TABLE test_replica_identity_t3
RESULT:
	duckdb: Catalog Error: Table with name test_replica_identity_t3 does not exist!
Did you mean "test_replica_identity4_1"?
