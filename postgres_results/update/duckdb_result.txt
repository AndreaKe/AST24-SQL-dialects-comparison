--
-- UPDATE syntax tests
--

CREATE TABLE update_test (
    a   INT DEFAULT 10,
    b   INT,
    c   TEXT
)


CREATE TABLE upsert_test (
    a   INT PRIMARY KEY,
    b   TEXT
)


INSERT INTO update_test VALUES (5, 10, 'foo')

INSERT INTO update_test(b, a) VALUES (15, 10)


SELECT * FROM update_test
RESULT: 
	[(5, 10, 'foo'), (10, 15, None)]


UPDATE update_test SET a = DEFAULT, b = DEFAULT


SELECT * FROM update_test
RESULT: 
	[(10, None, 'foo'), (10, None, None)]


-- aliases for the UPDATE target table
UPDATE update_test AS t SET b = 10 WHERE t.a = 10


SELECT * FROM update_test
RESULT: 
	[(10, 10, 'foo'), (10, 10, None)]


UPDATE update_test t SET b = t.b + 10 WHERE t.a = 10


SELECT * FROM update_test
RESULT: 
	[(10, 20, 'foo'), (10, 20, None)]


-- error, you''re not supposed to qualify the target column
UPDATE update_test t SET t.b = t.b + 10 WHERE t.a = 10
ERROR: 

-- error, you''re not supposed to qualify the target column
UPDATE update_test t SET t.b = t.b + 10 WHERE t.a = 10

Binder Error: Referenced update column t not found in table!


--
-- Test VALUES in FROM
--

UPDATE update_test SET a=v.i FROM (VALUES(100, 20)) AS v(i, j)
  WHERE update_test.b = v.j


SELECT * FROM update_test
RESULT: 
	[(100, 20, 'foo'), (100, 20, None)]


-- fail, wrong data type:
UPDATE update_test SET a = v.* FROM (VALUES(100, 20)) AS v(i, j)
  WHERE update_test.b = v.j
ERROR: 

-- fail, wrong data type:
UPDATE update_test SET a = v.* FROM (VALUES(100, 20)) AS v(i, j)
  WHERE update_test.b = v.j

Binder Error: STAR expression is not supported here
LINE 4: UPDATE update_test SET a = v.* FROM (VALUES(100, 20)) AS v(i, j)
                                   ^


--
-- Test multiple-set-clause syntax
--

INSERT INTO update_test SELECT a,b+1,c FROM update_test

SELECT * FROM update_test
RESULT: 
	[(100, 20, 'foo'), (100, 20, None), (100, 21, 'foo'), (100, 21, None)]


UPDATE update_test SET (c,b,a) = ('bugle', b+11, DEFAULT) WHERE c = 'foo'

SELECT * FROM update_test
RESULT: 
	[(10, 31, 'bugle'), (100, 20, None), (10, 32, 'bugle'), (100, 21, None)]

UPDATE update_test SET (c,b) = ('car', a+b), a = a + 1 WHERE a = 10

SELECT * FROM update_test
RESULT: 
	[(11, 41, 'car'), (100, 20, None), (11, 42, 'car'), (100, 21, None)]

-- fail, multi assignment to same column:
UPDATE update_test SET (c,b) = ('car', a+b), b = a + 1 WHERE a = 10
ERROR: 
-- fail, multi assignment to same column:
UPDATE update_test SET (c,b) = ('car', a+b), b = a + 1 WHERE a = 10

Binder Error: Multiple assignments to same column "b"


-- uncorrelated sub-select:
UPDATE update_test
  SET (b,a) = (select a,b from update_test where b = 41 and c = 'car')
  WHERE a = 100 AND b = 20
ERROR: 

-- uncorrelated sub-select:
UPDATE update_test
  SET (b,a) = (select a,b from update_test where b = 41 and c = 'car')
  WHERE a = 100 AND b = 20

Binder Error: Subquery returns 2 columns - expected 1
LINE 5:   SE...
                      ^

SELECT * FROM update_test
RESULT: 
	[(11, 41, 'car'), (100, 20, None), (11, 42, 'car'), (100, 21, None)]

-- correlated sub-select:
UPDATE update_test o
  SET (b,a) = (select a+1,b from update_test i
               where i.a=o.a and i.b=o.b and i.c is not distinct from o.c)
ERROR: 
-- correlated sub-select:
UPDATE update_test o
  SET (b,a) = (select a+1,b from update_test i
               where i.a=o.a and i.b=o.b and i.c is not distinct from o.c)

Binder Error: Subquery returns 2 columns - expected 1
LINE 4:   SET (b,a) = (select a+1,b from update_test i
                      ^

SELECT * FROM update_test
RESULT: 
	[(11, 41, 'car'), (100, 20, None), (11, 42, 'car'), (100, 21, None)]

-- fail, multiple rows supplied:
UPDATE update_test SET (b,a) = (select a+1,b from update_test)
ERROR: 
-- fail, multiple rows supplied:
UPDATE update_test SET (b,a) = (select a+1,b from update_test)

Binder Error: Subquery returns 2 columns - expected 1
LINE 3: UPDATE update_test SET (b,a) = (select a+1,b from update_test)
                                       ^

-- set to null if no rows supplied:
UPDATE update_test SET (b,a) = (select a+1,b from update_test where a = 1000)
  WHERE a = 11
ERROR: 
-- set to null if no rows supplied:
UPDATE update_test SET (b,a) = (select a+1,b from update_test where a = 1000)
  WHERE a = 11

Binder Error: Subquery returns 2 columns - expected 1
LINE 3: UPDATE update_test SET (b,a) = (s...
                                       ^

SELECT * FROM update_test
RESULT: 
	[(11, 41, 'car'), (100, 20, None), (11, 42, 'car'), (100, 21, None)]

-- *-expansion should work in this context:
UPDATE update_test SET (a,b) = ROW(v.*) FROM (VALUES(21, 100)) AS v(i, j)
  WHERE update_test.a = v.i
ERROR: 
-- *-expansion should work in this context:
UPDATE update_test SET (a,b) = ROW(v.*) FROM (VALUES(21, 100)) AS v(i, j)
  WHERE update_test.a = v.i

Parser Error: Could not perform multiple assignment, target expects 2 values, only 1 were provided

-- you might expect this to work, but syntactically it''s not a RowExpr:
UPDATE update_test SET (a,b) = (v.*) FROM (VALUES(21, 101)) AS v(i, j)
  WHERE update_test.a = v.i
ERROR: 
-- you might expect this to work, but syntactically it''s not a RowExpr:
UPDATE update_test SET (a,b) = (v.*) FROM (VALUES(21, 101)) AS v(i, j)
  WHERE update_test.a = v.i

Binder Error: STAR expression is not supported here
LINE 3: UPDATE update_test SET (a,b) = (v.*) FROM (VALUES(21, 101)) AS v(i, j)
                                        ^


-- if an alias for the target table is specified, don''t allow references
-- to the original table name
UPDATE update_test AS t SET b = update_test.b + 10 WHERE t.a = 10
ERROR: 

-- if an alias for the target table is specified, don''t allow references
-- to the original table name
UPDATE update_test AS t SET b = update_test.b + 10 WHERE t.a = 10

Binder Error: Referenced table "update_test" not found!
Candidate tables: "t"
LINE 5: UPDATE update_test AS t SET b = update_test.b + 10 WHERE t.a = 10
                                        ^


-- Make sure that we can update to a TOASTed value.
UPDATE update_test SET c = repeat('x', 10000) WHERE c = 'car'

SELECT a, b, char_length(c) FROM update_test
ERROR: 
SELECT a, b, char_length(c) FROM update_test

Catalog Error: Scalar Function with name char_length does not exist!
Did you mean "array_length"?


-- Check multi-assignment with a Result node to handle a one-time filter.
EXPLAIN (VERBOSE, COSTS OFF)
UPDATE update_test t
  SET (a, b) = (SELECT b, a FROM update_test s WHERE s.a = t.a)
  WHERE CURRENT_USER = SESSION_USER
ERROR: 

-- Check multi-assignment with a Result node to handle a one-time filter.
EXPLAIN (VERBOSE, COSTS OFF)
UPDATE update_test t
  SET (a, b) = (SELECT b, a FROM update_test s WHERE s.a = t.a)
  WHERE CURRENT_USER = SESSION_USER

Not implemented Error: Unimplemented explain type: VERBOSE

UPDATE update_test t
  SET (a, b) = (SELECT b, a FROM update_test s WHERE s.a = t.a)
  WHERE CURRENT_USER = SESSION_USER
ERROR: 
UPDATE update_test t
  SET (a, b) = (SELECT b, a FROM update_test s WHERE s.a = t.a)
  WHERE CURRENT_USER = SESSION_USER

Binder Error: Subquery returns 2 columns - expected 1
LINE 3:   SET (a, b) = (SELECT b, a FROM...
                       ^

SELECT a, b, char_length(c) FROM update_test
ERROR: 
SELECT a, b, char_length(c) FROM update_test

Catalog Error: Scalar Function with name char_length does not exist!
Did you mean "array_length"?


-- Test ON CONFLICT DO UPDATE

INSERT INTO upsert_test VALUES(1, 'Boo'), (3, 'Zoo')

-- uncorrelated  sub-select:
WITH aaa AS (SELECT 1 AS a, 'Foo' AS b) INSERT INTO upsert_test
  VALUES (1, 'Bar') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b, a FROM aaa) RETURNING *
ERROR: 
-- uncorrelated  sub-select:
WITH aaa AS (SELECT 1 AS a, 'Foo' AS b) INSERT INTO upsert_test
  VALUES (1, 'Bar') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b, a FROM aaa) RETURNING *

Binder Error: Subquery returns 2 columns - expected 1
LINE 5:   DO UPDATE SET (b, a) = (SELECT b, a FROM aaa) RETURNING *
                                 ^

-- correlated sub-select:
INSERT INTO upsert_test VALUES (1, 'Baz'), (3, 'Zaz') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b || ', Correlated', a from upsert_test i WHERE i.a = upsert_test.a)
  RETURNING *
ERROR: 
-- correlated sub-select:
INSERT INTO upsert_test VALUES (1, 'Baz'), (3, 'Zaz') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b || ', Correlated', a from upsert_test i WHERE i.a = upsert_test.a)
  RETURNING *

Binder Error: Subquery returns 2 columns - expected 1
LINE 4:   DO UPDATE SET (b, a) = (SELECT b || ', Correlated', a from upsert_test i WHERE i.a = upsert_test.a)
  RETURNING *
...
                                 ^

-- correlated sub-select (EXCLUDED.* alias):
INSERT INTO upsert_test VALUES (1, 'Bat'), (3, 'Zot') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING *
ERROR: 
-- correlated sub-select (EXCLUDED.* alias):
INSERT INTO upsert_test VALUES (1, 'Bat'), (3, 'Zot') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING *

Binder Error: Subquery returns 2 columns - expected 1
LINE 4:   DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING *
...
                                 ^


-- ON CONFLICT using system attributes in RETURNING, testing both the
-- inserting and updating paths. See bug report at:
-- https://www.postgresql.org/message-id/73436355-6432-49B1-92ED-1FE4F7E7E100%40finefun.com.au
INSERT INTO upsert_test VALUES (2, 'Beeble') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING tableoid::regclass, xmin = pg_current_xact_id()::xid AS xmin_correct, xmax = 0 AS xmax_correct
ERROR: 

-- ON CONFLICT using system attributes in RETURNING, testing both the
-- inserting and updating paths. See bug report at:
-- https://www.postgresql.org/message-id/73436355-6432-49B1-92ED-1FE4F7E7E100%40finefun.com.au
INSERT INTO upsert_test VALUES (2, 'Beeble') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING tableoid::regclass, xmin = pg_current_xact_id()::xid AS xmin_correct, xmax = 0 AS xmax_correct

Binder Error: Subquery returns 2 columns - expected 1
LINE 7:   DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING tableoid::regclass, xmin = pg_current_xact_id()::xid AS xmin_correct, xmax = 0 AS xmax_correct
...
                                 ^

-- currently xmax is set after a conflict - that''s probably not good,
-- but it seems worthwhile to have to be explicit if that changes.
INSERT INTO upsert_test VALUES (2, 'Brox') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING tableoid::regclass, xmin = pg_current_xact_id()::xid AS xmin_correct, xmax = pg_current_xact_id()::xid AS xmax_correct
ERROR: 
-- currently xmax is set after a conflict - that''s probably not good,
-- but it seems worthwhile to have to be explicit if that changes.
INSERT INTO upsert_test VALUES (2, 'Brox') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING tableoid::regclass, xmin = pg_current_xact_id()::xid AS xmin_correct, xmax = pg_current_xact_id()::xid AS xmax_correct

Binder Error: Subquery returns 2 columns - expected 1
LINE 5:   DO UPDATE SET (b, a) = (SELECT b || ', Excluded', a from upsert_test i WHERE i.a = excluded.a)
  RETURNING tableoid::regclass, xmin = pg_current_xact_id()::xid AS xmin_correct, xmax = pg_current_xact_id()::xid AS xmax_correct
...
                                 ^


DROP TABLE update_test

DROP TABLE upsert_test


-- Test ON CONFLICT DO UPDATE with partitioned table and non-identical children

CREATE TABLE upsert_test (
    a   INT PRIMARY KEY,
    b   TEXT
) PARTITION BY LIST (a)
ERROR: 

-- Test ON CONFLICT DO UPDATE with partitioned table and non-identical children

CREATE TABLE upsert_test (
    a   INT PRIMARY KEY,
    b   TEXT
) PARTITION BY LIST (a)

Parser Error: syntax error at or near "PARTITION"


CREATE TABLE upsert_test_1 PARTITION OF upsert_test FOR VALUES IN (1)
ERROR: 

CREATE TABLE upsert_test_1 PARTITION OF upsert_test FOR VALUES IN (1)

Parser Error: syntax error at or near "PARTITION"

CREATE TABLE upsert_test_2 (b TEXT, a INT PRIMARY KEY)

ALTER TABLE upsert_test ATTACH PARTITION upsert_test_2 FOR VALUES IN (2)
ERROR: 
ALTER TABLE upsert_test ATTACH PARTITION upsert_test_2 FOR VALUES IN (2)

Parser Error: syntax error at or near "ATTACH"


INSERT INTO upsert_test VALUES(1, 'Boo'), (2, 'Zoo')
ERROR: 

INSERT INTO upsert_test VALUES(1, 'Boo'), (2, 'Zoo')

Catalog Error: Table with name upsert_test does not exist!
Did you mean "upsert_test_2"?

-- uncorrelated sub-select:
WITH aaa AS (SELECT 1 AS a, 'Foo' AS b) INSERT INTO upsert_test
  VALUES (1, 'Bar') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b, a FROM aaa) RETURNING *
ERROR: 
-- uncorrelated sub-select:
WITH aaa AS (SELECT 1 AS a, 'Foo' AS b) INSERT INTO upsert_test
  VALUES (1, 'Bar') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT b, a FROM aaa) RETURNING *

Catalog Error: Table with name upsert_test does not exist!
Did you mean "upsert_test_2"?

-- correlated sub-select:
WITH aaa AS (SELECT 1 AS ctea, ' Foo' AS cteb) INSERT INTO upsert_test
  VALUES (1, 'Bar'), (2, 'Baz') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT upsert_test.b||cteb, upsert_test.a FROM aaa) RETURNING *
ERROR: 
-- correlated sub-select:
WITH aaa AS (SELECT 1 AS ctea, ' Foo' AS cteb) INSERT INTO upsert_test
  VALUES (1, 'Bar'), (2, 'Baz') ON CONFLICT(a)
  DO UPDATE SET (b, a) = (SELECT upsert_test.b||cteb, upsert_test.a FROM aaa) RETURNING *

Catalog Error: Table with name upsert_test does not exist!
Did you mean "upsert_test_2"?


DROP TABLE upsert_test
ERROR: 

DROP TABLE upsert_test

Catalog Error: Table with name upsert_test does not exist!
Did you mean "upsert_test_2"?



---------------------------
-- UPDATE with row movement
---------------------------

-- When a partitioned table receives an UPDATE to the partitioned key and the
-- new values no longer meet the partition''s bound, the row must be moved to
-- the correct partition for the new partition key (if one exists). We must
-- also ensure that updatable views on partitioned tables properly enforce any
-- WITH CHECK OPTION that is defined. The situation with triggers in this case
-- also requires thorough testing as partition key updates causing row
-- movement convert UPDATEs into DELETE+INSERT.

CREATE TABLE range_parted (
	a text,
	b bigint,
	c numeric,
	d int,
	e varchar
) PARTITION BY RANGE (a, b)
ERROR: 


---------------------------
-- UPDATE with row movement
---------------------------

-- When a partitioned table receives an UPDATE to the partitioned key and the
-- new values no longer meet the partition''s bound, the row must be moved to
-- the correct partition for the new partition key (if one exists). We must
-- also ensure that updatable views on partitioned tables properly enforce any
-- WITH CHECK OPTION that is defined. The situation with triggers in this case
-- also requires thorough testing as partition key updates causing row
-- movement convert UPDATEs into DELETE+INSERT.

CREATE TABLE range_parted (
	a text,
	b bigint,
	c numeric,
	d int,
	e varchar
) PARTITION BY RANGE (a, b)

Parser Error: syntax error at or near "PARTITION"


-- Create partitions intentionally in descending bound order, so as to test
-- that update-row-movement works with the leaf partitions not in bound order.
CREATE TABLE part_b_20_b_30 (e varchar, c numeric, a text, b bigint, d int)

ALTER TABLE range_parted ATTACH PARTITION part_b_20_b_30 FOR VALUES FROM ('b', 20) TO ('b', 30)
ERROR: 
ALTER TABLE range_parted ATTACH PARTITION part_b_20_b_30 FOR VALUES FROM ('b', 20) TO ('b', 30)

Parser Error: syntax error at or near "ATTACH"

CREATE TABLE part_b_10_b_20 (e varchar, c numeric, a text, b bigint, d int) PARTITION BY RANGE (c)
ERROR: 
CREATE TABLE part_b_10_b_20 (e varchar, c numeric, a text, b bigint, d int) PARTITION BY RANGE (c)

Parser Error: syntax error at or near "PARTITION"

CREATE TABLE part_b_1_b_10 PARTITION OF range_parted FOR VALUES FROM ('b', 1) TO ('b', 10)
ERROR: 
CREATE TABLE part_b_1_b_10 PARTITION OF range_parted FOR VALUES FROM ('b', 1) TO ('b', 10)

Parser Error: syntax error at or near "PARTITION"

ALTER TABLE range_parted ATTACH PARTITION part_b_10_b_20 FOR VALUES FROM ('b', 10) TO ('b', 20)
ERROR: 
ALTER TABLE range_parted ATTACH PARTITION part_b_10_b_20 FOR VALUES FROM ('b', 10) TO ('b', 20)

Parser Error: syntax error at or near "ATTACH"

CREATE TABLE part_a_10_a_20 PARTITION OF range_parted FOR VALUES FROM ('a', 10) TO ('a', 20)
ERROR: 
CREATE TABLE part_a_10_a_20 PARTITION OF range_parted FOR VALUES FROM ('a', 10) TO ('a', 20)

Parser Error: syntax error at or near "PARTITION"

CREATE TABLE part_a_1_a_10 PARTITION OF range_parted FOR VALUES FROM ('a', 1) TO ('a', 10)
ERROR: 
CREATE TABLE part_a_1_a_10 PARTITION OF range_parted FOR VALUES FROM ('a', 1) TO ('a', 10)

Parser Error: syntax error at or near "PARTITION"


-- Check that partition-key UPDATE works sanely on a partitioned table that
-- does not have any child partitions.
UPDATE part_b_10_b_20 set b = b - 6
ERROR: 

-- Check that partition-key UPDATE works sanely on a partitioned table that
-- does not have any child partitions.
UPDATE part_b_10_b_20 set b = b - 6

Catalog Error: Table with name part_b_10_b_20 does not exist!
Did you mean "part_b_20_b_30"?
LINE 5: UPDATE part_b_10_b_20 set b = b - 6
               ^


-- Create some more partitions following the above pattern of descending bound
-- order, but let''s make the situation a bit more complex by having the
-- attribute numbers of the columns vary from their parent partition.
CREATE TABLE part_c_100_200 (e varchar, c numeric, a text, b bigint, d int) PARTITION BY range (abs(d))
ERROR: 

-- Create some more partitions following the above pattern of descending bound
-- order, but let''s make the situation a bit more complex by having the
-- attribute numbers of the columns vary from their parent partition.
CREATE TABLE part_c_100_200 (e varchar, c numeric, a text, b bigint, d int) PARTITION BY range (abs(d))

Parser Error: syntax error at or near "PARTITION"

ALTER TABLE part_c_100_200 DROP COLUMN e, DROP COLUMN c, DROP COLUMN a
ERROR: 
ALTER TABLE part_c_100_200 DROP COLUMN e, DROP COLUMN c, DROP COLUMN a

Parser Error: Only one ALTER command per statement is supported

ALTER TABLE part_c_100_200 ADD COLUMN c numeric, ADD COLUMN e varchar, ADD COLUMN a text
ERROR: 
ALTER TABLE part_c_100_200 ADD COLUMN c numeric, ADD COLUMN e varchar, ADD COLUMN a text

Parser Error: Only one ALTER command per statement is supported

ALTER TABLE part_c_100_200 DROP COLUMN b
ERROR: 
ALTER TABLE part_c_100_200 DROP COLUMN b

Catalog Error: Table with name part_c_100_200 does not exist!
Did you mean "part_b_20_b_30"?

ALTER TABLE part_c_100_200 ADD COLUMN b bigint
ERROR: 
ALTER TABLE part_c_100_200 ADD COLUMN b bigint

Catalog Error: Table with name part_c_100_200 does not exist!
Did you mean "part_b_20_b_30"?

CREATE TABLE part_d_1_15 PARTITION OF part_c_100_200 FOR VALUES FROM (1) TO (15)
ERROR: 
CREATE TABLE part_d_1_15 PARTITION OF part_c_100_200 FOR VALUES FROM (1) TO (15)

Parser Error: syntax error at or near "PARTITION"

CREATE TABLE part_d_15_20 PARTITION OF part_c_100_200 FOR VALUES FROM (15) TO (20)
ERROR: 
CREATE TABLE part_d_15_20 PARTITION OF part_c_100_200 FOR VALUES FROM (15) TO (20)

Parser Error: syntax error at or near "PARTITION"


ALTER TABLE part_b_10_b_20 ATTACH PARTITION part_c_100_200 FOR VALUES FROM (100) TO (200)
ERROR: 

ALTER TABLE part_b_10_b_20 ATTACH PARTITION part_c_100_200 FOR VALUES FROM (100) TO (200)

Parser Error: syntax error at or near "ATTACH"


CREATE TABLE part_c_1_100 (e varchar, d int, c numeric, b bigint, a text)

ALTER TABLE part_b_10_b_20 ATTACH PARTITION part_c_1_100 FOR VALUES FROM (1) TO (100)
ERROR: 
ALTER TABLE part_b_10_b_20 ATTACH PARTITION part_c_1_100 FOR VALUES FROM (1) TO (100)

Parser Error: syntax error at or near "ATTACH"


-- \set init_range_parted ''truncate range_parted /* REPLACED */, insert into range_parted VALUES (''''a'''', 1, 1, 1), (''''a'''', 10, 200, 1), (''''b'''', 12, 96, 1), (''''b'''', 13, 97, 2), (''''b'''', 15, 105, 16), (''''b'''', 17, 105, 19)''
-- \set show_data ''select tableoid::regclass::text COLLATE ''C'' partname, * from range_parted ORDER BY 1, 2, 3, 4, 5, 6''
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 

-- \set init_range_parted ''truncate range_parted /* REPLACED */, insert into range_parted VALUES (''''a'''', 1, 1, 1), (''''a'''', 10, 200, 1), (''''b'''', 12, 96, 1), (''''b'''', 13, 97, 2), (''''b'''', 15, 105, 16), (''''b'''', 17, 105, 19)''
-- \set show_data ''select tableoid::regclass::text COLLATE ''C'' partname, * from range_parted ORDER BY 1, 2, 3, 4, 5, 6''
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


-- The order of subplans should be in bound order
EXPLAIN (costs off) UPDATE range_parted set c = c - 50 WHERE c > 97
ERROR: 

-- The order of subplans should be in bound order
EXPLAIN (costs off) UPDATE range_parted set c = c - 50 WHERE c > 97

Not implemented Error: Unimplemented explain type: costs


-- fail, row movement happens only within the partition subtree.
UPDATE part_c_100_200 set c = c - 20, d = c WHERE c = 105
ERROR: 

-- fail, row movement happens only within the partition subtree.
UPDATE part_c_100_200 set c = c - 20, d = c WHERE c = 105

Catalog Error: Table with name part_c_100_200 does not exist!
Did you mean "part_c_1_100"?
LINE 4: UPDATE part_c_100_200 set c = c - 20, d = c WHERE c = 105
...
               ^

-- fail, no partition key update, so no attempt to move tuple,
-- but ''a = ''a'''' violates partition constraint enforced by root partition)
UPDATE part_b_10_b_20 set a = 'a'
ERROR: 
-- fail, no partition key update, so no attempt to move tuple,
-- but ''a = ''a'''' violates partition constraint enforced by root partition)
UPDATE part_b_10_b_20 set a = 'a'

Catalog Error: Table with name part_b_10_b_20 does not exist!
Did you mean "part_b_20_b_30"?
LINE 4: UPDATE part_b_10_b_20 set a = 'a'
               ^

-- ok, partition key update, no constraint violation
UPDATE range_parted set d = d - 10 WHERE d > 10
ERROR: 
-- ok, partition key update, no constraint violation
UPDATE range_parted set d = d - 10 WHERE d > 10

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: UPDATE range_parted set d = d - 10 WHERE d > 10
...
               ^

-- ok, no partition key update, no constraint violation
UPDATE range_parted set e = d
ERROR: 
-- ok, no partition key update, no constraint violation
UPDATE range_parted set e = d

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: UPDATE range_parted set e = d
               ^

-- No row found
UPDATE part_c_1_100 set c = c + 20 WHERE c = 98

-- ok, row movement
UPDATE part_b_10_b_20 set c = c + 20 returning c, b, a
ERROR: 
-- ok, row movement
UPDATE part_b_10_b_20 set c = c + 20 returning c, b, a

Catalog Error: Table with name part_b_10_b_20 does not exist!
Did you mean "part_b_20_b_30"?
LINE 3: UPDATE part_b_10_b_20 set...
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


-- fail, row movement happens only within the partition subtree.
UPDATE part_b_10_b_20 set b = b - 6 WHERE c > 116 returning *
ERROR: 

-- fail, row movement happens only within the partition subtree.
UPDATE part_b_10_b_20 set b = b - 6 WHERE c > 116 returning *

Catalog Error: Table with name part_b_10_b_20 does not exist!
Did you mean "part_b_20_b_30"?
LINE 4: UPDATE part_b_10_b_20 set b = b - 6 WHERE c > 116 returning *
...
               ^

-- ok, row movement, with subset of rows moved into different partition.
UPDATE range_parted set b = b - 6 WHERE c > 116 returning a, b + c
ERROR: 
-- ok, row movement, with subset of rows moved into different partition.
UPDATE range_parted set b = b - 6 WHERE c > 116 returning a, b + c

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: UPDATE range_parted set b = b - 6 WHERE c > 116 returning a, b + c
...
               ^


/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


-- Common table needed for multiple test scenarios.
CREATE TABLE mintab(c1 int)

INSERT into mintab VALUES (120)


-- update partition key using updatable view.
CREATE VIEW upview AS SELECT * FROM range_parted WHERE (select c > c1 FROM mintab) WITH CHECK OPTION
ERROR: 

-- update partition key using updatable view.
CREATE VIEW upview AS SELECT * FROM range_parted WHERE (select c > c1 FROM mintab) WITH CHECK OPTION

Not implemented Error: VIEW CHECK options

-- ok
UPDATE upview set c = 199 WHERE b = 4
ERROR: 
-- ok
UPDATE upview set c = 199 WHERE b = 4

Catalog Error: Table with name upview does not exist!
Did you mean "pg_views"?
LINE 3: UPDATE upview set c = 199 WHERE b = 4
               ^

-- fail, check option violation
UPDATE upview set c = 120 WHERE b = 4
ERROR: 
-- fail, check option violation
UPDATE upview set c = 120 WHERE b = 4

Catalog Error: Table with name upview does not exist!
Did you mean "pg_views"?
LINE 3: UPDATE upview set c = 120 WHERE b = 4
               ^

-- fail, row movement with check option violation
UPDATE upview set a = 'b', b = 15, c = 120 WHERE b = 4
ERROR: 
-- fail, row movement with check option violation
UPDATE upview set a = 'b', b = 15, c = 120 WHERE b = 4

Catalog Error: Table with name upview does not exist!
Did you mean "pg_views"?
LINE 3: UPDATE upview set a = 'b', b = 15, c = 120 WHERE b = 4
...
               ^

-- ok, row movement, check option passes
UPDATE upview set a = 'b', b = 15 WHERE b = 4
ERROR: 
-- ok, row movement, check option passes
UPDATE upview set a = 'b', b = 15 WHERE b = 4

Catalog Error: Table with name upview does not exist!
Did you mean "pg_views"?
LINE 3: UPDATE upview set a = 'b', b = 15 WHERE b = 4
               ^


/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


-- cleanup
DROP VIEW upview
ERROR: 

-- cleanup
DROP VIEW upview

Catalog Error: View with name upview does not exist!
Did you mean "pg_views"?


-- RETURNING having whole-row vars.
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 

-- RETURNING having whole-row vars.
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

UPDATE range_parted set c = 95 WHERE a = 'b' and b > 10 and c > 100 returning (range_parted), *
ERROR: 
UPDATE range_parted set c = 95 WHERE a = 'b' and b > 10 and c > 100 returning (range_parted), *

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 2: UPDATE range_parted set c = 95 WHERE a = 'b' ...
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"



-- Transition tables with update row movement
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 


-- Transition tables with update row movement
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"


CREATE FUNCTION trans_updatetrigfunc() RETURNS trigger LANGUAGE plpgsql AS
$$
  begin
    raise notice 'trigger = %, old table = %, new table = %',
                 TG_NAME,
                 (select string_agg(old_table::text, ', ' ORDER BY a) FROM old_table),
                 (select string_agg(new_table::text, ', ' ORDER BY a) FROM new_table);
    return null;
  end;
$$
ERROR: 

CREATE FUNCTION trans_updatetrigfunc() RETURNS trigger LANGUAGE plpgsql AS
$$
  begin
    raise notice 'trigger = %, old table = %, new table = %',
                 TG_NAME,
                 (select string_agg(old_table::text, ', ' ORDER BY a) FROM old_table),
                 (select string_agg(new_table::text, ', ' ORDER BY a) FROM new_table);
    return null;
  end;
$$

Parser Error: syntax error at or near "RETURNS"


CREATE TRIGGER trans_updatetrig
  AFTER UPDATE ON range_parted REFERENCING OLD TABLE AS old_table NEW TABLE AS new_table
  FOR EACH STATEMENT EXECUTE PROCEDURE trans_updatetrigfunc()
ERROR: 

CREATE TRIGGER trans_updatetrig
  AFTER UPDATE ON range_parted REFERENCING OLD TABLE AS old_table NEW TABLE AS new_table
  FOR EACH STATEMENT EXECUTE PROCEDURE trans_updatetrigfunc()

Parser Error: syntax error at or near "TRIGGER"


UPDATE range_parted set c = (case when c = 96 then 110 else c + 1 end ) WHERE a = 'b' and b > 10 and c >= 96
ERROR: 

UPDATE range_parted set c = (case when c = 96 then 110 else c + 1 end ) WHERE a = 'b' and b > 10 and c >= 96

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: UPDATE range_parted set c = (case when c = 9...
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"


-- Enabling OLD TABLE capture for both DELETE as well as UPDATE stmt triggers
-- should not cause DELETEd rows to be captured twice. Similar thing for
-- INSERT triggers and inserted rows.
CREATE TRIGGER trans_deletetrig
  AFTER DELETE ON range_parted REFERENCING OLD TABLE AS old_table
  FOR EACH STATEMENT EXECUTE PROCEDURE trans_updatetrigfunc()
ERROR: 

-- Enabling OLD TABLE capture for both DELETE as well as UPDATE stmt triggers
-- should not cause DELETEd rows to be captured twice. Similar thing for
-- INSERT triggers and inserted rows.
CREATE TRIGGER trans_deletetrig
  AFTER DELETE ON range_parted REFERENCING OLD TABLE AS old_table
  FOR EACH STATEMENT EXECUTE PROCEDURE trans_updatetrigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER trans_inserttrig
  AFTER INSERT ON range_parted REFERENCING NEW TABLE AS new_table
  FOR EACH STATEMENT EXECUTE PROCEDURE trans_updatetrigfunc()
ERROR: 
CREATE TRIGGER trans_inserttrig
  AFTER INSERT ON range_parted REFERENCING NEW TABLE AS new_table
  FOR EACH STATEMENT EXECUTE PROCEDURE trans_updatetrigfunc()

Parser Error: syntax error at or near "TRIGGER"

UPDATE range_parted set c = c + 50 WHERE a = 'b' and b > 10 and c >= 96
ERROR: 
UPDATE range_parted set c = c + 50 WHERE a = 'b' and b > 10 and c >= 96

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 2: UPDATE range_parted set c = c + 50 WHERE a = ...
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"

DROP TRIGGER trans_deletetrig ON range_parted
ERROR: 
DROP TRIGGER trans_deletetrig ON range_parted

Not implemented Error: Cannot drop this type yet

DROP TRIGGER trans_inserttrig ON range_parted
ERROR: 
DROP TRIGGER trans_inserttrig ON range_parted

Not implemented Error: Cannot drop this type yet

-- Don''t drop trans_updatetrig yet. It is required below.

-- Test with transition tuple conversion happening for rows moved into the
-- new partition. This requires a trigger that references transition table
-- (we already have trans_updatetrig). For inserted rows, the conversion
-- is not usually needed, because the original tuple is already compatible with
-- the desired transition tuple format. But conversion happens when there is a
-- BR trigger because the trigger can change the inserted row. So install a
-- BR triggers on those child partitions where the rows will be moved.
CREATE FUNCTION func_parted_mod_b() RETURNS trigger AS $$
BEGIN
   NEW.b = NEW.b + 1;
   return NEW;
END $$ language plpgsql
ERROR: 
-- Don''t drop trans_updatetrig yet. It is required below.

-- Test with transition tuple conversion happening for rows moved into the
-- new partition. This requires a trigger that references transition table
-- (we already have trans_updatetrig). For inserted rows, the conversion
-- is not usually needed, because the original tuple is already compatible with
-- the desired transition tuple format. But conversion happens when there is a
-- BR trigger because the trigger can change the inserted row. So install a
-- BR triggers on those child partitions where the rows will be moved.
CREATE FUNCTION func_parted_mod_b() RETURNS trigger AS $$
BEGIN
   NEW.b = NEW.b + 1;
   return NEW;
END $$ language plpgsql

Parser Error: syntax error at or near "RETURNS"

CREATE TRIGGER trig_c1_100 BEFORE UPDATE OR INSERT ON part_c_1_100
   FOR EACH ROW EXECUTE PROCEDURE func_parted_mod_b()
ERROR: 
CREATE TRIGGER trig_c1_100 BEFORE UPDATE OR INSERT ON part_c_1_100
   FOR EACH ROW EXECUTE PROCEDURE func_parted_mod_b()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER trig_d1_15 BEFORE UPDATE OR INSERT ON part_d_1_15
   FOR EACH ROW EXECUTE PROCEDURE func_parted_mod_b()
ERROR: 
CREATE TRIGGER trig_d1_15 BEFORE UPDATE OR INSERT ON part_d_1_15
   FOR EACH ROW EXECUTE PROCEDURE func_parted_mod_b()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER trig_d15_20 BEFORE UPDATE OR INSERT ON part_d_15_20
   FOR EACH ROW EXECUTE PROCEDURE func_parted_mod_b()
ERROR: 
CREATE TRIGGER trig_d15_20 BEFORE UPDATE OR INSERT ON part_d_15_20
   FOR EACH ROW EXECUTE PROCEDURE func_parted_mod_b()

Parser Error: syntax error at or near "TRIGGER"

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

UPDATE range_parted set c = (case when c = 96 then 110 else c + 1 end) WHERE a = 'b' and b > 10 and c >= 96
ERROR: 
UPDATE range_parted set c = (case when c = 96 then 110 else c + 1 end) WHERE a = 'b' and b > 10 and c >= 96

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 2: UPDATE range_parted set c = (case when c = 96...
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

UPDATE range_parted set c = c + 50 WHERE a = 'b' and b > 10 and c >= 96
ERROR: 
UPDATE range_parted set c = c + 50 WHERE a = 'b' and b > 10 and c >= 96

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 2: UPDATE range_parted set c = c + 50 WHERE a = ...
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


-- Case where per-partition tuple conversion map array is allocated, but the
-- map is not required for the particular tuple that is routed, thanks to
-- matching table attributes of the partition and the target table.
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 

-- Case where per-partition tuple conversion map array is allocated, but the
-- map is not required for the particular tuple that is routed, thanks to
-- matching table attributes of the partition and the target table.
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

UPDATE range_parted set b = 15 WHERE b = 1
ERROR: 
UPDATE range_parted set b = 15 WHERE b = 1

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 2: UPDATE range_parted set b = 15 WHERE b = 1
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


DROP TRIGGER trans_updatetrig ON range_parted
ERROR: 

DROP TRIGGER trans_updatetrig ON range_parted

Not implemented Error: Cannot drop this type yet

DROP TRIGGER trig_c1_100 ON part_c_1_100
ERROR: 
DROP TRIGGER trig_c1_100 ON part_c_1_100

Not implemented Error: Cannot drop this type yet

DROP TRIGGER trig_d1_15 ON part_d_1_15
ERROR: 
DROP TRIGGER trig_d1_15 ON part_d_1_15

Not implemented Error: Cannot drop this type yet

DROP TRIGGER trig_d15_20 ON part_d_15_20
ERROR: 
DROP TRIGGER trig_d15_20 ON part_d_15_20

Not implemented Error: Cannot drop this type yet

DROP FUNCTION func_parted_mod_b()
ERROR: 
DROP FUNCTION func_parted_mod_b()

Parser Error: syntax error at or near "("


-- RLS policies with update-row-movement
-----------------------------------------

ALTER TABLE range_parted ENABLE ROW LEVEL SECURITY
ERROR: 

-- RLS policies with update-row-movement
-----------------------------------------

ALTER TABLE range_parted ENABLE ROW LEVEL SECURITY

Parser Error: syntax error at or near "ENABLE"

CREATE USER regress_range_parted_user
ERROR: 
CREATE USER regress_range_parted_user

Parser Error: syntax error at or near "USER"

GRANT ALL ON range_parted, mintab TO regress_range_parted_user
ERROR: 
GRANT ALL ON range_parted, mintab TO regress_range_parted_user

Parser Error: syntax error at or near "GRANT"

CREATE POLICY seeall ON range_parted AS PERMISSIVE FOR SELECT USING (true)
ERROR: 
CREATE POLICY seeall ON range_parted AS PERMISSIVE FOR SELECT USING (true)

Parser Error: syntax error at or near "POLICY"

CREATE POLICY policy_range_parted ON range_parted for UPDATE USING (true) WITH CHECK (c % 2 = 0)
ERROR: 
CREATE POLICY policy_range_parted ON range_parted for UPDATE USING (true) WITH CHECK (c % 2 = 0)

Parser Error: syntax error at or near "POLICY"


/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

SET SESSION AUTHORIZATION regress_range_parted_user
ERROR: 
SET SESSION AUTHORIZATION regress_range_parted_user

Parser Error: syntax error at or near "AUTHORIZATION"

-- This should fail with RLS violation error while moving row from
-- part_a_10_a_20 to part_d_1_15, because we are setting ''c'' to an odd number.
UPDATE range_parted set a = 'b', c = 151 WHERE a = 'a' and c = 200
ERROR: 
-- This should fail with RLS violation error while moving row from
-- part_a_10_a_20 to part_d_1_15, because we are setting ''c'' to an odd number.
UPDATE range_parted set a = 'b', c = 151 WHERE a = 'a' and c = 200

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 4: UPDATE range_parted set a = 'b', c = 151 WHERE a = 'a' and c = 200
...
               ^


RESET SESSION AUTHORIZATION
ERROR: 

RESET SESSION AUTHORIZATION

Parser Error: syntax error at or near "AUTHORIZATION"

-- Create a trigger on part_d_1_15
CREATE FUNCTION func_d_1_15() RETURNS trigger AS $$
BEGIN
   NEW.c = NEW.c + 1; -- Make even numbers odd, or vice versa
   return NEW;
END $$ LANGUAGE plpgsql
ERROR: 
-- Create a trigger on part_d_1_15
CREATE FUNCTION func_d_1_15() RETURNS trigger AS $$
BEGIN
   NEW.c = NEW.c + 1; -- Make even numbers odd, or vice versa
   return NEW;
END $$ LANGUAGE plpgsql

Parser Error: syntax error at or near "RETURNS"

CREATE TRIGGER trig_d_1_15 BEFORE INSERT ON part_d_1_15
   FOR EACH ROW EXECUTE PROCEDURE func_d_1_15()
ERROR: 
CREATE TRIGGER trig_d_1_15 BEFORE INSERT ON part_d_1_15
   FOR EACH ROW EXECUTE PROCEDURE func_d_1_15()

Parser Error: syntax error at or near "TRIGGER"


/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

SET SESSION AUTHORIZATION regress_range_parted_user
ERROR: 
SET SESSION AUTHORIZATION regress_range_parted_user

Parser Error: syntax error at or near "AUTHORIZATION"


-- Here, RLS checks should succeed while moving row from part_a_10_a_20 to
-- part_d_1_15. Even though the UPDATE is setting ''c'' to an odd number, the
-- trigger at the destination partition again makes it an even number.
UPDATE range_parted set a = 'b', c = 151 WHERE a = 'a' and c = 200
ERROR: 

-- Here, RLS checks should succeed while moving row from part_a_10_a_20 to
-- part_d_1_15. Even though the UPDATE is setting ''c'' to an odd number, the
-- trigger at the destination partition again makes it an even number.
UPDATE range_parted set a = 'b', c = 151 WHERE a = 'a' and c = 200

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 6: UPDATE range_parted set a = 'b', c = 151 WHERE a = 'a' and c = 200
...
               ^


RESET SESSION AUTHORIZATION
ERROR: 

RESET SESSION AUTHORIZATION

Parser Error: syntax error at or near "AUTHORIZATION"

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

SET SESSION AUTHORIZATION regress_range_parted_user
ERROR: 
SET SESSION AUTHORIZATION regress_range_parted_user

Parser Error: syntax error at or near "AUTHORIZATION"

-- This should fail with RLS violation error. Even though the UPDATE is setting
-- ''c'' to an even number, the trigger at the destination partition again makes
-- it an odd number.
UPDATE range_parted set a = 'b', c = 150 WHERE a = 'a' and c = 200
ERROR: 
-- This should fail with RLS violation error. Even though the UPDATE is setting
-- ''c'' to an even number, the trigger at the destination partition again makes
-- it an odd number.
UPDATE range_parted set a = 'b', c = 150 WHERE a = 'a' and c = 200

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 5: UPDATE range_parted set a = 'b', c = 150 WHERE a = 'a' and c = 200
...
               ^


-- Cleanup
RESET SESSION AUTHORIZATION
ERROR: 

-- Cleanup
RESET SESSION AUTHORIZATION

Parser Error: syntax error at or near "AUTHORIZATION"

DROP TRIGGER trig_d_1_15 ON part_d_1_15
ERROR: 
DROP TRIGGER trig_d_1_15 ON part_d_1_15

Not implemented Error: Cannot drop this type yet

DROP FUNCTION func_d_1_15()
ERROR: 
DROP FUNCTION func_d_1_15()

Parser Error: syntax error at or near "("


-- Policy expression contains SubPlan
RESET SESSION AUTHORIZATION
ERROR: 

-- Policy expression contains SubPlan
RESET SESSION AUTHORIZATION

Parser Error: syntax error at or near "AUTHORIZATION"

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

CREATE POLICY policy_range_parted_subplan on range_parted
    AS RESTRICTIVE for UPDATE USING (true)
    WITH CHECK ((SELECT range_parted.c <= c1 FROM mintab))
ERROR: 
CREATE POLICY policy_range_parted_subplan on range_parted
    AS RESTRICTIVE for UPDATE USING (true)
    WITH CHECK ((SELECT range_parted.c <= c1 FROM mintab))

Parser Error: syntax error at or near "POLICY"

SET SESSION AUTHORIZATION regress_range_parted_user
ERROR: 
SET SESSION AUTHORIZATION regress_range_parted_user

Parser Error: syntax error at or near "AUTHORIZATION"

-- fail, mintab has row with c1 = 120
UPDATE range_parted set a = 'b', c = 122 WHERE a = 'a' and c = 200
ERROR: 
-- fail, mintab has row with c1 = 120
UPDATE range_parted set a = 'b', c = 122 WHERE a = 'a' and c = 200

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: UPDATE ...
               ^

-- ok
UPDATE range_parted set a = 'b', c = 120 WHERE a = 'a' and c = 200
ERROR: 
-- ok
UPDATE range_parted set a = 'b', c = 120 WHERE a = 'a' and c = 200

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: UPDATE range_parted set a = 'b', c = 12...
               ^


-- RLS policy expression contains whole row.

RESET SESSION AUTHORIZATION
ERROR: 

-- RLS policy expression contains whole row.

RESET SESSION AUTHORIZATION

Parser Error: syntax error at or near "AUTHORIZATION"

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

CREATE POLICY policy_range_parted_wholerow on range_parted AS RESTRICTIVE for UPDATE USING (true)
   WITH CHECK (range_parted = row('b', 10, 112, 1, NULL)::range_parted)
ERROR: 
CREATE POLICY policy_range_parted_wholerow on range_parted AS RESTRICTIVE for UPDATE USING (true)
   WITH CHECK (range_parted = row('b', 10, 112, 1, NULL)::range_parted)

Parser Error: syntax error at or near "POLICY"

SET SESSION AUTHORIZATION regress_range_parted_user
ERROR: 
SET SESSION AUTHORIZATION regress_range_parted_user

Parser Error: syntax error at or near "AUTHORIZATION"

-- ok, should pass the RLS check
UPDATE range_parted set a = 'b', c = 112 WHERE a = 'a' and c = 200
ERROR: 
-- ok, should pass the RLS check
UPDATE range_parted set a = 'b', c = 112 WHERE a = 'a' and c = 200

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: UPDATE range...
               ^

RESET SESSION AUTHORIZATION
ERROR: 
RESET SESSION AUTHORIZATION

Parser Error: syntax error at or near "AUTHORIZATION"

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

SET SESSION AUTHORIZATION regress_range_parted_user
ERROR: 
SET SESSION AUTHORIZATION regress_range_parted_user

Parser Error: syntax error at or near "AUTHORIZATION"

-- fail, the whole row RLS check should fail
UPDATE range_parted set a = 'b', c = 116 WHERE a = 'a' and c = 200
ERROR: 
-- fail, the whole row RLS check should fail
UPDATE range_parted set a = 'b', c = 116 WHERE a = 'a' and c = 200

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: ...
               ^


-- Cleanup
RESET SESSION AUTHORIZATION
ERROR: 

-- Cleanup
RESET SESSION AUTHORIZATION

Parser Error: syntax error at or near "AUTHORIZATION"

DROP POLICY policy_range_parted ON range_parted
ERROR: 
DROP POLICY policy_range_parted ON range_parted

Not implemented Error: Cannot drop this type yet

DROP POLICY policy_range_parted_subplan ON range_parted
ERROR: 
DROP POLICY policy_range_parted_subplan ON range_parted

Not implemented Error: Cannot drop this type yet

DROP POLICY policy_range_parted_wholerow ON range_parted
ERROR: 
DROP POLICY policy_range_parted_wholerow ON range_parted

Not implemented Error: Cannot drop this type yet

REVOKE ALL ON range_parted, mintab FROM regress_range_parted_user
ERROR: 
REVOKE ALL ON range_parted, mintab FROM regress_range_parted_user

Parser Error: syntax error at or near "REVOKE"

DROP USER regress_range_parted_user
ERROR: 
DROP USER regress_range_parted_user

Parser Error: syntax error at or near "USER"

DROP TABLE mintab



-- statement triggers with update row movement
---------------------------------------------------

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 


-- statement triggers with update row movement
---------------------------------------------------

/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"


CREATE FUNCTION trigfunc() returns trigger language plpgsql as
$$
  begin
    raise notice 'trigger = % fired on table % during %',
                 TG_NAME, TG_TABLE_NAME, TG_OP;
    return null;
  end;
$$
ERROR: 

CREATE FUNCTION trigfunc() returns trigger language plpgsql as
$$
  begin
    raise notice 'trigger = % fired on table % during %',
                 TG_NAME, TG_TABLE_NAME, TG_OP;
    return null;
  end;
$$

Parser Error: syntax error at or near "returns"

-- Triggers on root partition
CREATE TRIGGER parent_delete_trig
  AFTER DELETE ON range_parted for each statement execute procedure trigfunc()
ERROR: 
-- Triggers on root partition
CREATE TRIGGER parent_delete_trig
  AFTER DELETE ON range_parted for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER parent_update_trig
  AFTER UPDATE ON range_parted for each statement execute procedure trigfunc()
ERROR: 
CREATE TRIGGER parent_update_trig
  AFTER UPDATE ON range_parted for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER parent_insert_trig
  AFTER INSERT ON range_parted for each statement execute procedure trigfunc()
ERROR: 
CREATE TRIGGER parent_insert_trig
  AFTER INSERT ON range_parted for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"


-- Triggers on leaf partition part_c_1_100
CREATE TRIGGER c1_delete_trig
  AFTER DELETE ON part_c_1_100 for each statement execute procedure trigfunc()
ERROR: 

-- Triggers on leaf partition part_c_1_100
CREATE TRIGGER c1_delete_trig
  AFTER DELETE ON part_c_1_100 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER c1_update_trig
  AFTER UPDATE ON part_c_1_100 for each statement execute procedure trigfunc()
ERROR: 
CREATE TRIGGER c1_update_trig
  AFTER UPDATE ON part_c_1_100 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER c1_insert_trig
  AFTER INSERT ON part_c_1_100 for each statement execute procedure trigfunc()
ERROR: 
CREATE TRIGGER c1_insert_trig
  AFTER INSERT ON part_c_1_100 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"


-- Triggers on leaf partition part_d_1_15
CREATE TRIGGER d1_delete_trig
  AFTER DELETE ON part_d_1_15 for each statement execute procedure trigfunc()
ERROR: 

-- Triggers on leaf partition part_d_1_15
CREATE TRIGGER d1_delete_trig
  AFTER DELETE ON part_d_1_15 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER d1_update_trig
  AFTER UPDATE ON part_d_1_15 for each statement execute procedure trigfunc()
ERROR: 
CREATE TRIGGER d1_update_trig
  AFTER UPDATE ON part_d_1_15 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER d1_insert_trig
  AFTER INSERT ON part_d_1_15 for each statement execute procedure trigfunc()
ERROR: 
CREATE TRIGGER d1_insert_trig
  AFTER INSERT ON part_d_1_15 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

-- Triggers on leaf partition part_d_15_20
CREATE TRIGGER d15_delete_trig
  AFTER DELETE ON part_d_15_20 for each statement execute procedure trigfunc()
ERROR: 
-- Triggers on leaf partition part_d_15_20
CREATE TRIGGER d15_delete_trig
  AFTER DELETE ON part_d_15_20 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER d15_update_trig
  AFTER UPDATE ON part_d_15_20 for each statement execute procedure trigfunc()
ERROR: 
CREATE TRIGGER d15_update_trig
  AFTER UPDATE ON part_d_15_20 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"

CREATE TRIGGER d15_insert_trig
  AFTER INSERT ON part_d_15_20 for each statement execute procedure trigfunc()
ERROR: 
CREATE TRIGGER d15_insert_trig
  AFTER INSERT ON part_d_15_20 for each statement execute procedure trigfunc()

Parser Error: syntax error at or near "TRIGGER"


-- Move all rows from part_c_100_200 to part_c_1_100. None of the delete or
-- insert statement triggers should be fired.
UPDATE range_parted set c = c - 50 WHERE c > 97
ERROR: 

-- Move all rows from part_c_100_200 to part_c_1_100. None of the delete or
-- insert statement triggers should be fired.
UPDATE range_parted set c = c - 50 WHERE c > 97

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 5: UPDATE range_parted set c = c - 50 WHERE c > 97
...
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


DROP TRIGGER parent_delete_trig ON range_parted
ERROR: 

DROP TRIGGER parent_delete_trig ON range_parted

Not implemented Error: Cannot drop this type yet

DROP TRIGGER parent_update_trig ON range_parted
ERROR: 
DROP TRIGGER parent_update_trig ON range_parted

Not implemented Error: Cannot drop this type yet

DROP TRIGGER parent_insert_trig ON range_parted
ERROR: 
DROP TRIGGER parent_insert_trig ON range_parted

Not implemented Error: Cannot drop this type yet

DROP TRIGGER c1_delete_trig ON part_c_1_100
ERROR: 
DROP TRIGGER c1_delete_trig ON part_c_1_100

Not implemented Error: Cannot drop this type yet

DROP TRIGGER c1_update_trig ON part_c_1_100
ERROR: 
DROP TRIGGER c1_update_trig ON part_c_1_100

Not implemented Error: Cannot drop this type yet

DROP TRIGGER c1_insert_trig ON part_c_1_100
ERROR: 
DROP TRIGGER c1_insert_trig ON part_c_1_100

Not implemented Error: Cannot drop this type yet

DROP TRIGGER d1_delete_trig ON part_d_1_15
ERROR: 
DROP TRIGGER d1_delete_trig ON part_d_1_15

Not implemented Error: Cannot drop this type yet

DROP TRIGGER d1_update_trig ON part_d_1_15
ERROR: 
DROP TRIGGER d1_update_trig ON part_d_1_15

Not implemented Error: Cannot drop this type yet

DROP TRIGGER d1_insert_trig ON part_d_1_15
ERROR: 
DROP TRIGGER d1_insert_trig ON part_d_1_15

Not implemented Error: Cannot drop this type yet

DROP TRIGGER d15_delete_trig ON part_d_15_20
ERROR: 
DROP TRIGGER d15_delete_trig ON part_d_15_20

Not implemented Error: Cannot drop this type yet

DROP TRIGGER d15_update_trig ON part_d_15_20
ERROR: 
DROP TRIGGER d15_update_trig ON part_d_15_20

Not implemented Error: Cannot drop this type yet

DROP TRIGGER d15_insert_trig ON part_d_15_20
ERROR: 
DROP TRIGGER d15_insert_trig ON part_d_15_20

Not implemented Error: Cannot drop this type yet



-- Creating default partition for range
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'
ERROR: 


-- Creating default partition for range
/* REPLACED */ 'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'

Parser Error: syntax error at or near "'truncate || range_parted; || insert || into || range_parted || VALUES || (''a'', || 1, || 1, || 1), || (''a'', || 10, || 200, || 1), || (''b'', || 12, || 96, || 1), || (''b'', || 13, || 97, || 2), || (''b'', || 15, || 105, || 16), || (''b'', || 17, || 105, || 19)'"

create table part_def partition of range_parted default
ERROR: 
create table part_def partition of range_parted default

Parser Error: syntax error at or near "partition"

-- \d+ part_def
insert into range_parted values ('c', 9)
ERROR: 
-- \d+ part_def
insert into range_parted values ('c', 9)

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?

-- ok
update part_def set a = 'd' where a = 'c'
ERROR: 
-- ok
update part_def set a = 'd' where a = 'c'

Catalog Error: Table with name part_def does not exist!
Did you mean "pg_attrdef"?
LINE 3: update part_def set a = 'd' where a = 'c'
               ^

-- fail
update part_def set a = 'a' where a = 'd'
ERROR: 
-- fail
update part_def set a = 'a' where a = 'd'

Catalog Error: Table with name part_def does not exist!
Did you mean "pg_attrdef"?
LINE 3: update part_def set a = 'a' where a = 'd'
               ^


/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


-- Update row movement from non-default to default partition.
-- fail, default partition is not under part_a_10_a_20 /* REPLACED */,
UPDATE part_a_10_a_20 set a = 'ad' WHERE a = 'a'
ERROR: 

-- Update row movement from non-default to default partition.
-- fail, default partition is not under part_a_10_a_20 /* REPLACED */,
UPDATE part_a_10_a_20 set a = 'ad' WHERE a = 'a'

Catalog Error: Table with name part_a_10_a_20 does not exist!
Did you mean "part_b_20_b_30"?
LINE 5: UPDATE part_a_10_a_20 set a = 'ad' WHERE a = 'a'
...
               ^

-- ok
UPDATE range_parted set a = 'ad' WHERE a = 'a'
ERROR: 
-- ok
UPDATE range_parted set a = 'ad' WHERE a = 'a'

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 3: UPDATE range_parted set a = 'ad' WHERE a = 'a'
               ^

UPDATE range_parted set a = 'bd' WHERE a = 'b'
ERROR: 
UPDATE range_parted set a = 'bd' WHERE a = 'b'

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 2: UPDATE range_parted set a = 'bd' WHERE a = 'b'
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"

-- Update row movement from default to non-default partitions.
-- ok
UPDATE range_parted set a = 'a' WHERE a = 'ad'
ERROR: 
-- Update row movement from default to non-default partitions.
-- ok
UPDATE range_parted set a = 'a' WHERE a = 'ad'

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 4: UPDATE range_parted set a = 'a' WHERE a = 'ad'
               ^

UPDATE range_parted set a = 'b' WHERE a = 'bd'
ERROR: 
UPDATE range_parted set a = 'b' WHERE a = 'bd'

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?
LINE 2: UPDATE range_parted set a = 'b' WHERE a = 'bd'
               ^

/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'
ERROR: 
/* REPLACED */ 'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'

Parser Error: syntax error at or near "'select || tableoid::regclass::text || COLLATE || "C" || partname, || * || from || range_parted || ORDER || BY || 1, || 2, || 3, || 4, || 5, || 6'"


-- Cleanup: range_parted no longer needed.
DROP TABLE range_parted
ERROR: 

-- Cleanup: range_parted no longer needed.
DROP TABLE range_parted

Catalog Error: Table with name range_parted does not exist!
Did you mean "pg_am"?


CREATE TABLE list_parted (
	a text,
	b int
) PARTITION BY list (a)
ERROR: 

CREATE TABLE list_parted (
	a text,
	b int
) PARTITION BY list (a)

Parser Error: syntax error at or near "PARTITION"

CREATE TABLE list_part1  PARTITION OF list_parted for VALUES in ('a', 'b')
ERROR: 
CREATE TABLE list_part1  PARTITION OF list_parted for VALUES in ('a', 'b')

Parser Error: syntax error at or near "PARTITION"

CREATE TABLE list_default PARTITION OF list_parted default
ERROR: 
CREATE TABLE list_default PARTITION OF list_parted default

Parser Error: syntax error at or near "PARTITION"

INSERT into list_part1 VALUES ('a', 1)
ERROR: 
INSERT into list_part1 VALUES ('a', 1)

Catalog Error: Table with name list_part1 does not exist!
Did you mean "INT2_TBL"?

INSERT into list_default VALUES ('d', 10)
ERROR: 
INSERT into list_default VALUES ('d', 10)

Catalog Error: Table with name list_default does not exist!
Did you mean "INT2_TBL"?


-- fail
UPDATE list_default set a = 'a' WHERE a = 'd'
ERROR: 

-- fail
UPDATE list_default set a = 'a' WHERE a = 'd'

Catalog Error: Table with name list_default does not exist!
Did you mean "INT2_TBL"?
LINE 4: UPDATE list_default set a = 'a' WHERE a = 'd'
               ^

-- ok
UPDATE list_default set a = 'x' WHERE a = 'd'
ERROR: 
-- ok
UPDATE list_default set a = 'x' WHERE a = 'd'

Catalog Error: Table with name list_default does not exist!
Did you mean "INT2_TBL"?
LINE 3: UPDATE list_default set a = 'x' WHERE a = 'd'
               ^


DROP TABLE list_parted
ERROR: 

DROP TABLE list_parted

Catalog Error: Table with name list_parted does not exist!
Did you mean "sqlite_master"?


-- Test retrieval of system columns with non-consistent partition row types.
-- This is only partially supported, as seen in the results.

create table utrtest (a int, b text) partition by list (a)
ERROR: 

-- Test retrieval of system columns with non-consistent partition row types.
-- This is only partially supported, as seen in the results.

create table utrtest (a int, b text) partition by list (a)

Parser Error: syntax error at or near "partition"

create table utr1 (a int check (a in (1)), q text, b text)

create table utr2 (a int check (a in (2)), b text)

alter table utr1 drop column q

alter table utrtest attach partition utr1 for values in (1)
ERROR: 
alter table utrtest attach partition utr1 for values in (1)

Parser Error: syntax error at or near "attach"

alter table utrtest attach partition utr2 for values in (2)
ERROR: 
alter table utrtest attach partition utr2 for values in (2)

Parser Error: syntax error at or near "attach"


insert into utrtest values (1, 'foo')
  returning *, tableoid::regclass, xmin = pg_current_xact_id()::xid as xmin_ok
ERROR: 

insert into utrtest values (1, 'foo')
  returning *, tableoid::regclass, xmin = pg_current_xact_id()::xid as xmin_ok

Catalog Error: Table with name utrtest does not exist!
Did you mean "utr1"?

insert into utrtest values (2, 'bar')
  returning *, tableoid::regclass, xmin = pg_current_xact_id()::xid as xmin_ok
ERROR: 
insert into utrtest values (2, 'bar')
  returning *, tableoid::regclass, xmin = pg_current_xact_id()::xid as xmin_ok

Catalog Error: Table with name utrtest does not exist!
Did you mean "utr1"?
  -- fails
insert into utrtest values (2, 'bar')
  returning *, tableoid::regclass
ERROR:   -- fails
insert into utrtest values (2, 'bar')
  returning *, tableoid::regclass

Catalog Error: Table with name utrtest does not exist!
Did you mean "utr1"?


update utrtest set b = b || b from (values (1), (2)) s(x) where a = s.x
  returning *, tableoid::regclass, xmin = pg_current_xact_id()::xid as xmin_ok
ERROR: 

update utrtest set b = b || b from (values (1), (2)) s(x) where a = s.x
  returning *, tableoid::regclass, xmin = pg_current_xact_id()::xid as xmin_ok

Catalog Error: Table with name utrtest does not exist!
Did you mean "utr1"?
LINE 3: update utrtest set b = b || b from (values (...
               ^


update utrtest set a = 3 - a from (values (1), (2)) s(x) where a = s.x
  returning *, tableoid::regclass, xmin = pg_current_xact_id()::xid as xmin_ok
ERROR: 

update utrtest set a = 3 - a from (values (1), (2)) s(x) where a = s.x
  returning *, tableoid::regclass, xmin = pg_current_xact_id()::xid as xmin_ok

Catalog Error: Table with name utrtest does not exist!
Did you mean "utr1"?
LINE 3: update utrtest set a = 3 - a from (values (1...
               ^
  -- fails

update utrtest set a = 3 - a from (values (1), (2)) s(x) where a = s.x
  returning *, tableoid::regclass
ERROR:   -- fails

update utrtest set a = 3 - a from (values (1), (2)) s(x) where a = s.x
  returning *, tableoid::regclass

Catalog Error: Table with name utrtest does not exist!
Did you mean "utr1"?
LINE 3: update utrtest set a = 3 - a from ...
               ^


delete from utrtest
  returning *, tableoid::regclass, xmax = pg_current_xact_id()::xid as xmax_ok
ERROR: 

delete from utrtest
  returning *, tableoid::regclass, xmax = pg_current_xact_id()::xid as xmax_ok

Catalog Error: Table with name utrtest does not exist!
Did you mean "utr1"?
LINE 3: delete from utrtest
                    ^


drop table utrtest
ERROR: 

drop table utrtest

Catalog Error: Table with name utrtest does not exist!
Did you mean "utr1"?



--------------
-- Some more update-partition-key test scenarios below. This time use list
-- partitions.
--------------

-- Setup for list partitions
CREATE TABLE list_parted (a numeric, b int, c int8) PARTITION BY list (a)
ERROR: 


--------------
-- Some more update-partition-key test scenarios below. This time use list
-- partitions.
--------------

-- Setup for list partitions
CREATE TABLE list_parted (a numeric, b int, c int8) PARTITION BY list (a)

Parser Error: syntax error at or near "PARTITION"

CREATE TABLE sub_parted PARTITION OF list_parted for VALUES in (1) PARTITION BY list (b)
ERROR: 
CREATE TABLE sub_parted PARTITION OF list_parted for VALUES in (1) PARTITION BY list (b)

Parser Error: syntax error at or near "PARTITION"


CREATE TABLE sub_part1(b int, c int8, a numeric)

ALTER TABLE sub_parted ATTACH PARTITION sub_part1 for VALUES in (1)
ERROR: 
ALTER TABLE sub_parted ATTACH PARTITION sub_part1 for VALUES in (1)

Parser Error: syntax error at or near "ATTACH"

CREATE TABLE sub_part2(b int, c int8, a numeric)

ALTER TABLE sub_parted ATTACH PARTITION sub_part2 for VALUES in (2)
ERROR: 
ALTER TABLE sub_parted ATTACH PARTITION sub_part2 for VALUES in (2)

Parser Error: syntax error at or near "ATTACH"


CREATE TABLE list_part1(a numeric, b int, c int8)

ALTER TABLE list_parted ATTACH PARTITION list_part1 for VALUES in (2,3)
ERROR: 
ALTER TABLE list_parted ATTACH PARTITION list_part1 for VALUES in (2,3)

Parser Error: syntax error at or near "ATTACH"


INSERT into list_parted VALUES (2,5,50)
ERROR: 

INSERT into list_parted VALUES (2,5,50)

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?

INSERT into list_parted VALUES (3,6,60)
ERROR: 
INSERT into list_parted VALUES (3,6,60)

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?

INSERT into sub_parted VALUES (1,1,60)
ERROR: 
INSERT into sub_parted VALUES (1,1,60)

Catalog Error: Table with name sub_parted does not exist!
Did you mean "sub_part1"?

INSERT into sub_parted VALUES (1,2,10)
ERROR: 
INSERT into sub_parted VALUES (1,2,10)

Catalog Error: Table with name sub_parted does not exist!
Did you mean "sub_part1"?


-- Test partition constraint violation when intermediate ancestor is used and
-- constraint is inherited from upper root.
UPDATE sub_parted set a = 2 WHERE c = 10
ERROR: 

-- Test partition constraint violation when intermediate ancestor is used and
-- constraint is inherited from upper root.
UPDATE sub_parted set a = 2 WHERE c = 10

Catalog Error: Table with name sub_parted does not exist!
Did you mean "sub_part1"?
LINE 5: UPDATE sub_parted set a = 2 WHERE c = 10
               ^


-- Test update-partition-key, where the unpruned partitions do not have their
-- partition keys updated.
SELECT tableoid::regclass::text, * FROM list_parted WHERE a = 2 ORDER BY 1
ERROR: 

-- Test update-partition-key, where the unpruned partitions do not have their
-- partition keys updated.
SELECT tableoid::regclass::text, * FROM list_parted WHERE a = 2 ORDER BY 1

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?

UPDATE list_parted set b = c + a WHERE a = 2
ERROR: 
UPDATE list_parted set b = c + a WHERE a = 2

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?
LINE 2: UPDATE list_parted set b = c + a WHERE a = 2
               ^

SELECT tableoid::regclass::text, * FROM list_parted WHERE a = 2 ORDER BY 1
ERROR: 
SELECT tableoid::regclass::text, * FROM list_parted WHERE a = 2 ORDER BY 1

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?



-- Test the case where BR UPDATE triggers change the partition key.
CREATE FUNCTION func_parted_mod_b() returns trigger as $$
BEGIN
   NEW.b = 2; -- This is changing partition key column.
   return NEW;
END $$ LANGUAGE plpgsql
ERROR: 


-- Test the case where BR UPDATE triggers change the partition key.
CREATE FUNCTION func_parted_mod_b() returns trigger as $$
BEGIN
   NEW.b = 2; -- This is changing partition key column.
   return NEW;
END $$ LANGUAGE plpgsql

Parser Error: syntax error at or near "returns"

CREATE TRIGGER parted_mod_b before update on sub_part1
   for each row execute procedure func_parted_mod_b()
ERROR: 
CREATE TRIGGER parted_mod_b before update on sub_part1
   for each row execute procedure func_parted_mod_b()

Parser Error: syntax error at or near "TRIGGER"


SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4
ERROR: 

SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?


-- This should do the tuple routing even though there is no explicit
-- partition-key update, because there is a trigger on sub_part1.
UPDATE list_parted set c = 70 WHERE b  = 1
ERROR: 

-- This should do the tuple routing even though there is no explicit
-- partition-key update, because there is a trigger on sub_part1.
UPDATE list_parted set c = 70 WHERE b  = 1

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?
LINE 5: UPDATE list_parted set c = 70 WHERE b  = 1
               ^

SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4
ERROR: 
SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?


DROP TRIGGER parted_mod_b ON sub_part1
ERROR: 

DROP TRIGGER parted_mod_b ON sub_part1

Not implemented Error: Cannot drop this type yet


-- If BR DELETE trigger prevented DELETE from happening, we should also skip
-- the INSERT if that delete is part of UPDATE=>DELETE+INSERT.
CREATE OR REPLACE FUNCTION func_parted_mod_b() returns trigger as $$
BEGIN
   raise notice 'Trigger: Got OLD row %, but returning NULL', OLD;
   return NULL;
END $$ LANGUAGE plpgsql
ERROR: 

-- If BR DELETE trigger prevented DELETE from happening, we should also skip
-- the INSERT if that delete is part of UPDATE=>DELETE+INSERT.
CREATE OR REPLACE FUNCTION func_parted_mod_b() returns trigger as $$
BEGIN
   raise notice 'Trigger: Got OLD row %, but returning NULL', OLD;
   return NULL;
END $$ LANGUAGE plpgsql

Parser Error: syntax error at or near "returns"

CREATE TRIGGER trig_skip_delete before delete on sub_part2
   for each row execute procedure func_parted_mod_b()
ERROR: 
CREATE TRIGGER trig_skip_delete before delete on sub_part2
   for each row execute procedure func_parted_mod_b()

Parser Error: syntax error at or near "TRIGGER"

UPDATE list_parted set b = 1 WHERE c = 70
ERROR: 
UPDATE list_parted set b = 1 WHERE c = 70

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?
LINE 2: UPDATE list_parted set b = 1 WHERE c = 70
               ^

SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4
ERROR: 
SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?

-- Drop the trigger. Now the row should be moved.
DROP TRIGGER trig_skip_delete ON sub_part2
ERROR: 
-- Drop the trigger. Now the row should be moved.
DROP TRIGGER trig_skip_delete ON sub_part2

Not implemented Error: Cannot drop this type yet

UPDATE list_parted set b = 1 WHERE c = 70
ERROR: 
UPDATE list_parted set b = 1 WHERE c = 70

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?
LINE 2: UPDATE list_parted set b = 1 WHERE c = 70
               ^

SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4
ERROR: 
SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?

DROP FUNCTION func_parted_mod_b()
ERROR: 
DROP FUNCTION func_parted_mod_b()

Parser Error: syntax error at or near "("


-- UPDATE partition-key with FROM clause. If join produces multiple output
-- rows for the same row to be modified, we should tuple-route the row only
-- once. There should not be any rows inserted.
CREATE TABLE non_parted (id int)

INSERT into non_parted VALUES (1), (1), (1), (2), (2), (2), (3), (3), (3)

UPDATE list_parted t1 set a = 2 FROM non_parted t2 WHERE t1.a = t2.id and a = 1
ERROR: 
UPDATE list_parted t1 set a = 2 FROM non_parted t2 WHERE t1.a = t2.id and a = 1

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?
LINE 2: UPDATE list_parted t1 set a = 2 FROM non_part...
               ^

SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4
ERROR: 
SELECT tableoid::regclass::text, * FROM list_parted ORDER BY 1, 2, 3, 4

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?

DROP TABLE non_parted


-- Cleanup: list_parted no longer needed.
DROP TABLE list_parted
ERROR: 

-- Cleanup: list_parted no longer needed.
DROP TABLE list_parted

Catalog Error: Table with name list_parted does not exist!
Did you mean "list_part1"?


-- create custom operator class and hash function, for the same reason
-- explained in alter_table.sql
create or replace function dummy_hashint4(a int4, seed int8) returns int8 as
$$ begin return (a + seed); end; $$ language 'plpgsql' immutable
ERROR: 

-- create custom operator class and hash function, for the same reason
-- explained in alter_table.sql
create or replace function dummy_hashint4(a int4, seed int8) returns int8 as
$$ begin return (a + seed); end; $$ language 'plpgsql' immutable

Parser Error: syntax error at or near "int4"

create operator class custom_opclass for type int4 using hash as
operator 1 = , function 2 dummy_hashint4(int4, int8)
ERROR: 
create operator class custom_opclass for type int4 using hash as
operator 1 = , function 2 dummy_hashint4(int4, int8)

Parser Error: syntax error at or near "operator"


create table hash_parted (
	a int,
	b int
) partition by hash (a custom_opclass, b custom_opclass)
ERROR: 

create table hash_parted (
	a int,
	b int
) partition by hash (a custom_opclass, b custom_opclass)

Parser Error: syntax error at or near "partition"

create table hpart1 partition of hash_parted for values with (modulus 2, remainder 1)
ERROR: 
create table hpart1 partition of hash_parted for values with (modulus 2, remainder 1)

Parser Error: syntax error at or near "partition"

create table hpart2 partition of hash_parted for values with (modulus 4, remainder 2)
ERROR: 
create table hpart2 partition of hash_parted for values with (modulus 4, remainder 2)

Parser Error: syntax error at or near "partition"

create table hpart3 partition of hash_parted for values with (modulus 8, remainder 0)
ERROR: 
create table hpart3 partition of hash_parted for values with (modulus 8, remainder 0)

Parser Error: syntax error at or near "partition"

create table hpart4 partition of hash_parted for values with (modulus 8, remainder 4)
ERROR: 
create table hpart4 partition of hash_parted for values with (modulus 8, remainder 4)

Parser Error: syntax error at or near "partition"

insert into hpart1 values (1, 1)
ERROR: 
insert into hpart1 values (1, 1)

Catalog Error: Table with name hpart1 does not exist!
Did you mean "sub_part1"?

insert into hpart2 values (2, 5)
ERROR: 
insert into hpart2 values (2, 5)

Catalog Error: Table with name hpart2 does not exist!
Did you mean "sub_part2"?

insert into hpart4 values (3, 4)
ERROR: 
insert into hpart4 values (3, 4)

Catalog Error: Table with name hpart4 does not exist!
Did you mean "CHAR_TBL"?


-- fail
update hpart1 set a = 3, b=4 where a = 1
ERROR: 

-- fail
update hpart1 set a = 3, b=4 where a = 1

Catalog Error: Table with name hpart1 does not exist!
Did you mean "sub_part1"?
LINE 4: update hpart1 set a = 3, b=4 where a = 1
               ^

-- ok, row movement
update hash_parted set b = b - 1 where b = 1
ERROR: 
-- ok, row movement
update hash_parted set b = b - 1 where b = 1

Catalog Error: Table with name hash_parted does not exist!
Did you mean "sub_part1"?
LINE 3: update hash_parted set b = b - 1 where b = 1
               ^

-- ok
update hash_parted set b = b + 8 where b = 1
ERROR: 
-- ok
update hash_parted set b = b + 8 where b = 1

Catalog Error: Table with name hash_parted does not exist!
Did you mean "sub_part1"?
LINE 3: update hash_parted set b = b + 8 where b = 1
               ^


-- cleanup
drop table hash_parted
ERROR: 

-- cleanup
drop table hash_parted

Catalog Error: Table with name hash_parted does not exist!
Did you mean "sub_part1"?

drop operator class custom_opclass using hash
ERROR: 
drop operator class custom_opclass using hash

Parser Error: syntax error at or near "operator"

drop function dummy_hashint4(a int4, seed int8)
ERROR: 
drop function dummy_hashint4(a int4, seed int8)

Parser Error: syntax error at or near "("


