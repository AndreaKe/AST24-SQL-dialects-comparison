
-----------
QUERY:
--
-- Test foreign-data wrapper and server management.
--

-- directory paths and dlsuffix are passed to us in environment variables
-- \getenv libdir '/home/keuscha/Documents/FS2024/AST/project/postgresql/src/test/regress'
-- \getenv dlsuffix '.so'

-- \set regresslib /* REPLACED */'/home/keuscha/Documents/FS2024/AST/project/postgresql/src/test/regress' '/regress' /* REPLACED */'.so'

CREATE FUNCTION test_fdw_handler()
    RETURNS fdw_handler
    AS /* REPLACED */'/home/keuscha/Documents/FS2024/AST/project/postgresql/src/test/regress/regress.so', 'test_fdw_handler'
    LANGUAGE C;
RESULT:
	postgres: None

-----------
QUERY:


-- Clean up in case a prior regression run failed

-- Suppress NOTICE messages when roles don/* REPLACED */''t exist
SET client_min_messages TO 'warning';
RESULT:
	postgres: None

-----------
QUERY:


DROP ROLE IF EXISTS regress_foreign_data_user, regress_test_role, regress_test_role2, regress_test_role_super, regress_test_indirect, regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:


RESET client_min_messages;
RESULT:
	postgres: None

-----------
QUERY:


CREATE ROLE regress_foreign_data_user LOGIN SUPERUSER;
RESULT:
	postgres: None

-----------
QUERY:

SET SESSION AUTHORIZATION 'regress_foreign_data_user';
RESULT:
	postgres: None

-----------
QUERY:


CREATE ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE ROLE regress_test_role2;
RESULT:
	postgres: None

-----------
QUERY:

CREATE ROLE regress_test_role_super SUPERUSER;
RESULT:
	postgres: None

-----------
QUERY:

CREATE ROLE regress_test_indirect;
RESULT:
	postgres: None

-----------
QUERY:

CREATE ROLE regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:


CREATE FOREIGN DATA WRAPPER dummy;
RESULT:
	postgres: None

-----------
QUERY:

COMMENT ON FOREIGN DATA WRAPPER dummy IS 'useless';
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN DATA WRAPPER postgresql VALIDATOR postgresql_fdw_validator;
RESULT:
	postgres: None

-----------
QUERY:


-- At this point we should have 2 built-in wrappers and no servers.
SELECT fdwname, fdwhandler::regproc, fdwvalidator::regproc, fdwoptions FROM pg_foreign_data_wrapper ORDER BY 1, 2, 3;
RESULT:
	postgres: [('dummy', '-', '-', None), ('postgresql', '-', 'postgresql_fdw_validator', None)]

-----------
QUERY:

SELECT srvname, srvoptions FROM pg_foreign_server;
RESULT:
	postgres: []

-----------
QUERY:

SELECT * FROM pg_user_mapping;
RESULT:
	postgres: []

-----------
QUERY:


-- CREATE FOREIGN DATA WRAPPER
CREATE FOREIGN DATA WRAPPER foo VALIDATOR bar;
RESULT:
	postgres: function bar(text[], oid) does not exist


-----------
QUERY:
            -- ERROR
CREATE FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

-- \dew

CREATE FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: foreign-data wrapper "foo" already exists


-----------
QUERY:
 -- duplicate
DROP FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN DATA WRAPPER foo OPTIONS (testing '1');
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

DROP FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN DATA WRAPPER foo OPTIONS (testing '1', testing '2');
RESULT:
	postgres: option "testing" provided more than once


-----------
QUERY:
   -- ERROR
CREATE FOREIGN DATA WRAPPER foo OPTIONS (testing '1', another '2');
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

DROP FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: permission denied to create foreign-data wrapper "foo"
HINT:  Must be superuser to create a foreign-data wrapper.


-----------
QUERY:
 -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN DATA WRAPPER foo VALIDATOR postgresql_fdw_validator;
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

-- HANDLER related checks
CREATE FUNCTION invalid_fdw_handler() RETURNS int LANGUAGE SQL AS 'SELECT 1;
RESULT:
	postgres: unterminated quoted string at or near "'SELECT 1;"
LINE 5: ...invalid_fdw_handler() RETURNS int LANGUAGE SQL AS 'SELECT 1;
                                                             ^


-----------
QUERY:
';
RESULT:
	postgres: unterminated quoted string at or near "';"
LINE 1: ';
        ^


-----------
QUERY:

CREATE FOREIGN DATA WRAPPER test_fdw HANDLER invalid_fdw_handler;
RESULT:
	postgres: function invalid_fdw_handler() does not exist


-----------
QUERY:
  -- ERROR
CREATE FOREIGN DATA WRAPPER test_fdw HANDLER test_fdw_handler HANDLER invalid_fdw_handler;
RESULT:
	postgres: conflicting or redundant options
LINE 2: ...GN DATA WRAPPER test_fdw HANDLER test_fdw_handler HANDLER in...
                                                             ^


-----------
QUERY:
  -- ERROR
CREATE FOREIGN DATA WRAPPER test_fdw HANDLER test_fdw_handler;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN DATA WRAPPER test_fdw;
RESULT:
	postgres: None

-----------
QUERY:


-- ALTER FOREIGN DATA WRAPPER
ALTER FOREIGN DATA WRAPPER foo OPTIONS (nonexistent 'fdw');
RESULT:
	postgres: invalid option "nonexistent"
HINT:  There are no valid options in this context.


-----------
QUERY:
         -- ERROR

ALTER FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: syntax error at or near ";"
LINE 3: ALTER FOREIGN DATA WRAPPER foo;
                                      ^


-----------
QUERY:
                             -- ERROR
ALTER FOREIGN DATA WRAPPER foo VALIDATOR bar;
RESULT:
	postgres: function bar(text[], oid) does not exist


-----------
QUERY:
               -- ERROR
ALTER FOREIGN DATA WRAPPER foo NO VALIDATOR;
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

ALTER FOREIGN DATA WRAPPER foo OPTIONS (a '1', b '2');
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN DATA WRAPPER foo OPTIONS (SET c '4');
RESULT:
	postgres: option "c" not found


-----------
QUERY:
         -- ERROR
ALTER FOREIGN DATA WRAPPER foo OPTIONS (DROP c);
RESULT:
	postgres: option "c" not found


-----------
QUERY:
            -- ERROR
ALTER FOREIGN DATA WRAPPER foo OPTIONS (ADD x '1', DROP x);
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

ALTER FOREIGN DATA WRAPPER foo OPTIONS (DROP a, SET b '3', ADD c '4');
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

ALTER FOREIGN DATA WRAPPER foo OPTIONS (a '2');
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN DATA WRAPPER foo OPTIONS (b '4');
RESULT:
	postgres: option "b" provided more than once


-----------
QUERY:
             -- ERROR
-- \dew+

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN DATA WRAPPER foo OPTIONS (ADD d '5');
RESULT:
	postgres: permission denied to alter foreign-data wrapper "foo"
HINT:  Must be superuser to alter a foreign-data wrapper.


-----------
QUERY:
         -- ERROR
SET ROLE regress_test_role_super;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN DATA WRAPPER foo OPTIONS (ADD d '5');
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

ALTER FOREIGN DATA WRAPPER foo OWNER TO regress_test_role;
RESULT:
	postgres: permission denied to change owner of foreign-data wrapper "foo"
HINT:  The owner of a foreign-data wrapper must be a superuser.


-----------
QUERY:
  -- ERROR
ALTER FOREIGN DATA WRAPPER foo OWNER TO regress_test_role_super;
RESULT:
	postgres: None

-----------
QUERY:

ALTER ROLE regress_test_role_super NOSUPERUSER;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role_super;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN DATA WRAPPER foo OPTIONS (ADD e '6');
RESULT:
	postgres: permission denied to alter foreign-data wrapper "foo"
HINT:  Must be superuser to alter a foreign-data wrapper.


-----------
QUERY:
         -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

ALTER FOREIGN DATA WRAPPER foo RENAME TO foo1;
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+
ALTER FOREIGN DATA WRAPPER foo1 RENAME TO foo;
RESULT:
	postgres: None

-----------
QUERY:


-- HANDLER related checks
ALTER FOREIGN DATA WRAPPER foo HANDLER invalid_fdw_handler;
RESULT:
	postgres: function invalid_fdw_handler() does not exist


-----------
QUERY:
  -- ERROR
ALTER FOREIGN DATA WRAPPER foo HANDLER test_fdw_handler HANDLER anything;
RESULT:
	postgres: conflicting or redundant options
LINE 2: ...FOREIGN DATA WRAPPER foo HANDLER test_fdw_handler HANDLER an...
                                                             ^


-----------
QUERY:
  -- ERROR
ALTER FOREIGN DATA WRAPPER foo HANDLER test_fdw_handler;
RESULT:
	postgres: None

-----------
QUERY:

DROP FUNCTION invalid_fdw_handler();
RESULT:
	postgres: function invalid_fdw_handler() does not exist


-----------
QUERY:


-- DROP FOREIGN DATA WRAPPER
DROP FOREIGN DATA WRAPPER nonexistent;
RESULT:
	postgres: foreign-data wrapper "nonexistent" does not exist


-----------
QUERY:
                      -- ERROR
DROP FOREIGN DATA WRAPPER IF EXISTS nonexistent;
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

DROP ROLE regress_test_role_super;
RESULT:
	postgres: role "regress_test_role_super" cannot be dropped because some objects depend on it
DETAIL:  owner of foreign-data wrapper foo


-----------
QUERY:
                          -- ERROR
SET ROLE regress_test_role_super;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

DROP ROLE regress_test_role_super;
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+

CREATE FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s1 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

COMMENT ON SERVER s1 IS 'foreign server';
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR current_user SERVER s1;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR current_user SERVER s1;
RESULT:
	postgres: user mapping for "regress_foreign_data_user" already exists for server "s1"


-----------
QUERY:
				-- ERROR
CREATE USER MAPPING IF NOT EXISTS FOR current_user SERVER s1;
RESULT:
	postgres: None

-----------
QUERY:
 -- NOTICE
-- \dew+
-- \des+
-- \deu+
DROP FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: cannot drop foreign-data wrapper foo because other objects depend on it
DETAIL:  server s1 depends on foreign-data wrapper foo
user mapping for regress_foreign_data_user on server s1 depends on server s1
HINT:  Use DROP ... CASCADE to drop the dependent objects too.


-----------
QUERY:
                              -- ERROR
SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN DATA WRAPPER foo CASCADE;
RESULT:
	postgres: must be owner of foreign-data wrapper foo


-----------
QUERY:
                      -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN DATA WRAPPER foo CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

-- \dew+
-- \des+
-- \deu+

-- exercise CREATE SERVER
CREATE SERVER s1 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: foreign-data wrapper "foo" does not exist


-----------
QUERY:
                  -- ERROR
CREATE FOREIGN DATA WRAPPER foo OPTIONS ("test wrapper" 'true');
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s1 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s1 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: server "s1" already exists


-----------
QUERY:
                  -- ERROR
CREATE SERVER IF NOT EXISTS s1 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:
	-- No ERROR, just NOTICE
CREATE SERVER s2 FOREIGN DATA WRAPPER foo OPTIONS (host 'a', dbname 'b');
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s3 TYPE 'oracle' FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s4 TYPE 'oracle' FOREIGN DATA WRAPPER foo OPTIONS (host 'a', dbname 'b');
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s5 VERSION '15.0' FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s6 VERSION '16.0' FOREIGN DATA WRAPPER foo OPTIONS (host 'a', dbname 'b');
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s7 TYPE 'oracle' VERSION '17.0' FOREIGN DATA WRAPPER foo OPTIONS (host 'a', dbname 'b');
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s8 FOREIGN DATA WRAPPER postgresql OPTIONS (foo '1');
RESULT:
	postgres: invalid option "foo"


-----------
QUERY:
 -- ERROR
CREATE SERVER s8 FOREIGN DATA WRAPPER postgresql OPTIONS (host 'localhost', dbname 's8db');
RESULT:
	postgres: None

-----------
QUERY:

-- \des+
SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER t1 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: permission denied for foreign-data wrapper foo


-----------
QUERY:
                 -- ERROR: no usage on FDW
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN DATA WRAPPER foo TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER t1 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

-- \des+

REVOKE USAGE ON FOREIGN DATA WRAPPER foo FROM regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN DATA WRAPPER foo TO regress_test_indirect;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER t2 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: permission denied for foreign-data wrapper foo


-----------
QUERY:
                 -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

GRANT regress_test_indirect TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER t2 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

-- \des+
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

REVOKE regress_test_indirect FROM regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:


-- ALTER SERVER
ALTER SERVER s0;
RESULT:
	postgres: syntax error at or near ";"
LINE 4: ALTER SERVER s0;
                       ^


-----------
QUERY:
                                            -- ERROR
ALTER SERVER s0 OPTIONS (a '1');
RESULT:
	postgres: server "s0" does not exist


-----------
QUERY:
                            -- ERROR
ALTER SERVER s1 VERSION '1.0' OPTIONS (servername 's1');
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s2 VERSION '1.1';
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s3 OPTIONS ("tns name" 'orcl', port '1521');
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN SERVER s1 TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN SERVER s6 TO regress_test_role2 WITH GRANT OPTION;
RESULT:
	postgres: None

-----------
QUERY:

-- \des+
SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s1 VERSION '1.1';
RESULT:
	postgres: must be owner of foreign server s1


-----------
QUERY:
                              -- ERROR
ALTER SERVER s1 OWNER TO regress_test_role;
RESULT:
	postgres: must be owner of foreign server s1


-----------
QUERY:
                 -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s1 OWNER TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

GRANT regress_test_role2 TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s1 VERSION '1.1';
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s1 OWNER TO regress_test_role2;
RESULT:
	postgres: permission denied for foreign-data wrapper foo


-----------
QUERY:
                -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s8 OPTIONS (foo '1');
RESULT:
	postgres: invalid option "foo"


-----------
QUERY:
                          -- ERROR option validation
ALTER SERVER s8 OPTIONS (connect_timeout '30', SET dbname 'db1', DROP host);
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s1 OWNER TO regress_test_indirect;
RESULT:
	postgres: must be able to SET ROLE "regress_test_indirect"


-----------
QUERY:
             -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

GRANT regress_test_indirect TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s1 OWNER TO regress_test_indirect;
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN DATA WRAPPER foo TO regress_test_indirect;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s1 OWNER TO regress_test_indirect;
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

DROP ROLE regress_test_indirect;
RESULT:
	postgres: role "regress_test_indirect" cannot be dropped because some objects depend on it
DETAIL:  privileges for foreign-data wrapper foo
owner of server s1


-----------
QUERY:
                            -- ERROR
-- \des+

ALTER SERVER s8 RENAME to s8new;
RESULT:
	postgres: None

-----------
QUERY:

-- \des+
ALTER SERVER s8new RENAME to s8;
RESULT:
	postgres: None

-----------
QUERY:


-- DROP SERVER
DROP SERVER nonexistent;
RESULT:
	postgres: server "nonexistent" does not exist


-----------
QUERY:
                                    -- ERROR
DROP SERVER IF EXISTS nonexistent;
RESULT:
	postgres: None

-----------
QUERY:

-- \des
SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

DROP SERVER s2;
RESULT:
	postgres: must be owner of foreign server s2


-----------
QUERY:
                                             -- ERROR
DROP SERVER s1;
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

-- \des
ALTER SERVER s2 OWNER TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

DROP SERVER s2;
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

-- \des
CREATE USER MAPPING FOR current_user SERVER s3;
RESULT:
	postgres: None

-----------
QUERY:

-- \deu
DROP SERVER s3;
RESULT:
	postgres: cannot drop server s3 because other objects depend on it
DETAIL:  user mapping for regress_foreign_data_user on server s3 depends on server s3
HINT:  Use DROP ... CASCADE to drop the dependent objects too.


-----------
QUERY:
                                             -- ERROR
DROP SERVER s3 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

-- \des
-- \deu

-- CREATE USER MAPPING
CREATE USER MAPPING FOR regress_test_missing_role SERVER s1;
RESULT:
	postgres: role "regress_test_missing_role" does not exist


-----------
QUERY:
  -- ERROR
CREATE USER MAPPING FOR current_user SERVER s1;
RESULT:
	postgres: server "s1" does not exist


-----------
QUERY:
             -- ERROR
CREATE USER MAPPING FOR current_user SERVER s4;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR user SERVER s4;
RESULT:
	postgres: user mapping for "regress_foreign_data_user" already exists for server "s4"


-----------
QUERY:
                     -- ERROR duplicate
CREATE USER MAPPING FOR public SERVER s4 OPTIONS ("this mapping" 'is public');
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR user SERVER s8 OPTIONS (username 'test', password 'secret');
RESULT:
	postgres: invalid option "username"
HINT:  Perhaps you meant the option "user".


-----------
QUERY:
    -- ERROR
CREATE USER MAPPING FOR user SERVER s8 OPTIONS (user 'test', password 'secret');
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s5 OWNER TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s6 OWNER TO regress_test_indirect;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR current_user SERVER s5;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR current_user SERVER s6 OPTIONS (username 'test');
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR current_user SERVER s7;
RESULT:
	postgres: permission denied for foreign server s7


-----------
QUERY:
             -- ERROR
CREATE USER MAPPING FOR public SERVER s8;
RESULT:
	postgres: must be owner of foreign server s8


-----------
QUERY:
                   -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:


ALTER SERVER t1 OWNER TO regress_test_indirect;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR current_user SERVER t1 OPTIONS (username 'bob', password 'boo');
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR public SERVER t1;
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

-- \deu

-- ALTER USER MAPPING
ALTER USER MAPPING FOR regress_test_missing_role SERVER s4 OPTIONS (gotcha 'true');
RESULT:
	postgres: role "regress_test_missing_role" does not exist


-----------
QUERY:
 -- ERROR
ALTER USER MAPPING FOR user SERVER ss4 OPTIONS (gotcha 'true');
RESULT:
	postgres: server "ss4" does not exist


-----------
QUERY:
 -- ERROR
ALTER USER MAPPING FOR public SERVER s5 OPTIONS (gotcha 'true');
RESULT:
	postgres: user mapping for "public" does not exist for server "s5"


-----------
QUERY:
            -- ERROR
ALTER USER MAPPING FOR current_user SERVER s8 OPTIONS (username 'test');
RESULT:
	postgres: invalid option "username"
HINT:  Perhaps you meant the option "user".


-----------
QUERY:
    -- ERROR
ALTER USER MAPPING FOR current_user SERVER s8 OPTIONS (DROP user, SET password 'public');
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER USER MAPPING FOR current_user SERVER s5 OPTIONS (ADD modified '1');
RESULT:
	postgres: None

-----------
QUERY:

ALTER USER MAPPING FOR public SERVER s4 OPTIONS (ADD modified '1');
RESULT:
	postgres: must be owner of foreign server s4


-----------
QUERY:
 -- ERROR
ALTER USER MAPPING FOR public SERVER t1 OPTIONS (ADD modified '1');
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

-- \deu+

-- DROP USER MAPPING
DROP USER MAPPING FOR regress_test_missing_role SERVER s4;
RESULT:
	postgres: role "regress_test_missing_role" does not exist


-----------
QUERY:
  -- ERROR
DROP USER MAPPING FOR user SERVER ss4;
RESULT:
	postgres: server "ss4" does not exist


-----------
QUERY:

DROP USER MAPPING FOR public SERVER s7;
RESULT:
	postgres: user mapping for "public" does not exist for server "s7"


-----------
QUERY:
                     -- ERROR
DROP USER MAPPING IF EXISTS FOR regress_test_missing_role SERVER s4;
RESULT:
	postgres: None

-----------
QUERY:

DROP USER MAPPING IF EXISTS FOR user SERVER ss4;
RESULT:
	postgres: None

-----------
QUERY:

DROP USER MAPPING IF EXISTS FOR public SERVER s7;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR public SERVER s8;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

DROP USER MAPPING FOR public SERVER s8;
RESULT:
	postgres: must be owner of foreign server s8


-----------
QUERY:
                     -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

DROP SERVER s7;
RESULT:
	postgres: None

-----------
QUERY:

-- \deu

-- CREATE FOREIGN TABLE
CREATE SCHEMA foreign_schema;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s0 FOREIGN DATA WRAPPER dummy;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft1 ();
RESULT:
	postgres: syntax error at or near ";"
LINE 2: CREATE FOREIGN TABLE ft1 ();
                                   ^


-----------
QUERY:
                                    -- ERROR
CREATE FOREIGN TABLE ft1 () SERVER no_server;
RESULT:
	postgres: server "no_server" does not exist


-----------
QUERY:
                   -- ERROR
CREATE FOREIGN TABLE ft1 (
	c1 integer OPTIONS ("param 1" 'val1') PRIMARY KEY,
	c2 text OPTIONS (param2 'val2', param3 'val3'),
	c3 date
) SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: primary key constraints are not supported on foreign tables
LINE 3:  c1 integer OPTIONS ("param 1" 'val1') PRIMARY KEY,
                                               ^


-----------
QUERY:
 -- ERROR
CREATE TABLE ref_table (id integer PRIMARY KEY);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft1 (
	c1 integer OPTIONS ("param 1" 'val1') REFERENCES ref_table (id),
	c2 text OPTIONS (param2 'val2', param3 'val3'),
	c3 date
) SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: foreign key constraints are not supported on foreign tables
LINE 3:  c1 integer OPTIONS ("param 1" 'val1') REFERENCES ref_table ...
                                               ^


-----------
QUERY:
 -- ERROR
DROP TABLE ref_table;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft1 (
	c1 integer OPTIONS ("param 1" 'val1') NOT NULL,
	c2 text OPTIONS (param2 'val2', param3 'val3'),
	c3 date,
	UNIQUE (c3)
) SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: unique constraints are not supported on foreign tables
LINE 6:  UNIQUE (c3)
         ^


-----------
QUERY:
 -- ERROR
CREATE FOREIGN TABLE ft1 (
	c1 integer OPTIONS ("param 1" 'val1') NOT NULL,
	c2 text OPTIONS (param2 'val2', param3 'val3') CHECK (c2 <> ''),
	c3 date,
	CHECK (c3 BETWEEN '1994-01-01'::date AND '1994-01-31'::date)
) SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: None

-----------
QUERY:

COMMENT ON FOREIGN TABLE ft1 IS 'ft1';
RESULT:
	postgres: None

-----------
QUERY:

COMMENT ON COLUMN ft1.c1 IS 'ft1.c1';
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ ft1
-- \det+
CREATE INDEX id_ft1_c2 ON ft1 (c2);
RESULT:
	postgres: cannot create index on relation "ft1"
DETAIL:  This operation is not supported for foreign tables.


-----------
QUERY:
                             -- ERROR
SELECT * FROM ft1;
RESULT:
	postgres: foreign-data wrapper "dummy" has no handler


-----------
QUERY:
                                              -- ERROR
EXPLAIN SELECT * FROM ft1;
RESULT:
	postgres: foreign-data wrapper "dummy" has no handler


-----------
QUERY:
                                      -- ERROR

CREATE TABLE lt1 (a INT) PARTITION BY RANGE (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft_part1
  PARTITION OF lt1 FOR VALUES FROM (0) TO (1000) SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

CREATE INDEX ON lt1 (a);
RESULT:
	postgres: None

-----------
QUERY:
                              -- skips partition
CREATE UNIQUE INDEX ON lt1 (a);
RESULT:
	postgres: cannot create unique index on partitioned table "lt1"
DETAIL:  Table "lt1" contains partitions that are foreign tables.


-----------
QUERY:
                                 -- ERROR
ALTER TABLE lt1 ADD PRIMARY KEY (a);
RESULT:
	postgres: cannot create unique index on partitioned table "lt1"
DETAIL:  Table "lt1" contains partitions that are foreign tables.


-----------
QUERY:
                            -- ERROR
DROP TABLE lt1;
RESULT:
	postgres: None

-----------
QUERY:


CREATE TABLE lt1 (a INT) PARTITION BY RANGE (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE INDEX ON lt1 (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft_part1
  PARTITION OF lt1 FOR VALUES FROM (0) TO (1000) SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft_part2 (a INT) SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE lt1 ATTACH PARTITION ft_part2 FOR VALUES FROM (1000) TO (2000);
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN TABLE ft_part1, ft_part2;
RESULT:
	postgres: None

-----------
QUERY:

CREATE UNIQUE INDEX ON lt1 (a);
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE lt1 ADD PRIMARY KEY (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft_part1
  PARTITION OF lt1 FOR VALUES FROM (0) TO (1000) SERVER s0;
RESULT:
	postgres: cannot create foreign partition of partitioned table "lt1"
DETAIL:  Table "lt1" contains indexes that are unique.


-----------
QUERY:
     -- ERROR
CREATE FOREIGN TABLE ft_part2 (a INT NOT NULL) SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE lt1 ATTACH PARTITION ft_part2
  FOR VALUES FROM (1000) TO (2000);
RESULT:
	postgres: cannot attach foreign table "ft_part2" as partition of partitioned table "lt1"
DETAIL:  Partitioned table "lt1" contains unique indexes.


-----------
QUERY:
                             -- ERROR
DROP TABLE lt1;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN TABLE ft_part2;
RESULT:
	postgres: None

-----------
QUERY:


CREATE TABLE lt1 (a INT) PARTITION BY RANGE (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE INDEX ON lt1 (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE TABLE lt1_part1
  PARTITION OF lt1 FOR VALUES FROM (0) TO (1000)
  PARTITION BY RANGE (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft_part_1_1
  PARTITION OF lt1_part1 FOR VALUES FROM (0) TO (100) SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft_part_1_2 (a INT) SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE lt1_part1 ATTACH PARTITION ft_part_1_2 FOR VALUES FROM (100) TO (200);
RESULT:
	postgres: None

-----------
QUERY:

CREATE UNIQUE INDEX ON lt1 (a);
RESULT:
	postgres: cannot create unique index on partitioned table "lt1"
DETAIL:  Table "lt1" contains partitions that are foreign tables.


-----------
QUERY:

ALTER TABLE lt1 ADD PRIMARY KEY (a);
RESULT:
	postgres: cannot create unique index on partitioned table "lt1_part1"
DETAIL:  Table "lt1_part1" contains partitions that are foreign tables.


-----------
QUERY:

DROP FOREIGN TABLE ft_part_1_1, ft_part_1_2;
RESULT:
	postgres: None

-----------
QUERY:

CREATE UNIQUE INDEX ON lt1 (a);
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE lt1 ADD PRIMARY KEY (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft_part_1_1
  PARTITION OF lt1_part1 FOR VALUES FROM (0) TO (100) SERVER s0;
RESULT:
	postgres: cannot create foreign partition of partitioned table "lt1_part1"
DETAIL:  Table "lt1_part1" contains indexes that are unique.


-----------
QUERY:

CREATE FOREIGN TABLE ft_part_1_2 (a INT NOT NULL) SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE lt1_part1 ATTACH PARTITION ft_part_1_2 FOR VALUES FROM (100) TO (200);
RESULT:
	postgres: cannot attach foreign table "ft_part_1_2" as partition of partitioned table "lt1_part1"
DETAIL:  Partitioned table "lt1_part1" contains unique indexes.


-----------
QUERY:

DROP TABLE lt1;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN TABLE ft_part_1_2;
RESULT:
	postgres: None

-----------
QUERY:


-- ALTER FOREIGN TABLE
COMMENT ON FOREIGN TABLE ft1 IS 'foreign table';
RESULT:
	postgres: None

-----------
QUERY:

COMMENT ON FOREIGN TABLE ft1 IS NULL;
RESULT:
	postgres: None

-----------
QUERY:

COMMENT ON COLUMN ft1.c1 IS 'foreign column';
RESULT:
	postgres: None

-----------
QUERY:

COMMENT ON COLUMN ft1.c1 IS NULL;
RESULT:
	postgres: None

-----------
QUERY:


ALTER FOREIGN TABLE ft1 ADD COLUMN c4 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ADD COLUMN c5 integer DEFAULT 0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ADD COLUMN c6 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ADD COLUMN c7 integer NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ADD COLUMN c8 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ADD COLUMN c9 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ADD COLUMN c10 integer OPTIONS (p1 'v1');
RESULT:
	postgres: None

-----------
QUERY:


ALTER FOREIGN TABLE ft1 ALTER COLUMN c4 SET DEFAULT 0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c5 DROP DEFAULT;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c6 SET NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c7 DROP NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c8 TYPE char(10) USING '0';
RESULT:
	postgres: "ft1" is not a table


-----------
QUERY:
 -- ERROR
ALTER FOREIGN TABLE ft1 ALTER COLUMN c8 TYPE char(10);
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c8 SET DATA TYPE text;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN xmin OPTIONS (ADD p1 'v1');
RESULT:
	postgres: cannot alter system column "xmin"


-----------
QUERY:
 -- ERROR
ALTER FOREIGN TABLE ft1 ALTER COLUMN c7 OPTIONS (ADD p1 'v1', ADD p2 'v2'),
                        ALTER COLUMN c8 OPTIONS (ADD p1 'v1', ADD p2 'v2');
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c8 OPTIONS (SET p2 'V2', DROP p1);
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c1 SET STATISTICS 10000;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c1 SET (n_distinct = 100);
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c8 SET STATISTICS -1;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c8 SET STORAGE PLAIN;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ ft1
-- can/* REPLACED */''t change the column type if it/* REPLACED */''s used elsewhere
CREATE TABLE use_ft1_column_type (x ft1);
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER COLUMN c8 SET DATA TYPE integer;
RESULT:
	postgres: cannot alter foreign table "ft1" because column "use_ft1_column_type.x" uses its row type


-----------
QUERY:
	-- ERROR
DROP TABLE use_ft1_column_type;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ADD PRIMARY KEY (c7);
RESULT:
	postgres: primary key constraints are not supported on foreign tables
LINE 2: ALTER FOREIGN TABLE ft1 ADD PRIMARY KEY (c7);
                                    ^


-----------
QUERY:
                   -- ERROR
ALTER FOREIGN TABLE ft1 ADD CONSTRAINT ft1_c9_check CHECK (c9 < 0) NOT VALID;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 ALTER CONSTRAINT ft1_c9_check DEFERRABLE;
RESULT:
	postgres: ALTER action ALTER CONSTRAINT cannot be performed on relation "ft1"
DETAIL:  This operation is not supported for foreign tables.


-----------
QUERY:
 -- ERROR
ALTER FOREIGN TABLE ft1 DROP CONSTRAINT ft1_c9_check;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 DROP CONSTRAINT no_const;
RESULT:
	postgres: constraint "no_const" of relation "ft1" does not exist


-----------
QUERY:
               -- ERROR
ALTER FOREIGN TABLE ft1 DROP CONSTRAINT IF EXISTS no_const;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 OWNER TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 OPTIONS (DROP delimiter, SET quote '~', ADD escape '@');
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 DROP COLUMN no_column;
RESULT:
	postgres: column "no_column" of relation "ft1" does not exist


-----------
QUERY:
                  -- ERROR
ALTER FOREIGN TABLE ft1 DROP COLUMN IF EXISTS no_column;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 DROP COLUMN c9;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 SET SCHEMA foreign_schema;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft1 SET TABLESPACE ts;
RESULT:
	postgres: relation "ft1" does not exist


-----------
QUERY:
                      -- ERROR
ALTER FOREIGN TABLE foreign_schema.ft1 RENAME c1 TO foreign_column_1;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE foreign_schema.ft1 RENAME TO foreign_table_1;
RESULT:
	postgres: None

-----------
QUERY:

-- \d foreign_schema.foreign_table_1

-- alter noexisting table
ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ADD COLUMN c4 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ADD COLUMN c6 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ADD COLUMN c7 integer NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ADD COLUMN c8 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ADD COLUMN c9 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ADD COLUMN c10 integer OPTIONS (p1 'v1');
RESULT:
	postgres: None

-----------
QUERY:


ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ALTER COLUMN c6 SET NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ALTER COLUMN c7 DROP NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ALTER COLUMN c8 TYPE char(10);
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ALTER COLUMN c8 SET DATA TYPE text;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ALTER COLUMN c7 OPTIONS (ADD p1 'v1', ADD p2 'v2'),
                        ALTER COLUMN c8 OPTIONS (ADD p1 'v1', ADD p2 'v2');
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 ALTER COLUMN c8 OPTIONS (SET p2 'V2', DROP p1);
RESULT:
	postgres: None

-----------
QUERY:


ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 DROP CONSTRAINT IF EXISTS no_const;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 DROP CONSTRAINT ft1_c1_check;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 OWNER TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 OPTIONS (DROP delimiter, SET quote '~', ADD escape '@');
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 DROP COLUMN IF EXISTS no_column;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 DROP COLUMN c9;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 SET SCHEMA foreign_schema;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 RENAME c1 TO foreign_column_1;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE IF EXISTS doesnt_exist_ft1 RENAME TO foreign_table_1;
RESULT:
	postgres: None

-----------
QUERY:


-- Information schema

SELECT * FROM information_schema.foreign_data_wrappers ORDER BY 1, 2;
RESULT:
	postgres: [('regression', 'dummy', 'regress_foreign_data_user', None, 'c'), ('regression', 'foo', 'regress_foreign_data_user', None, 'c'), ('regression', 'postgresql', 'regress_foreign_data_user', None, 'c')]

-----------
QUERY:

SELECT * FROM information_schema.foreign_data_wrapper_options ORDER BY 1, 2, 3;
RESULT:
	postgres: [('regression', 'foo', 'test wrapper', 'true')]

-----------
QUERY:

SELECT * FROM information_schema.foreign_servers ORDER BY 1, 2;
RESULT:
	postgres: [('regression', 's0', 'regression', 'dummy', None, None, 'regress_foreign_data_user'), ('regression', 's4', 'regression', 'foo', 'oracle', None, 'regress_foreign_data_user'), ('regression', 's5', 'regression', 'foo', None, '15.0', 'regress_test_role'), ('regression', 's6', 'regression', 'foo', None, '16.0', 'regress_test_indirect'), ('regression', 's8', 'regression', 'postgresql', None, None, 'regress_foreign_data_user'), ('regression', 't1', 'regression', 'foo', None, None, 'regress_test_indirect'), ('regression', 't2', 'regression', 'foo', None, None, 'regress_test_role')]

-----------
QUERY:

SELECT * FROM information_schema.foreign_server_options ORDER BY 1, 2, 3;
RESULT:
	postgres: [('regression', 's4', 'dbname', 'b'), ('regression', 's4', 'host', 'a'), ('regression', 's6', 'dbname', 'b'), ('regression', 's6', 'host', 'a'), ('regression', 's8', 'connect_timeout', '30'), ('regression', 's8', 'dbname', 'db1')]

-----------
QUERY:

SELECT * FROM information_schema.user_mappings ORDER BY lower(authorization_identifier), 2, 3;
RESULT:
	postgres: [('PUBLIC', 'regression', 's4'), ('PUBLIC', 'regression', 's8'), ('PUBLIC', 'regression', 't1'), ('regress_foreign_data_user', 'regression', 's4'), ('regress_foreign_data_user', 'regression', 's8'), ('regress_test_role', 'regression', 's5'), ('regress_test_role', 'regression', 's6'), ('regress_test_role', 'regression', 't1')]

-----------
QUERY:

SELECT * FROM information_schema.user_mapping_options ORDER BY lower(authorization_identifier), 2, 3, 4;
RESULT:
	postgres: [('PUBLIC', 'regression', 's4', 'this mapping', 'is public'), ('PUBLIC', 'regression', 't1', 'modified', '1'), ('regress_foreign_data_user', 'regression', 's8', 'password', 'public'), ('regress_test_role', 'regression', 's5', 'modified', '1'), ('regress_test_role', 'regression', 's6', 'username', 'test'), ('regress_test_role', 'regression', 't1', 'password', 'boo'), ('regress_test_role', 'regression', 't1', 'username', 'bob')]

-----------
QUERY:

SELECT * FROM information_schema.usage_privileges WHERE object_type LIKE 'FOREIGN%' AND object_name IN ('s6', 'foo') ORDER BY 1, 2, 3, 4, 5;
RESULT:
	postgres: [('regress_foreign_data_user', 'regress_foreign_data_user', 'regression', '', 'foo', 'FOREIGN DATA WRAPPER', 'USAGE', 'YES'), ('regress_foreign_data_user', 'regress_test_indirect', 'regression', '', 'foo', 'FOREIGN DATA WRAPPER', 'USAGE', 'NO'), ('regress_test_indirect', 'regress_test_indirect', 'regression', '', 's6', 'FOREIGN SERVER', 'USAGE', 'YES'), ('regress_test_indirect', 'regress_test_role2', 'regression', '', 's6', 'FOREIGN SERVER', 'USAGE', 'YES')]

-----------
QUERY:

SELECT * FROM information_schema.role_usage_grants WHERE object_type LIKE 'FOREIGN%' AND object_name IN ('s6', 'foo') ORDER BY 1, 2, 3, 4, 5;
RESULT:
	postgres: [('regress_foreign_data_user', 'regress_foreign_data_user', 'regression', '', 'foo', 'FOREIGN DATA WRAPPER', 'USAGE', 'YES'), ('regress_foreign_data_user', 'regress_test_indirect', 'regression', '', 'foo', 'FOREIGN DATA WRAPPER', 'USAGE', 'NO'), ('regress_test_indirect', 'regress_test_indirect', 'regression', '', 's6', 'FOREIGN SERVER', 'USAGE', 'YES'), ('regress_test_indirect', 'regress_test_role2', 'regression', '', 's6', 'FOREIGN SERVER', 'USAGE', 'YES')]

-----------
QUERY:

SELECT * FROM information_schema.foreign_tables ORDER BY 1, 2, 3;
RESULT:
	postgres: [('regression', 'foreign_schema', 'foreign_table_1', 'regression', 's0')]

-----------
QUERY:

SELECT * FROM information_schema.foreign_table_options ORDER BY 1, 2, 3, 4;
RESULT:
	postgres: [('regression', 'foreign_schema', 'foreign_table_1', 'be quoted', 'value'), ('regression', 'foreign_schema', 'foreign_table_1', 'escape', '@'), ('regression', 'foreign_schema', 'foreign_table_1', 'quote', '~')]

-----------
QUERY:

SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

SELECT * FROM information_schema.user_mapping_options ORDER BY 1, 2, 3, 4;
RESULT:
	postgres: [('PUBLIC', 'regression', 't1', 'modified', '1'), ('regress_test_role', 'regression', 's5', 'modified', '1'), ('regress_test_role', 'regression', 's6', 'username', 'test'), ('regress_test_role', 'regression', 't1', 'password', 'boo'), ('regress_test_role', 'regression', 't1', 'username', 'bob')]

-----------
QUERY:

SELECT * FROM information_schema.usage_privileges WHERE object_type LIKE 'FOREIGN%' AND object_name IN ('s6', 'foo') ORDER BY 1, 2, 3, 4, 5;
RESULT:
	postgres: [('regress_foreign_data_user', 'regress_test_indirect', 'regression', '', 'foo', 'FOREIGN DATA WRAPPER', 'USAGE', 'NO'), ('regress_test_indirect', 'regress_test_indirect', 'regression', '', 's6', 'FOREIGN SERVER', 'USAGE', 'YES'), ('regress_test_indirect', 'regress_test_role2', 'regression', '', 's6', 'FOREIGN SERVER', 'USAGE', 'YES')]

-----------
QUERY:

SELECT * FROM information_schema.role_usage_grants WHERE object_type LIKE 'FOREIGN%' AND object_name IN ('s6', 'foo') ORDER BY 1, 2, 3, 4, 5;
RESULT:
	postgres: [('regress_foreign_data_user', 'regress_test_indirect', 'regression', '', 'foo', 'FOREIGN DATA WRAPPER', 'USAGE', 'NO'), ('regress_test_indirect', 'regress_test_indirect', 'regression', '', 's6', 'FOREIGN SERVER', 'USAGE', 'YES'), ('regress_test_indirect', 'regress_test_role2', 'regression', '', 's6', 'FOREIGN SERVER', 'USAGE', 'YES')]

-----------
QUERY:

DROP USER MAPPING FOR current_user SERVER t1;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_test_role2;
RESULT:
	postgres: None

-----------
QUERY:

SELECT * FROM information_schema.user_mapping_options ORDER BY 1, 2, 3, 4;
RESULT:
	postgres: [('regress_test_role', 'regression', 's6', 'username', None)]

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:



-- has_foreign_data_wrapper_privilege
SELECT has_foreign_data_wrapper_privilege('regress_test_role',
    (SELECT oid FROM pg_foreign_data_wrapper WHERE fdwname='foo'), 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

SELECT has_foreign_data_wrapper_privilege('regress_test_role', 'foo', 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

SELECT has_foreign_data_wrapper_privilege(
    (SELECT oid FROM pg_roles WHERE rolname='regress_test_role'),
    (SELECT oid FROM pg_foreign_data_wrapper WHERE fdwname='foo'), 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

SELECT has_foreign_data_wrapper_privilege(
    (SELECT oid FROM pg_foreign_data_wrapper WHERE fdwname='foo'), 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

SELECT has_foreign_data_wrapper_privilege(
    (SELECT oid FROM pg_roles WHERE rolname='regress_test_role'), 'foo', 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

SELECT has_foreign_data_wrapper_privilege('foo', 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

GRANT USAGE ON FOREIGN DATA WRAPPER foo TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

SELECT has_foreign_data_wrapper_privilege('regress_test_role', 'foo', 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:


-- has_server_privilege
SELECT has_server_privilege('regress_test_role',
    (SELECT oid FROM pg_foreign_server WHERE srvname='s8'), 'USAGE');
RESULT:
	postgres: [(False,)]

-----------
QUERY:

SELECT has_server_privilege('regress_test_role', 's8', 'USAGE');
RESULT:
	postgres: [(False,)]

-----------
QUERY:

SELECT has_server_privilege(
    (SELECT oid FROM pg_roles WHERE rolname='regress_test_role'),
    (SELECT oid FROM pg_foreign_server WHERE srvname='s8'), 'USAGE');
RESULT:
	postgres: [(False,)]

-----------
QUERY:

SELECT has_server_privilege(
    (SELECT oid FROM pg_foreign_server WHERE srvname='s8'), 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

SELECT has_server_privilege(
    (SELECT oid FROM pg_roles WHERE rolname='regress_test_role'), 's8', 'USAGE');
RESULT:
	postgres: [(False,)]

-----------
QUERY:

SELECT has_server_privilege('s8', 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

GRANT USAGE ON FOREIGN SERVER s8 TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

SELECT has_server_privilege('regress_test_role', 's8', 'USAGE');
RESULT:
	postgres: [(True,)]

-----------
QUERY:

REVOKE USAGE ON FOREIGN SERVER s8 FROM regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:


GRANT USAGE ON FOREIGN SERVER s4 TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

DROP USER MAPPING FOR public SERVER s4;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s6 OPTIONS (DROP host, DROP dbname);
RESULT:
	postgres: None

-----------
QUERY:

ALTER USER MAPPING FOR regress_test_role SERVER s6 OPTIONS (DROP username);
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN DATA WRAPPER foo VALIDATOR postgresql_fdw_validator;
RESULT:
	postgres: None

-----------
QUERY:


-- Privileges
SET ROLE regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN DATA WRAPPER foobar;
RESULT:
	postgres: permission denied to create foreign-data wrapper "foobar"
HINT:  Must be superuser to create a foreign-data wrapper.


-----------
QUERY:
                             -- ERROR
ALTER FOREIGN DATA WRAPPER foo OPTIONS (gotcha 'true');
RESULT:
	postgres: permission denied to alter foreign-data wrapper "foo"
HINT:  Must be superuser to alter a foreign-data wrapper.


-----------
QUERY:
         -- ERROR
ALTER FOREIGN DATA WRAPPER foo OWNER TO regress_unprivileged_role;
RESULT:
	postgres: permission denied to change owner of foreign-data wrapper "foo"
HINT:  Must be superuser to change owner of a foreign-data wrapper.


-----------
QUERY:
 -- ERROR
DROP FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: must be owner of foreign-data wrapper foo


-----------
QUERY:
                                  -- ERROR
GRANT USAGE ON FOREIGN DATA WRAPPER foo TO regress_test_role;
RESULT:
	postgres: permission denied for foreign-data wrapper foo


-----------
QUERY:
   -- ERROR
CREATE SERVER s9 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: permission denied for foreign-data wrapper foo


-----------
QUERY:
                      -- ERROR
ALTER SERVER s4 VERSION '0.5';
RESULT:
	postgres: must be owner of foreign server s4


-----------
QUERY:
                                  -- ERROR
ALTER SERVER s4 OWNER TO regress_unprivileged_role;
RESULT:
	postgres: must be owner of foreign server s4


-----------
QUERY:
             -- ERROR
DROP SERVER s4;
RESULT:
	postgres: must be owner of foreign server s4


-----------
QUERY:
                                                 -- ERROR
GRANT USAGE ON FOREIGN SERVER s4 TO regress_test_role;
RESULT:
	postgres: permission denied for foreign server s4


-----------
QUERY:
          -- ERROR
CREATE USER MAPPING FOR public SERVER s4;
RESULT:
	postgres: must be owner of foreign server s4


-----------
QUERY:
                       -- ERROR
ALTER USER MAPPING FOR regress_test_role SERVER s6 OPTIONS (gotcha 'true');
RESULT:
	postgres: must be owner of foreign server s6


-----------
QUERY:
 -- ERROR
DROP USER MAPPING FOR regress_test_role SERVER s6;
RESULT:
	postgres: must be owner of foreign server s6


-----------
QUERY:
              -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:


GRANT USAGE ON FOREIGN DATA WRAPPER postgresql TO regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN DATA WRAPPER foo TO regress_unprivileged_role WITH GRANT OPTION;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN DATA WRAPPER foobar;
RESULT:
	postgres: permission denied to create foreign-data wrapper "foobar"
HINT:  Must be superuser to create a foreign-data wrapper.


-----------
QUERY:
                             -- ERROR
ALTER FOREIGN DATA WRAPPER foo OPTIONS (gotcha 'true');
RESULT:
	postgres: permission denied to alter foreign-data wrapper "foo"
HINT:  Must be superuser to alter a foreign-data wrapper.


-----------
QUERY:
         -- ERROR
DROP FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: must be owner of foreign-data wrapper foo


-----------
QUERY:
                                  -- ERROR
GRANT USAGE ON FOREIGN DATA WRAPPER postgresql TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:
 -- WARNING
GRANT USAGE ON FOREIGN DATA WRAPPER foo TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s9 FOREIGN DATA WRAPPER postgresql;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s6 VERSION '0.5';
RESULT:
	postgres: must be owner of foreign server s6


-----------
QUERY:
                                  -- ERROR
DROP SERVER s6;
RESULT:
	postgres: must be owner of foreign server s6


-----------
QUERY:
                                                 -- ERROR
GRANT USAGE ON FOREIGN SERVER s6 TO regress_test_role;
RESULT:
	postgres: permission denied for foreign server s6


-----------
QUERY:
          -- ERROR
GRANT USAGE ON FOREIGN SERVER s9 TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR public SERVER s6;
RESULT:
	postgres: must be owner of foreign server s6


-----------
QUERY:
                       -- ERROR
CREATE USER MAPPING FOR public SERVER s9;
RESULT:
	postgres: None

-----------
QUERY:

ALTER USER MAPPING FOR regress_test_role SERVER s6 OPTIONS (gotcha 'true');
RESULT:
	postgres: must be owner of foreign server s6


-----------
QUERY:
 -- ERROR
DROP USER MAPPING FOR regress_test_role SERVER s6;
RESULT:
	postgres: must be owner of foreign server s6


-----------
QUERY:
              -- ERROR
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:


REVOKE USAGE ON FOREIGN DATA WRAPPER foo FROM regress_unprivileged_role;
RESULT:
	postgres: dependent privileges exist
HINT:  Use CASCADE to revoke them too.


-----------
QUERY:
 -- ERROR
REVOKE USAGE ON FOREIGN DATA WRAPPER foo FROM regress_unprivileged_role CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN DATA WRAPPER foo TO regress_test_role;
RESULT:
	postgres: permission denied for foreign-data wrapper foo


-----------
QUERY:
   -- ERROR
CREATE SERVER s10 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: permission denied for foreign-data wrapper foo


-----------
QUERY:
                     -- ERROR
ALTER SERVER s9 VERSION '1.1';
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN SERVER s9 TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR current_user SERVER s9;
RESULT:
	postgres: None

-----------
QUERY:

DROP SERVER s9 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s9 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

GRANT USAGE ON FOREIGN SERVER s9 TO regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

SET ROLE regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

ALTER SERVER s9 VERSION '1.2';
RESULT:
	postgres: must be owner of foreign server s9


-----------
QUERY:
                                  -- ERROR
GRANT USAGE ON FOREIGN SERVER s9 TO regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:
          -- WARNING
CREATE USER MAPPING FOR current_user SERVER s9;
RESULT:
	postgres: None

-----------
QUERY:

DROP SERVER s9 CASCADE;
RESULT:
	postgres: must be owner of foreign server s9


-----------
QUERY:
                                         -- ERROR

-- Check visibility of user mapping data
SET ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

CREATE SERVER s10 FOREIGN DATA WRAPPER foo;
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR public SERVER s10 OPTIONS (user 'secret');
RESULT:
	postgres: None

-----------
QUERY:

CREATE USER MAPPING FOR regress_unprivileged_role SERVER s10 OPTIONS (user 'secret');
RESULT:
	postgres: None

-----------
QUERY:

-- owner of server can see some option fields
-- \deu+
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

-- superuser can see all option fields
-- \deu+
-- unprivileged user cannot see any option field
SET ROLE regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

-- \deu+
RESET ROLE;
RESULT:
	postgres: None

-----------
QUERY:

DROP SERVER s10 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:


-- Triggers
CREATE FUNCTION dummy_trigger() RETURNS TRIGGER AS $$
  BEGIN
    RETURN NULL;
  END
$$ language plpgsql;
RESULT:
	postgres: None

-----------
QUERY:


CREATE TRIGGER trigtest_before_stmt BEFORE INSERT OR UPDATE OR DELETE
ON foreign_schema.foreign_table_1
FOR EACH STATEMENT
EXECUTE PROCEDURE dummy_trigger();
RESULT:
	postgres: None

-----------
QUERY:


CREATE TRIGGER trigtest_after_stmt AFTER INSERT OR UPDATE OR DELETE
ON foreign_schema.foreign_table_1
FOR EACH STATEMENT
EXECUTE PROCEDURE dummy_trigger();
RESULT:
	postgres: None

-----------
QUERY:


CREATE TRIGGER trigtest_after_stmt_tt AFTER INSERT OR UPDATE OR DELETE -- ERROR
ON foreign_schema.foreign_table_1
REFERENCING NEW TABLE AS new_table
FOR EACH STATEMENT
EXECUTE PROCEDURE dummy_trigger();
RESULT:
	postgres: "foreign_table_1" is a foreign table
DETAIL:  Triggers on foreign tables cannot have transition tables.


-----------
QUERY:


CREATE TRIGGER trigtest_before_row BEFORE INSERT OR UPDATE OR DELETE
ON foreign_schema.foreign_table_1
FOR EACH ROW
EXECUTE PROCEDURE dummy_trigger();
RESULT:
	postgres: None

-----------
QUERY:


CREATE TRIGGER trigtest_after_row AFTER INSERT OR UPDATE OR DELETE
ON foreign_schema.foreign_table_1
FOR EACH ROW
EXECUTE PROCEDURE dummy_trigger();
RESULT:
	postgres: None

-----------
QUERY:


CREATE CONSTRAINT TRIGGER trigtest_constraint AFTER INSERT OR UPDATE OR DELETE
ON foreign_schema.foreign_table_1
FOR EACH ROW
EXECUTE PROCEDURE dummy_trigger();
RESULT:
	postgres: "foreign_table_1" is a foreign table
DETAIL:  Foreign tables cannot have constraint triggers.


-----------
QUERY:


ALTER FOREIGN TABLE foreign_schema.foreign_table_1
	DISABLE TRIGGER trigtest_before_stmt;
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE foreign_schema.foreign_table_1
	ENABLE TRIGGER trigtest_before_stmt;
RESULT:
	postgres: None

-----------
QUERY:


DROP TRIGGER trigtest_before_stmt ON foreign_schema.foreign_table_1;
RESULT:
	postgres: None

-----------
QUERY:

DROP TRIGGER trigtest_before_row ON foreign_schema.foreign_table_1;
RESULT:
	postgres: None

-----------
QUERY:

DROP TRIGGER trigtest_after_stmt ON foreign_schema.foreign_table_1;
RESULT:
	postgres: None

-----------
QUERY:

DROP TRIGGER trigtest_after_row ON foreign_schema.foreign_table_1;
RESULT:
	postgres: None

-----------
QUERY:


DROP FUNCTION dummy_trigger();
RESULT:
	postgres: None

-----------
QUERY:


-- Table inheritance
CREATE TABLE fd_pt1 (
	c1 integer NOT NULL,
	c2 text,
	c3 date
);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft2 () INHERITS (fd_pt1)
  SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
-- \d+ ft2
DROP FOREIGN TABLE ft2;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
CREATE FOREIGN TABLE ft2 (
	c1 integer NOT NULL,
	c2 text,
	c3 date
) SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ ft2
ALTER FOREIGN TABLE ft2 INHERIT fd_pt1;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
-- \d+ ft2
CREATE TABLE ct3() INHERITS(ft2);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft3 (
	c1 integer NOT NULL,
	c2 text,
	c3 date
) INHERITS(ft2)
  SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ ft2
-- \d+ ct3
-- \d+ ft3

-- add attributes recursively
ALTER TABLE fd_pt1 ADD COLUMN c4 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ADD COLUMN c5 integer DEFAULT 0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ADD COLUMN c6 integer;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ADD COLUMN c7 integer NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ADD COLUMN c8 integer;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
-- \d+ ft2
-- \d+ ct3
-- \d+ ft3

-- alter attributes recursively
ALTER TABLE fd_pt1 ALTER COLUMN c4 SET DEFAULT 0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c5 DROP DEFAULT;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c6 SET NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c7 DROP NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c8 TYPE char(10) USING '0';
RESULT:
	postgres: "ft2" is not a table


-----------
QUERY:
        -- ERROR
ALTER TABLE fd_pt1 ALTER COLUMN c8 TYPE char(10);
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c8 SET DATA TYPE text;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c1 SET STATISTICS 10000;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c1 SET (n_distinct = 100);
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c8 SET STATISTICS -1;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ALTER COLUMN c8 SET STORAGE EXTERNAL;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
-- \d+ ft2

-- drop attributes recursively
ALTER TABLE fd_pt1 DROP COLUMN c4;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 DROP COLUMN c5;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 DROP COLUMN c6;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 DROP COLUMN c7;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 DROP COLUMN c8;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
-- \d+ ft2

-- add constraints recursively
ALTER TABLE fd_pt1 ADD CONSTRAINT fd_pt1chk1 CHECK (c1 > 0) NO INHERIT;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ADD CONSTRAINT fd_pt1chk2 CHECK (c2 <> '');
RESULT:
	postgres: None

-----------
QUERY:

-- connoinherit should be true for NO INHERIT constraint
SELECT relname, conname, contype, conislocal, coninhcount, connoinherit
  FROM pg_class AS pc JOIN pg_constraint AS pgc ON (conrelid = pc.oid)
  WHERE pc.relname = 'fd_pt1'
  ORDER BY 1,2;
RESULT:
	postgres: [('fd_pt1', 'fd_pt1_c1_not_null', 'n', True, 0, False), ('fd_pt1', 'fd_pt1chk1', 'c', True, 0, True), ('fd_pt1', 'fd_pt1chk2', 'c', True, 0, False)]

-----------
QUERY:

-- child does not inherit NO INHERIT constraints
-- \d+ fd_pt1
-- \d+ ft2
DROP FOREIGN TABLE ft2;
RESULT:
	postgres: cannot drop foreign table ft2 because other objects depend on it
DETAIL:  table ct3 depends on foreign table ft2
foreign table ft3 depends on foreign table ft2
HINT:  Use DROP ... CASCADE to drop the dependent objects too.


-----------
QUERY:
 -- ERROR
DROP FOREIGN TABLE ft2 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE ft2 (
	c1 integer NOT NULL,
	c2 text,
	c3 date
) SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: None

-----------
QUERY:

-- child must have parent/* REPLACED */''s INHERIT constraints
ALTER FOREIGN TABLE ft2 INHERIT fd_pt1;
RESULT:
	postgres: child table is missing constraint "fd_pt1chk2"


-----------
QUERY:
                            -- ERROR
ALTER FOREIGN TABLE ft2 ADD CONSTRAINT fd_pt1chk2 CHECK (c2 <> '');
RESULT:
	postgres: None

-----------
QUERY:

ALTER FOREIGN TABLE ft2 INHERIT fd_pt1;
RESULT:
	postgres: None

-----------
QUERY:

-- child does not inherit NO INHERIT constraints
-- \d+ fd_pt1
-- \d+ ft2

-- drop constraints recursively
ALTER TABLE fd_pt1 DROP CONSTRAINT fd_pt1chk1 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 DROP CONSTRAINT fd_pt1chk2 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:


-- NOT VALID case
INSERT INTO fd_pt1 VALUES (1, 'fd_pt1'::text, '1994-01-01'::date);
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 ADD CONSTRAINT fd_pt1chk3 CHECK (c2 <> '') NOT VALID;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
-- \d+ ft2
-- VALIDATE CONSTRAINT need do nothing on foreign tables
ALTER TABLE fd_pt1 VALIDATE CONSTRAINT fd_pt1chk3;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
-- \d+ ft2

-- changes name of an attribute recursively
ALTER TABLE fd_pt1 RENAME COLUMN c1 TO f1;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 RENAME COLUMN c2 TO f2;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt1 RENAME COLUMN c3 TO f3;
RESULT:
	postgres: None

-----------
QUERY:

-- changes name of a constraint recursively
ALTER TABLE fd_pt1 RENAME CONSTRAINT fd_pt1chk3 TO f2_check;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt1
-- \d+ ft2

DROP TABLE fd_pt1 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:


-- IMPORT FOREIGN SCHEMA
IMPORT FOREIGN SCHEMA s1 FROM SERVER s9 INTO public;
RESULT:
	postgres: foreign-data wrapper "foo" has no handler


-----------
QUERY:
 -- ERROR
IMPORT FOREIGN SCHEMA s1 LIMIT TO (t1) FROM SERVER s9 INTO public;
RESULT:
	postgres: foreign-data wrapper "foo" has no handler


-----------
QUERY:
 --ERROR
IMPORT FOREIGN SCHEMA s1 EXCEPT (t1) FROM SERVER s9 INTO public;
RESULT:
	postgres: foreign-data wrapper "foo" has no handler


-----------
QUERY:
 -- ERROR
IMPORT FOREIGN SCHEMA s1 EXCEPT (t1, t2) FROM SERVER s9 INTO public
OPTIONS (option1 'value1', option2 'value2');
RESULT:
	postgres: foreign-data wrapper "foo" has no handler


-----------
QUERY:
 -- ERROR

-- DROP FOREIGN TABLE
DROP FOREIGN TABLE no_table;
RESULT:
	postgres: foreign table "no_table" does not exist


-----------
QUERY:
                                    -- ERROR
DROP FOREIGN TABLE IF EXISTS no_table;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN TABLE foreign_schema.foreign_table_1;
RESULT:
	postgres: None

-----------
QUERY:


-- REASSIGN OWNED/DROP OWNED of foreign objects
REASSIGN OWNED BY regress_test_role TO regress_test_role2;
RESULT:
	postgres: None

-----------
QUERY:

DROP OWNED BY regress_test_role2;
RESULT:
	postgres: cannot drop desired object(s) because other objects depend on them
DETAIL:  user mapping for regress_test_role on server s5 depends on server s5
HINT:  Use DROP ... CASCADE to drop the dependent objects too.


-----------
QUERY:

DROP OWNED BY regress_test_role2 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:


-- Foreign partition DDL stuff
CREATE TABLE fd_pt2 (
	c1 integer NOT NULL,
	c2 text,
	c3 date
) PARTITION BY LIST (c1);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE fd_pt2_1 PARTITION OF fd_pt2 FOR VALUES IN (1)
  SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt2
-- \d+ fd_pt2_1

-- partition cannot have additional columns
DROP FOREIGN TABLE fd_pt2_1;
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE fd_pt2_1 (
	c1 integer NOT NULL,
	c2 text,
	c3 date,
	c4 char
) SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt2_1
ALTER TABLE fd_pt2 ATTACH PARTITION fd_pt2_1 FOR VALUES IN (1);
RESULT:
	postgres: table "fd_pt2_1" contains column "c4" not found in parent "fd_pt2"
DETAIL:  The new partition may contain only the columns present in parent.


-----------
QUERY:
       -- ERROR

DROP FOREIGN TABLE fd_pt2_1;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt2
CREATE FOREIGN TABLE fd_pt2_1 (
	c1 integer NOT NULL,
	c2 text,
	c3 date
) SERVER s0 OPTIONS (delimiter ',', quote '"', "be quoted" 'value');
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt2_1
-- no attach partition validation occurs for foreign tables
ALTER TABLE fd_pt2 ATTACH PARTITION fd_pt2_1 FOR VALUES IN (1);
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt2
-- \d+ fd_pt2_1

-- cannot add column to a partition
ALTER TABLE fd_pt2_1 ADD c4 char;
RESULT:
	postgres: cannot add column to a partition


-----------
QUERY:


-- ok to have a partition/* REPLACED */''s own constraints though
ALTER TABLE fd_pt2_1 ALTER c3 SET NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt2_1 ADD CONSTRAINT p21chk CHECK (c2 <> '');
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt2
-- \d+ fd_pt2_1

-- cannot drop inherited NOT NULL constraint from a partition
ALTER TABLE fd_pt2_1 ALTER c1 DROP NOT NULL;
RESULT:
	postgres: column "c1" is marked NOT NULL in parent table


-----------
QUERY:


-- partition must have parent/* REPLACED */''s constraints
ALTER TABLE fd_pt2 DETACH PARTITION fd_pt2_1;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt2 ALTER c2 SET NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt2
-- \d+ fd_pt2_1
ALTER TABLE fd_pt2 ATTACH PARTITION fd_pt2_1 FOR VALUES IN (1);
RESULT:
	postgres: column "c2" in child table must be marked NOT NULL


-----------
QUERY:
       -- ERROR
ALTER FOREIGN TABLE fd_pt2_1 ALTER c2 SET NOT NULL;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt2 ATTACH PARTITION fd_pt2_1 FOR VALUES IN (1);
RESULT:
	postgres: None

-----------
QUERY:


ALTER TABLE fd_pt2 DETACH PARTITION fd_pt2_1;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt2 ADD CONSTRAINT fd_pt2chk1 CHECK (c1 > 0);
RESULT:
	postgres: None

-----------
QUERY:

-- \d+ fd_pt2
-- \d+ fd_pt2_1
ALTER TABLE fd_pt2 ATTACH PARTITION fd_pt2_1 FOR VALUES IN (1);
RESULT:
	postgres: child table is missing constraint "fd_pt2chk1"


-----------
QUERY:
       -- ERROR
ALTER FOREIGN TABLE fd_pt2_1 ADD CONSTRAINT fd_pt2chk1 CHECK (c1 > 0);
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE fd_pt2 ATTACH PARTITION fd_pt2_1 FOR VALUES IN (1);
RESULT:
	postgres: None

-----------
QUERY:


DROP FOREIGN TABLE fd_pt2_1;
RESULT:
	postgres: None

-----------
QUERY:

DROP TABLE fd_pt2;
RESULT:
	postgres: None

-----------
QUERY:


-- foreign table cannot be part of partition tree made of temporary
-- relations.
CREATE TEMP TABLE temp_parted (a int) PARTITION BY LIST (a);
RESULT:
	postgres: None

-----------
QUERY:

CREATE FOREIGN TABLE foreign_part PARTITION OF temp_parted DEFAULT
  SERVER s0;
RESULT:
	postgres: cannot create a permanent relation as partition of temporary relation "temp_parted"


-----------
QUERY:
  -- ERROR
CREATE FOREIGN TABLE foreign_part (a int) SERVER s0;
RESULT:
	postgres: None

-----------
QUERY:

ALTER TABLE temp_parted ATTACH PARTITION foreign_part DEFAULT;
RESULT:
	postgres: cannot attach a permanent relation as partition of temporary relation "temp_parted"


-----------
QUERY:
  -- ERROR
DROP FOREIGN TABLE foreign_part;
RESULT:
	postgres: None

-----------
QUERY:

DROP TABLE temp_parted;
RESULT:
	postgres: None

-----------
QUERY:


-- Cleanup
DROP SCHEMA foreign_schema CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

DROP ROLE regress_test_role;
RESULT:
	postgres: role "regress_test_role" cannot be dropped because some objects depend on it
DETAIL:  privileges for foreign-data wrapper foo
privileges for server s4
owner of user mapping for regress_test_role on server s6


-----------
QUERY:
                                -- ERROR
DROP SERVER t1 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

DROP USER MAPPING FOR regress_test_role SERVER s6;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN DATA WRAPPER foo CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

DROP SERVER s8 CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

DROP ROLE regress_test_indirect;
RESULT:
	postgres: None

-----------
QUERY:

DROP ROLE regress_test_role;
RESULT:
	postgres: None

-----------
QUERY:

DROP ROLE regress_unprivileged_role;
RESULT:
	postgres: role "regress_unprivileged_role" cannot be dropped because some objects depend on it
DETAIL:  privileges for foreign-data wrapper postgresql


-----------
QUERY:
                        -- ERROR
REVOKE ALL ON FOREIGN DATA WRAPPER postgresql FROM regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

DROP ROLE regress_unprivileged_role;
RESULT:
	postgres: None

-----------
QUERY:

DROP ROLE regress_test_role2;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN DATA WRAPPER postgresql CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

DROP FOREIGN DATA WRAPPER dummy CASCADE;
RESULT:
	postgres: None

-----------
QUERY:

\c
DROP ROLE regress_foreign_data_user;
RESULT:
	postgres: syntax error at or near "\"
LINE 2: \c
        ^


-----------
QUERY:


-- At this point we should have no wrappers, no servers, and no mappings.
SELECT fdwname, fdwhandler, fdwvalidator, fdwoptions FROM pg_foreign_data_wrapper;
RESULT:
	postgres: []

-----------
QUERY:

SELECT srvname, srvoptions FROM pg_foreign_server;
RESULT:
	postgres: []

-----------
QUERY:

SELECT * FROM pg_user_mapping;
RESULT:
	postgres: []
